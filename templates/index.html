<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­ÙØ¸ØªÙŠ - Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent-primary: #16a34a;
            --accent-secondary: #22c55e;
            --accent-gradient: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --success: #16a34a;
            --success-light: rgba(22, 163, 74, 0.1);
            --danger: #dc2626;
            --danger-light: rgba(220, 38, 38, 0.1);
            --warning: #eab308;
            --warning-light: rgba(234, 179, 8, 0.1);
            --info: #0ea5e9;
            --info-light: rgba(14, 165, 233, 0.1);
            --border: #e2e8f0;
            --border-light: #cbd5e1;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: #e2e8f0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Clean Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            pointer-events: none;
            z-index: 0;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-left: 1px solid var(--border);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
        }

        .logo span {
            font-size: 0.7rem;
            background: #eab308;
            color: #1e293b;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .nav-menu {
            flex: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 16px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: #1e293b;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-item.active::before {
            opacity: 0;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-badge {
            margin-right: auto;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 32px 40px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header-title h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: #1e293b;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: #334155;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            display: none;
        }

        .stat-card.profit { border-right: 4px solid var(--success); }
        .stat-card.value { border-right: 4px solid #1e293b; }
        .stat-card.count { border-right: 4px solid var(--info); }
        .stat-card.best { border-right: 4px solid var(--warning); }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--border-light);
            box-shadow: var(--shadow);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 1.3rem;
        }

        .stat-card.profit .stat-icon { background: var(--success-light); color: var(--success); }
        .stat-card.value .stat-icon { background: #f1f5f9; color: #1e293b; }
        .stat-card.count .stat-icon { background: var(--info-light); color: var(--info); }
        .stat-card.best .stat-icon { background: var(--warning-light); color: var(--warning); }

        .stat-card h4 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .stat-card .value small {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-card .change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-header .tabs {
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #1e293b;
            color: white;
        }

        /* Chart */
        .chart-container {
            height: 280px;
            position: relative;
        }

        /* Analysis Panel */
        .analysis-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .analysis-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .analysis-item:hover {
            border-color: var(--border-light);
            background: var(--bg-card-hover);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .analysis-stock {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stock-avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .analysis-badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .analysis-badge.buy { background: var(--success-light); color: var(--success); }
        .analysis-badge.sell { background: var(--danger-light); color: var(--danger); }
        .analysis-badge.hold { background: var(--warning-light); color: var(--warning); }

        .analysis-levels {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
        }

        .level-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .level-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .level-dot.support { background: var(--success); }
        .level-dot.resistance { background: var(--danger); }

        /* News Panel */
        .news-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .news-item {
            display: flex;
            gap: 14px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .news-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(-4px);
        }

        .news-thumb {
            width: 80px;
            height: 60px;
            border-radius: 10px;
            background: var(--bg-card);
            flex-shrink: 0;
            overflow: hidden;
        }

        .news-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .news-content h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Dividends Panel */
        .dividend-summary {
            background: var(--accent-gradient);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .dividend-summary h4 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .dividend-summary .amount {
            font-size: 2rem;
            font-weight: 700;
        }

        .dividend-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dividend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .dividend-stock {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dividend-amount {
            text-align: left;
        }

        .dividend-amount .total {
            font-weight: 700;
            color: var(--success);
        }

        .dividend-amount .count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Table */
        .table-container {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            background: #1e293b;
            color: white;
            padding: 20px 28px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header .stock-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: right;
            padding: 16px 28px;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.85rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 20px 28px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td {
            background: var(--bg-card-hover);
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .stock-logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .stock-name {
            font-weight: 600;
        }

        .stock-code {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s;
            color: var(--text-secondary);
            margin-left: 6px;
        }

        .action-btn:hover {
            background: #1e293b;
            border-color: transparent;
            color: white;
        }

        .action-btn.danger:hover {
            background: var(--danger);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 16px 18px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e293b;
            box-shadow: 0 0 0 4px rgba(30, 41, 59, 0.1);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .stock-search-results {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-top: 10px;
            display: none;
            background: var(--bg-card);
            position: absolute;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .form-group:has(.stock-search-results) {
            position: relative;
        }

        .stock-search-item {
            padding: 14px 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
        }

        .stock-search-item:hover {
            background: var(--bg-card-hover);
        }

        .stock-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .stock-hint.success {
            color: var(--success);
        }

        .stock-info-box {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 18px;
            margin-top: 14px;
            display: none;
        }

        .stock-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .stock-info-row:last-child {
            border-bottom: none;
        }

        /* Order Type Selector */
        .order-type-selector {
            display: flex;
            gap: 14px;
            margin-bottom: 24px;
        }

        .order-type-btn {
            flex: 1;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: var(--bg-card);
        }

        .order-type-btn.active {
            border-color: var(--success);
            background: var(--success-light);
        }

        .order-type-btn.sell.active {
            border-color: var(--danger);
            background: var(--danger-light);
        }

        .orders-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 12px;
        }

        .order-item.buy {
            border-right: 4px solid var(--success);
        }

        .order-item.sell {
            border-right: 4px solid var(--danger);
        }

        .order-type-label {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .order-type-label.buy { color: var(--success); }
        .order-type-label.sell { color: var(--danger); }

        .modal-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 24px;
        }

        .modal-tab {
            padding: 14px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: var(--text-secondary);
            transition: all 0.3s;
            font-weight: 500;
        }

        .modal-tab.active {
            border-bottom-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-right: 0;
                padding: 20px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Gradient Text */
        .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Two Column Layout for Side Panels */
        .side-panels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .side-panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ“Š</div>
                <div>
                    <h1>Ù…Ø­ÙØ¸ØªÙŠ</h1>
                </div>
                <span>PRO</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                    <div class="nav-item active" onclick="showPage('portfolio')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                            <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                            <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                        </svg>
                        <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                    </div>
                    <div class="nav-item" onclick="showPage('analysis')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20V10"></path>
                            <path d="M18 20V4"></path>
                            <path d="M6 20v-4"></path>
                        </svg>
                        <span>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ</span>
                        <span class="nav-badge" id="analysisBadge">0</span>
                    </div>
                    <div class="nav-item" onclick="showPage('news')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1"></path>
                            <path d="M21 12h-8"></path>
                            <path d="M21 16h-8"></path>
                            <path d="M21 20h-8"></path>
                        </svg>
                        <span>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚</span>
                    </div>
                    <div class="nav-item" onclick="showPage('marketNews')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                        </svg>
                        <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
                        <span class="nav-badge" id="newsBadge" style="background:var(--primary)">Ø¬Ø¯ÙŠØ¯</span>
                    </div>
                    <div class="nav-item" onclick="showPage('dividends')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                            <path d="M12 18V6"></path>
                        </svg>
                        <span>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©</div>
                    <div class="nav-item" onclick="showPage('speculative')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                        </svg>
                        <span>Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨Ø© âš¡</span>
                    </div>
                    <div class="nav-item" onclick="showPage('dashboard')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17V9"></path>
                            <path d="M13 17V5"></path>
                            <path d="M8 17v-3"></path>
                        </svg>
                        <span>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ğŸ“Š</span>
                    </div>
                    <div class="nav-item" onclick="showPage('longTerm')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <span>Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© ğŸ¦</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡</div>
                    <div class="nav-item" onclick="showPage('performance')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        <span>Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
                    </div>
                    <div class="nav-item" onclick="showPage('walletPerformance')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                            <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                        </svg>
                        <span>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
                    <div class="nav-item" onclick="showPage('operations')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <path d="M14 2v6h6"></path>
                            <path d="M16 13H8"></path>
                            <path d="M16 17H8"></path>
                            <path d="M10 9H8"></path>
                        </svg>
                        <span>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                    </div>
                    <div class="nav-item" onclick="showPage('wallets')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                            <path d="M16 12a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"></path>
                        </svg>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</span>
                    </div>
                    <div class="nav-item" onclick="showPage('settings')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                    </div>
                    <div class="nav-item" onclick="window.location.href='/logout'" style="margin-top:20px;color:#ef4444">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Portfolio Page -->
            <div class="page-section active" id="portfolioPage">
                <!-- Header -->
                <header class="header">
                    <div class="header-title">
                        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
                        <p>Ø¥Ù„ÙŠÙƒ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-outline" onclick="openImportExportModal()" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø±">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±
                        </button>
                        <button class="btn btn-secondary" onclick="refreshPrices()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            ØªØ­Ø¯ÙŠØ«
                        </button>
                        <button class="btn btn-primary" onclick="openAddModal()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù…
                        </button>
                    </div>
                </header>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card profit">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</h4>
                        <div class="value" id="totalProfit">+0.00 <small>Ø±.Ø³</small></div>
                        <div class="change positive" id="totalProfitPercent">
                            <span>+0.00%</span>
                        </div>
                    </div>
                    <div class="stat-card value">
                        <div class="stat-icon">ğŸ’°</div>
                        <h4>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                        <div class="value"><span id="totalValue">0.00</span> <small>Ø±.Ø³</small></div>
                        <div class="change" style="color:var(--text-secondary)">
                            Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="totalCost">0.00</span> Ø±.Ø³
                        </div>
                    </div>
                    <div class="stat-card count">
                        <div class="stat-icon">ğŸ“‹</div>
                        <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…</h4>
                        <div class="value" id="stockCount">0</div>
                        <div class="change" style="color:var(--text-secondary)">
                            ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©
                        </div>
                    </div>
                    <div class="stat-card best">
                        <div class="stat-icon">ğŸ†</div>
                        <h4>Ø£ÙØ¶Ù„ Ø³Ù‡Ù…</h4>
                        <div class="value" id="bestStockName" style="font-size:1.2rem">-</div>
                        <div class="change" id="bestStockReturn">
                            <span>-</span>
                        </div>
                    </div>
                </div>

                <!-- Chart & Sectors -->
                <div class="content-grid">
                    <!-- Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                            <div style="display:flex;align-items:center;gap:12px">
                                <select id="chartWalletFilter" onchange="filterChartByWallet()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text);font-size:0.85rem;min-width:150px">
                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>
                                </select>
                                <div class="tabs">
                                    <button class="tab-btn">Ø´Ù‡Ø±</button>
                                    <button class="tab-btn">3 Ø£Ø´Ù‡Ø±</button>
                                    <button class="tab-btn active">Ø³Ù†Ø©</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>

                    <!-- Quick Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ØªÙˆØµÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                            <button class="btn btn-secondary" style="padding:8px 14px;font-size:0.8rem" onclick="loadAnalysis()">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                        <div class="analysis-panel" id="quickAnalysis">
                            <div class="empty-state" style="padding:40px">
                                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Table -->
                <div class="table-container">
                    <div class="table-header">
                        <span>Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                        <span class="stock-count" id="tableStockCount">0 Ø£Ø³Ù‡Ù…</span>
                    </div>
                    <div id="groupedStocksContainer">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª - Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø© -->
                    </div>
                    <div class="empty-state" id="emptyState" style="display:none">
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                        <p>Ø£Ø¶Ù Ø£Ø³Ù‡Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§ØªÙƒ</p>
                    </div>
                </div>

                <!-- Closed Positions Section -->
                <div class="card" id="closedPositionsCard" style="margin-top:24px;display:none">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleClosedPositions()">
                        <h3 style="margin:0;display:flex;align-items:center;gap:8px">
                            <span style="background:var(--text-muted);color:white;padding:4px 10px;border-radius:6px;font-size:0.8rem">Ù…Ù‚ÙÙ„Ø©</span>
                            Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…Ù‚ÙÙ„Ø© (Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
                        </h3>
                        <div style="display:flex;align-items:center;gap:12px">
                            <span id="closedPositionsCount" style="color:var(--text-muted);font-size:0.9rem"></span>
                            <button id="toggleClosedBtn" class="btn" style="padding:6px 12px;font-size:0.85rem;background:var(--bg-secondary);border:1px solid var(--border);display:flex;align-items:center;gap:6px">
                                <svg id="toggleClosedIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.3s">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                                <span id="toggleClosedText">Ø¥Ø®ÙØ§Ø¡</span>
                            </button>
                        </div>
                    </div>
                    <div id="closedPositionsContent" class="table-wrapper" style="margin-top:16px">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø³Ù‡Ù…</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                    <th>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</th>
                                    <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©</th>
                                    <th>Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="closedPositionsBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <p style="text-align:center;color:var(--text-muted);margin-top:24px;font-size:0.85rem" id="updateTime"></p>
            </div>

            <!-- Analysis Page -->
            <div class="page-section" id="analysisPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ ğŸ“Š</h2>
                        <p>ØªÙˆØµÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadFullAnalysis()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„
                    </button>
                </header>

                <div id="fullAnalysis">
                    <div class="empty-state">
                        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</h3>
                    </div>
                </div>
            </div>

            <!-- News Page -->
            <div class="page-section" id="newsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ğŸŒ</h2>
                        <p>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¤Ø«Ø±Ø© ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadGlobalPrices()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                    </button>
                </header>

                <!-- Global Prices Grid -->
                <div id="globalPricesContainer">
                    <div class="empty-state" style="padding:60px">
                        <div style="font-size:3rem;margin-bottom:16px">ğŸŒ</div>
                        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©...</h3>
                    </div>
                </div>
            </div>

            <!-- Market News Page -->
            <div class="page-section" id="marketNewsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ ğŸ“°</h2>
                        <p>Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ù† Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© ÙˆÙ…Ø§Ù„</p>
                    </div>
                    <div style="display:flex;gap:12px;align-items:center">
                        <select id="newsSourceFilter" onchange="filterNewsBySource()" style="padding:10px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text);font-size:0.9rem">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
                            <option value="Ø£Ø±Ù‚Ø§Ù…">Ø£Ø±Ù‚Ø§Ù…</option>
                            <option value="Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©">Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</option>
                            <option value="Ù…Ø§Ù„">Ù…Ø§Ù„</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshMarketNews()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                            </svg>
                            ØªØ­Ø¯ÙŠØ«
                        </button>
                    </div>
                </header>

                <!-- News Search -->
                <div style="margin-bottom:24px">
                    <div style="display:flex;gap:12px">
                        <input type="text" id="newsSearchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±..."
                               style="flex:1;padding:12px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text);font-size:0.95rem"
                               onkeypress="if(event.key==='Enter')searchMarketNews()">
                        <button class="btn btn-secondary" onclick="searchMarketNews()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Ø¨Ø­Ø«
                        </button>
                    </div>
                </div>

                <!-- News Stats -->
                <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8)">ğŸ“Š</div>
                        <div class="stat-info">
                            <span class="stat-label">Ø£Ø±Ù‚Ø§Ù…</span>
                            <span class="stat-value" id="argaamCount">-</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#059669)">ğŸ“°</div>
                        <div class="stat-info">
                            <span class="stat-label">Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©</span>
                            <span class="stat-value" id="aleqtCount">-</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ğŸ’°</div>
                        <div class="stat-info">
                            <span class="stat-label">Ù…Ø§Ù„</span>
                            <span class="stat-value" id="maaalCount">-</span>
                        </div>
                    </div>
                </div>

                <!-- News Container -->
                <div id="marketNewsContainer">
                    <div class="empty-state" style="padding:60px">
                        <div style="font-size:3rem;margin-bottom:16px">ğŸ“°</div>
                        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</h3>
                    </div>
                </div>
            </div>

            <!-- Dividends Page -->
            <div class="page-section" id="dividendsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª ğŸ’µ</h2>
                        <p>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„ØªÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø´Ø±Ø§Ø¦Ùƒ</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadDividends()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ«
                    </button>
                </header>

                <div id="dividendsContainer">
                    <div class="empty-state">
                        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª...</h3>
                    </div>
                </div>
            </div>

            <!-- Speculative Trading Page - Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ© -->
            <div class="page-section" id="speculativePage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ© âš¡</h2>
                        <p>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØªØªØ¨Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadSpeculativeData()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </header>

                <!-- Speculative Tools Grid -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr)">
                    <div class="stat-card" style="border-right:4px solid var(--danger)">
                        <div class="stat-icon">ğŸ¯</div>
                        <h4>ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div class="stat-value" id="todayTrades">0</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ’°</div>
                        <h4>Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</h4>
                        <div class="stat-value" id="todayProfit">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--warning)">
                        <div class="stat-icon">ğŸ“Š</div>
                        <h4>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</h4>
                        <div class="stat-value" id="successRate">0%</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">â±ï¸</div>
                        <h4>Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„ØµÙÙ‚Ø©</h4>
                        <div class="stat-value" id="avgTradeTime">0 <small>Ø¯Ù‚ÙŠÙ‚Ø©</small></div>
                    </div>
                </div>

                <!-- Quick Trade Tools -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px">
                    <!-- Signal Scanner -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ” Ù…Ø§Ø³Ø­ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª</h3>
                            <button class="btn btn-secondary" style="padding:8px 16px;font-size:0.85rem" onclick="scanSignals()">Ù…Ø³Ø­ Ø§Ù„Ø³ÙˆÙ‚</button>
                        </div>
                        <div id="signalScanner" style="margin-top:16px">
                            <div class="empty-state" style="padding:40px">
                                <p>Ø§Ø¶ØºØ· "Ù…Ø³Ø­ Ø§Ù„Ø³ÙˆÙ‚" Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨Ø©</p>
                            </div>
                        </div>
                    </div>

                    <!-- Momentum Stocks -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸš€ Ø£Ø³Ù‡Ù… Ø§Ù„Ø²Ø®Ù…</h3>
                            <button class="btn btn-secondary" style="padding:8px 16px;font-size:0.85rem" onclick="scanMomentum()">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                        <div id="momentumStocks" style="margin-top:16px">
                            <div class="empty-state" style="padding:40px">
                                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø³Ù‡Ù… Ø§Ù„Ø²Ø®Ù…...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Alerts & Breakout Detection -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px">
                    <!-- Price Alerts -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
                            <button class="btn btn-secondary" style="padding:8px 16px;font-size:0.85rem" onclick="openAlertModal()">+ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡</button>
                        </div>
                        <div id="priceAlerts" style="margin-top:16px">
                            <div class="empty-state" style="padding:30px">
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù†Ø´Ø·Ø©</p>
                            </div>
                        </div>
                    </div>

                    <!-- Breakout Detection -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“ˆ ÙƒØ³Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø§Øª</h3>
                            <button class="btn btn-secondary" style="padding:8px 16px;font-size:0.85rem" onclick="detectBreakouts()">ÙØ­Øµ</button>
                        </div>
                        <div id="breakoutStocks" style="margin-top:16px">
                            <div class="empty-state" style="padding:30px">
                                <p>Ø§Ø¶ØºØ· "ÙØ­Øµ" Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ³Ø± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø§Øª</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Intraday Chart & Volume Analysis -->
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-top:24px">
                    <!-- Quick Calculator -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨</h3>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:16px">
                            <div class="form-group">
                                <label style="font-size:0.85rem">Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
                                <input type="number" id="calcEntryPrice" step="0.01" placeholder="0.00" style="padding:12px" oninput="calculateTrade()">
                            </div>
                            <div class="form-group">
                                <label style="font-size:0.85rem">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <input type="number" id="calcQuantity" step="1" placeholder="100" style="padding:12px" oninput="calculateTrade()">
                            </div>
                            <div class="form-group">
                                <label style="font-size:0.85rem">Ø³Ø¹Ø± Ø§Ù„Ù‡Ø¯Ù</label>
                                <input type="number" id="calcTargetPrice" step="0.01" placeholder="0.00" style="padding:12px" oninput="calculateTrade()">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;margin-top:16px">
                            <div style="background:var(--bg-secondary);padding:16px;border-radius:12px;text-align:center">
                                <div style="font-size:0.8rem;color:var(--text-muted)">Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©</div>
                                <div style="font-size:1.1rem;font-weight:700;color:var(--text-primary)" id="calcTotal">0.00 Ø±.Ø³</div>
                            </div>
                            <div style="background:var(--success-light);padding:16px;border-radius:12px;text-align:center">
                                <div style="font-size:0.8rem;color:var(--success)">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                                <div style="font-size:1.1rem;font-weight:700;color:var(--success)" id="calcProfit">0.00 Ø±.Ø³</div>
                            </div>
                            <div style="background:var(--info-light);padding:16px;border-radius:12px;text-align:center">
                                <div style="font-size:0.8rem;color:var(--info)">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­</div>
                                <div style="font-size:1.1rem;font-weight:700;color:var(--info)" id="calcPercent">0.00%</div>
                            </div>
                            <div style="background:var(--danger-light);padding:16px;border-radius:12px;text-align:center">
                                <div style="font-size:0.8rem;color:var(--danger)">ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© (3%)</div>
                                <div style="font-size:1.1rem;font-weight:700;color:var(--danger)" id="calcStopLoss">0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Leaders -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“Š Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªØ¯Ø§ÙˆÙ„Ø§Ù‹</h3>
                        </div>
                        <div id="volumeLeaders" style="margin-top:16px">
                            <div class="empty-state" style="padding:30px">
                                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header">
                        <h3>âš ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:16px;margin-top:16px">
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:2rem;margin-bottom:8px">ğŸ’¼</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠ</div>
                            <div style="font-size:1.2rem;font-weight:700" id="specCapital">0 Ø±.Ø³</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:2rem;margin-bottom:8px">ğŸ“‰</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
                            <div style="font-size:1.2rem;font-weight:700;color:var(--danger)" id="maxDailyLoss">2%</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:2rem;margin-bottom:8px">ğŸ¯</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø­Ø¬Ù… Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ù…ÙˆØµÙ‰</div>
                            <div style="font-size:1.2rem;font-weight:700;color:var(--info)" id="recTradeSize">5%</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:2rem;margin-bottom:8px">ğŸ”„</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div>
                            <div style="font-size:1.2rem;font-weight:700" id="openTrades">0</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:2rem;margin-bottom:8px">âš¡</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©/Ø§Ù„Ø¹Ø§Ø¦Ø¯</div>
                            <div style="font-size:1.2rem;font-weight:700;color:var(--success)" id="riskReward">1:2</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Long Term Investment Page - Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© -->
            <div class="page-section" id="longTermPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© ğŸ¦</h2>
                        <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ÙˆØ²Ø¹Ø© Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadLongTermData()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </header>

                <!-- Long Term Stats Grid -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr)">
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ’°</div>
                        <h4>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</h4>
                        <div class="stat-value" id="longTermValue">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</h4>
                        <div class="stat-value" id="longTermProfit">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid #8b5cf6">
                        <div class="stat-icon">ğŸ’µ</div>
                        <h4>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</h4>
                        <div class="stat-value" id="longTermDividends">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--warning)">
                        <div class="stat-icon">ğŸ“Š</div>
                        <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…</h4>
                        <div class="stat-value" id="longTermStocksCount">0 <small>Ø³Ù‡Ù…</small></div>
                    </div>
                </div>

                <!-- Investment Strategy Overview -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header">
                        <h3 style="display:flex;align-items:center;gap:8px">
                            <span>ğŸ¯</span> Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø·ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¯Ù‰
                        </h3>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;margin-top:16px">
                        <div style="background:linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(34,197,94,0.05) 100%);padding:20px;border-radius:12px;border:1px solid rgba(34,197,94,0.2)">
                            <div style="font-size:1.5rem;margin-bottom:8px">ğŸ¢</div>
                            <h4 style="color:var(--success);margin-bottom:8px">Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠØ©</h4>
                            <p style="font-size:0.85rem;color:var(--text-muted)">Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ¨Ø±Ù‰ Ø°Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ‚Ø± ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ù†ØªØ¸Ù…Ø©</p>
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.05) 100%);padding:20px;border-radius:12px;border:1px solid rgba(59,130,246,0.2)">
                            <div style="font-size:1.5rem;margin-bottom:8px">ğŸ’¹</div>
                            <h4 style="color:var(--info);margin-bottom:8px">Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø³ØªØ¯Ø§Ù…</h4>
                            <p style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø°Ø§Øª Ù…Ø¹Ø¯Ù„Ø§Øª Ù†Ù…Ùˆ Ù…Ø±ØªÙØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø·ÙˆÙŠÙ„</p>
                        </div>
                        <div style="background:linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(139,92,246,0.05) 100%);padding:20px;border-radius:12px;border:1px solid rgba(139,92,246,0.2)">
                            <div style="font-size:1.5rem;margin-bottom:8px">ğŸ</div>
                            <h4 style="color:#8b5cf6;margin-bottom:8px">ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h4>
                            <p style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø£Ø³Ù‡Ù… Ø°Ø§Øª ØªÙˆØ²ÙŠØ¹Ø§Øª Ø£Ø±Ø¨Ø§Ø­ Ù…Ù†ØªØ¸Ù…Ø© ÙˆÙ…ØªØ²Ø§ÙŠØ¯Ø©</p>
                        </div>
                    </div>
                </div>

                <!-- Long Term Stocks List -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header">
                        <h3 style="display:flex;align-items:center;gap:8px">
                            <span>ğŸ“‹</span> Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©
                        </h3>
                    </div>
                    <div id="longTermStocksList" style="margin-top:16px">
                        <div class="empty-state" style="padding:40px">
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                        </div>
                    </div>
                </div>

                <!-- Wallets Summary -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header">
                        <h3 style="display:flex;align-items:center;gap:8px">
                            <span>ğŸ’¼</span> Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰
                        </h3>
                    </div>
                    <div id="longTermWalletsList" style="margin-top:16px">
                        <div class="empty-state" style="padding:40px">
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Page -->
            <div class="page-section" id="performancePage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ“Š</h2>
                        <p>ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø­ÙØ¸ØªÙƒ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadPerformanceData()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯Ø§Ø¡
                    </button>
                </header>

                <!-- Wallet Selection for Performance -->
                <div class="card" style="margin-bottom:24px;padding:20px;background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="font-size:1rem;color:var(--text-primary);display:flex;align-items:center;gap:8px">
                            <span>ğŸ¯</span> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ù„Ù„Ù‚ÙŠØ§Ø³
                        </h3>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-secondary" style="padding:6px 14px;font-size:0.8rem" onclick="selectAllWalletsForPerformance()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                            <button class="btn btn-secondary" style="padding:6px 14px;font-size:0.8rem" onclick="deselectAllWalletsForPerformance()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
                        </div>
                    </div>
                    <div id="walletSelectionForPerformance" style="display:flex;flex-wrap:wrap;gap:10px">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                    </div>
                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                        <div style="display:flex;align-items:center;gap:16px">
                            <span style="font-size:0.85rem;color:var(--text-secondary)">Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</span>
                            <span id="selectedWalletsCount" style="font-weight:700;color:var(--primary)">0</span>
                            <span style="font-size:0.85rem;color:var(--text-secondary)">|</span>
                            <span style="font-size:0.85rem;color:var(--text-secondary)">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</span>
                            <span id="selectedWalletsValue" style="font-weight:700;color:var(--success)">0.00 Ø±.Ø³</span>
                        </div>
                    </div>
                </div>

                <!-- Performance Summary -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr)">
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ’¹</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ø¦Ø¯</h4>
                        <div class="stat-value" id="totalReturn">0.00%</div>
                        <div class="change positive" id="totalReturnAmount">+0.00 Ø±.Ø³</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">ğŸ“…</div>
                        <h4>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</h4>
                        <div class="stat-value" id="annualReturn">0.00%</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--warning)">
                        <div class="stat-icon">ğŸ“‰</div>
                        <h4>Ø£Ù‚ØµÙ‰ ØªØ±Ø§Ø¬Ø¹</h4>
                        <div class="stat-value" id="maxDrawdown" style="color:var(--danger)">0.00%</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid #8b5cf6">
                        <div class="stat-icon">âš–ï¸</div>
                        <h4>Ù†Ø³Ø¨Ø© Ø´Ø§Ø±Ø¨</h4>
                        <div class="stat-value" id="sharpeRatio">0.00</div>
                    </div>
                </div>

                <!-- Performance Charts -->
                <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-top:24px">
                    <!-- Main Performance Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“ˆ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</h3>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-secondary perf-period-btn" data-period="1m" style="padding:6px 12px;font-size:0.8rem" onclick="setPerformancePeriod('1m')">Ø´Ù‡Ø±</button>
                                <button class="btn btn-secondary perf-period-btn" data-period="3m" style="padding:6px 12px;font-size:0.8rem" onclick="setPerformancePeriod('3m')">3 Ø£Ø´Ù‡Ø±</button>
                                <button class="btn btn-secondary perf-period-btn active" data-period="1y" style="padding:6px 12px;font-size:0.8rem" onclick="setPerformancePeriod('1y')">Ø³Ù†Ø©</button>
                                <button class="btn btn-secondary perf-period-btn" data-period="all" style="padding:6px 12px;font-size:0.8rem" onclick="setPerformancePeriod('all')">Ø§Ù„ÙƒÙ„</button>
                            </div>
                        </div>
                        <!-- Legend for multiple wallets -->
                        <div id="performanceChartLegend" style="display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;padding:10px;background:var(--bg-secondary);border-radius:8px">
                        </div>
                        <div style="height:300px;margin-top:16px">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Sector Allocation -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</h3>
                        </div>
                        <div style="height:300px;margin-top:16px">
                            <canvas id="sectorChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Monthly Returns & Stock Performance -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px">
                    <!-- Monthly Returns -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“Š Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                        </div>
                        <div id="monthlyReturns" style="margin-top:16px">
                            <table style="width:100%;border-collapse:collapse">
                                <thead>
                                    <tr style="background:var(--bg-secondary)">
                                        <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted)">Ø§Ù„Ø´Ù‡Ø±</th>
                                        <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted)">Ø§Ù„Ø¹Ø§Ø¦Ø¯</th>
                                        <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted)">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyReturnsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Best/Worst Performers -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù…</h3>
                        </div>
                        <div id="stockPerformance" style="margin-top:16px">
                            <div style="margin-bottom:16px">
                                <div style="font-weight:600;color:var(--success);margin-bottom:8px">âœ… Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡Ù‹</div>
                                <div id="bestPerformers"></div>
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--danger);margin-bottom:8px">âŒ Ø§Ù„Ø£Ø³ÙˆØ£ Ø£Ø¯Ø§Ø¡Ù‹</div>
                                <div id="worstPerformers"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Metrics & Comparison -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px">
                    <!-- Risk Metrics -->
                    <div class="card">
                        <div class="card-header">
                            <h3>âš ï¸ Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                        </div>
                        <div style="margin-top:16px">
                            <div style="display:grid;gap:12px">
                                <div style="display:flex;justify-content:space-between;padding:16px;background:var(--bg-secondary);border-radius:12px">
                                    <span>Ø§Ù„ØªÙ‚Ù„Ø¨ (Volatility)</span>
                                    <strong id="volatility">0.00%</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:16px;background:var(--bg-secondary);border-radius:12px">
                                    <span>Ù…Ø¹Ø§Ù…Ù„ Ø¨ÙŠØªØ§ (Beta)</span>
                                    <strong id="beta">1.00</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:16px;background:var(--bg-secondary);border-radius:12px">
                                    <span>Ù…Ø¹Ø§Ù…Ù„ Ø£Ù„ÙØ§ (Alpha)</span>
                                    <strong id="alpha" style="color:var(--success)">0.00%</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:16px;background:var(--bg-secondary);border-radius:12px">
                                    <span>Ù†Ø³Ø¨Ø© Ø³ÙˆØ±ØªÙŠÙ†Ùˆ (Sortino)</span>
                                    <strong id="sortino">0.00</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;padding:16px;background:var(--bg-secondary);border-radius:12px">
                                    <span>Value at Risk (VaR 95%)</span>
                                    <strong id="var95" style="color:var(--danger)">0.00%</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Benchmark Comparison -->
                    <div class="card">
                        <div class="card-header">
                            <h3>ğŸ“ Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± (ØªØ§Ø³ÙŠ)</h3>
                        </div>
                        <div style="margin-top:16px">
                            <div style="display:grid;gap:12px">
                                <div style="padding:20px;background:var(--bg-secondary);border-radius:12px">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                                        <span>Ø£Ø¯Ø§Ø¡ Ù…Ø­ÙØ¸ØªÙƒ</span>
                                        <strong id="yourPerformance" class="positive">+0.00%</strong>
                                    </div>
                                    <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden">
                                        <div id="yourPerfBar" style="height:100%;background:var(--success);width:50%;transition:width 0.5s"></div>
                                    </div>
                                </div>
                                <div style="padding:20px;background:var(--bg-secondary);border-radius:12px">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                                        <span>Ø£Ø¯Ø§Ø¡ Ù…Ø¤Ø´Ø± ØªØ§Ø³ÙŠ</span>
                                        <strong id="tasiPerformance">+0.00%</strong>
                                    </div>
                                    <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden">
                                        <div id="tasiPerfBar" style="height:100%;background:var(--info);width:50%;transition:width 0.5s"></div>
                                    </div>
                                </div>
                                <div style="padding:20px;background:linear-gradient(135deg, var(--success-light), var(--info-light));border-radius:12px;text-align:center">
                                    <div style="font-size:0.9rem;color:var(--text-muted);margin-bottom:4px">ØªÙÙˆÙ‚Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±</div>
                                    <div style="font-size:1.8rem;font-weight:700" id="outperformance">+0.00%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investment Summary -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header">
                        <h3>ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</h3>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(6, 1fr);gap:16px;margin-top:16px">
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</div>
                            <div style="font-size:1.3rem;font-weight:700" id="investmentDuration">0 ÙŠÙˆÙ…</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª</div>
                            <div style="font-size:1.3rem;font-weight:700" id="totalTrades">0</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø­Ø©</div>
                            <div style="font-size:1.3rem;font-weight:700;color:var(--success)" id="winningTrades">0</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø³Ø±Ø©</div>
                            <div style="font-size:1.3rem;font-weight:700;color:var(--danger)" id="losingTrades">0</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­</div>
                            <div style="font-size:1.3rem;font-weight:700;color:var(--success)" id="avgWin">0%</div>
                        </div>
                        <div style="text-align:center;padding:20px;background:var(--bg-secondary);border-radius:12px">
                            <div style="font-size:0.85rem;color:var(--text-muted)">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
                            <div style="font-size:1.3rem;font-weight:700;color:var(--danger)" id="avgLoss">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallets Management Page -->
            <div class="page-section" id="walletsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸ ğŸ’¼</h2>
                        <p>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ø§ÙØ¸Ùƒ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ù„Ø¯Ù‰ Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ Ø§Ù„Ù…Ø®ØªÙ„ÙÙŠÙ†</p>
                    </div>
                    <button class="btn btn-primary" onclick="openWalletModal()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø©
                    </button>
                </header>

                <!-- Wallets Summary -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr)">
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ’°</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</h4>
                        <div class="value" id="totalWalletsValue">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">ğŸ“Š</div>
                        <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸</h4>
                        <div class="value" id="walletsCount">0</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid #8b5cf6">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ù‡Ù…</h4>
                        <div class="value" id="totalWalletsStocks">0</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--warning)">
                        <div class="stat-icon">ğŸ’µ</div>
                        <h4>Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</h4>
                        <div class="value" id="totalBuyingPower">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                </div>

                <!-- Wallets with Stocks -->
                <div id="walletsWithStocks" style="margin-top:24px">
                    <div class="empty-state" style="padding:40px">
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ø£Ø³Ù‡Ù…...</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page - Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ -->
            <div class="page-section" id="dashboardPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ğŸ“Š</h2>
                        <p>ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø© Ù…Ø¹ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙˆØ­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„</p>
                    </div>
                    <div style="display:flex;gap:12px">
                        <button class="btn btn-secondary" onclick="openTransactionModal()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"></path>
                            </svg>
                            Ø¥ÙŠØ¯Ø§Ø¹ / Ø³Ø­Ø¨
                        </button>
                    </div>
                </header>

                <!-- Strategy Distribution Overview -->
                <div style="background:linear-gradient(135deg, #1e293b 0%, #334155 100%);border-radius:16px;padding:24px;margin-bottom:24px;color:white">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h3 style="font-size:1.1rem;display:flex;align-items:center;gap:8px">
                            <span style="font-size:1.3rem">ğŸ¯</span> Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹
                        </h3>
                        <div style="display:flex;gap:20px;font-size:0.85rem">
                            <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:#22c55e;border-radius:3px"></span> Ø§Ø³ØªØ«Ù…Ø§Ø± Ø£Ø³Ø§Ø³ÙŠ 50%</span>
                            <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:#3b82f6;border-radius:3px"></span> Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰ 30%</span>
                            <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:#f59e0b;border-radius:3px"></span> Ù…Ø¶Ø§Ø±Ø¨Ø© 20%</span>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
                        <div style="background:rgba(255,255,255,0.1);padding:16px;border-radius:12px;text-align:center">
                            <div style="font-size:0.8rem;opacity:0.8;margin-bottom:4px">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                            <div style="font-size:1.5rem;font-weight:700" id="dashboardPortfolioValue">0.00</div>
                            <div style="font-size:0.75rem;opacity:0.7">Ø±.Ø³</div>
                        </div>
                        <div style="background:rgba(34,197,94,0.2);padding:16px;border-radius:12px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
                            <div style="font-size:0.8rem;opacity:0.8;margin-bottom:4px">Ø§Ø³ØªØ«Ù…Ø§Ø± Ø£Ø³Ø§Ø³ÙŠ (50%)</div>
                            <div style="font-size:1.3rem;font-weight:700" id="strategyCore">0.00</div>
                            <div style="font-size:0.75rem;opacity:0.7">Ø«Ø§Ø¨Øª - Ù„Ø§ ÙŠØªØ­Ø±Ùƒ</div>
                        </div>
                        <div style="background:rgba(59,130,246,0.2);padding:16px;border-radius:12px;text-align:center;border:1px solid rgba(59,130,246,0.3)">
                            <div style="font-size:0.8rem;opacity:0.8;margin-bottom:4px">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰ (30%)</div>
                            <div style="font-size:1.3rem;font-weight:700" id="strategyMid">0.00</div>
                            <div style="font-size:0.75rem;opacity:0.7">ØªØ¯Ø§ÙˆÙ„ Ø¯ÙˆØ±ÙŠ</div>
                        </div>
                        <div style="background:rgba(245,158,11,0.2);padding:16px;border-radius:12px;text-align:center;border:1px solid rgba(245,158,11,0.3)">
                            <div style="font-size:0.8rem;opacity:0.8;margin-bottom:4px">Ù…Ø¶Ø§Ø±Ø¨Ø© (20%)</div>
                            <div style="font-size:1.3rem;font-weight:700" id="strategySpec">0.00</div>
                            <div style="font-size:0.75rem;opacity:0.7">ØªØ¯Ø§ÙˆÙ„ Ù†Ø´Ø·</div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards Row -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);margin-bottom:24px">
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ“¥</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</h4>
                        <div class="value" id="totalDeposits">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--danger)">
                        <div class="stat-icon">ğŸ“¤</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h4>
                        <div class="value" id="totalWithdrawals">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">ğŸ’µ</div>
                        <h4>ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</h4>
                        <div class="value" id="netDeposits">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid #8b5cf6">
                        <div class="stat-icon">ğŸ“Š</div>
                        <h4>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…</h4>
                        <div class="value" id="totalStocksCount">0 <small>Ø³Ù‡Ù…</small></div>
                    </div>
                </div>

                <!-- Owned Stocks with Calculator -->
                <div id="ownedStocksAnalysis">
                    <div class="empty-state" style="padding:40px">
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                    </div>
                </div>

                <!-- Transactions History (Collapsible) -->
                <div class="card" style="margin-top:24px">
                    <div class="card-header" style="cursor:pointer" onclick="toggleTransactionsHistory()">
                        <h3 style="display:flex;align-items:center;gap:8px">
                            <span id="transactionsToggleIcon">â–¶</span>
                            Ø³Ø¬Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
                        </h3>
                    </div>
                    <div id="transactionsHistory" style="margin-top:16px;display:none">
                        <div class="empty-state" style="padding:40px">
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ùˆ Ø³Ø­Ø¨</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations Management Page -->
            <div class="page-section" id="operationsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ğŸ“‹</h2>
                        <p>Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadAllOperations()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ«
                    </button>
                </header>

                <!-- Operations Summary -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);margin-bottom:24px">
                    <div class="stat-card" style="border-right:4px solid var(--success)">
                        <div class="stat-icon">ğŸ“¥</div>
                        <h4>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h4>
                        <div class="value" id="totalBuyOrders">0</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--danger)">
                        <div class="stat-icon">ğŸ“¤</div>
                        <h4>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h4>
                        <div class="value" id="totalSellOrders">0</div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid var(--info)">
                        <div class="stat-icon">ğŸ’°</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</h4>
                        <div class="value" id="totalOrdersCommission">0.00 <small>Ø±.Ø³</small></div>
                    </div>
                    <div class="stat-card" style="border-right:4px solid #8b5cf6">
                        <div class="stat-icon">ğŸ“Š</div>
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h4>
                        <div class="value" id="totalOrdersCount">0</div>
                    </div>
                </div>

                <!-- Filter -->
                <div class="card" style="margin-bottom:24px;padding:16px">
                    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
                        <div style="display:flex;align-items:center;gap:8px">
                            <label style="font-size:0.9rem;color:var(--text-secondary)">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨:</label>
                            <select id="operationsFilterType" onchange="filterOperations()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary)">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                <option value="buy">Ø§Ù„Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·</option>
                                <option value="sell">Ø§Ù„Ø¨ÙŠØ¹ ÙÙ‚Ø·</option>
                            </select>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <label style="font-size:0.9rem;color:var(--text-secondary)">Ø§Ù„Ù…Ø­ÙØ¸Ø©:</label>
                            <select id="operationsFilterWallet" onchange="filterOperations()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary)">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>
                            </select>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <label style="font-size:0.9rem;color:var(--text-secondary)">Ø§Ù„Ø³Ù‡Ù…:</label>
                            <select id="operationsFilterStock" onchange="filterOperations()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary)">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù‡Ù…</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Operations Table -->
                <div class="card">
                    <div id="operationsTableContainer">
                        <div class="empty-state" style="padding:60px">
                            <div style="font-size:3rem;margin-bottom:16px">ğŸ“‹</div>
                            <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Performance Analysis Page -->
            <div class="page-section" id="walletPerformancePage">
                <header class="header">
                    <div class="header-title">
                        <h2>ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ğŸ“Š</h2>
                        <p>ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ù…Ø­ÙØ¸Ø© Ù…Ø¹ Ø§Ù„ØµÙÙ‚Ø§Øª ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadWalletPerformance()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                        </svg>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ù„ÙŠÙ„
                    </button>
                </header>

                <!-- Overall Summary -->
                <div id="overallSummary" style="margin-bottom:24px">
                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr)">
                        <div class="stat-card" style="border-right:4px solid var(--success)">
                            <div class="stat-icon">ğŸ’°</div>
                            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±</h4>
                            <div class="value" id="totalInvested">0 Ø±.Ø³</div>
                        </div>
                        <div class="stat-card" style="border-right:4px solid var(--primary)">
                            <div class="stat-icon">ğŸ“ˆ</div>
                            <h4>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚</h4>
                            <div class="value" id="totalRealized">0 Ø±.Ø³</div>
                        </div>
                        <div class="stat-card" style="border-right:4px solid var(--info)">
                            <div class="stat-icon">ğŸ’µ</div>
                            <h4>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h4>
                            <div class="value" id="totalDividendsPerf">0 Ø±.Ø³</div>
                        </div>
                        <div class="stat-card" style="border-right:4px solid var(--warning)">
                            <div class="stat-icon">ğŸ“Š</div>
                            <h4>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</h4>
                            <div class="value" id="netProfitLoss">0 Ø±.Ø³</div>
                        </div>
                    </div>
                </div>

                <!-- Wallet Selector -->
                <div class="card" style="margin-bottom:24px">
                    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                        <label style="font-weight:600">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø©:</label>
                        <select id="walletPerformanceSelector" onchange="filterWalletPerformance()" style="padding:10px 16px;border-radius:8px;border:1px solid var(--border);min-width:200px">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>
                        </select>
                        <div style="margin-right:auto;display:flex;gap:12px">
                            <span class="badge" style="background:var(--success-light);color:var(--success);padding:8px 16px;border-radius:20px">
                                ØµÙÙ‚Ø§Øª Ø±Ø§Ø¨Ø­Ø©: <strong id="winningCount">0</strong>
                            </span>
                            <span class="badge" style="background:var(--danger-light);color:var(--danger);padding:8px 16px;border-radius:20px">
                                ØµÙÙ‚Ø§Øª Ø®Ø§Ø³Ø±Ø©: <strong id="losingCount">0</strong>
                            </span>
                            <span class="badge" style="background:var(--primary-light);color:var(--primary);padding:8px 16px;border-radius:20px">
                                Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: <strong id="winRatePerf">0%</strong>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Wallet Performance Content -->
                <div id="walletPerformanceContent">
                    <div class="empty-state" style="padding:60px">
                        <div style="font-size:3rem;margin-bottom:16px">ğŸ“Š</div>
                        <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡...</h3>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page-section" id="settingsPage">
                <header class="header">
                    <div class="header-title">
                        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</h2>
                        <p>Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨</p>
                    </div>
                </header>

                <div class="card" style="max-width:600px">
                    <div class="card-header">
                        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©</h3>
                    </div>
                    <form id="settingsForm" onsubmit="saveSettings(event)" style="margin-top:20px">
                        <div class="form-group">
                            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%)</label>
                            <input type="number" id="settingCommissionRate" step="0.001" min="0" placeholder="0.155" required>
                            <div class="stock-hint">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ØªÙŠ ÙŠØ®ØµÙ…Ù‡Ø§ Ø§Ù„ÙˆØ³ÙŠØ· (Ù…Ø«Ø§Ù„: 0.155%)</div>
                        </div>
                        <div class="form-group">
                            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%)</label>
                            <input type="number" id="settingTaxRate" step="0.1" min="0" placeholder="15" required>
                            <div class="stock-hint">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: 15%)</div>
                        </div>
                        <div style="background:var(--bg-secondary);padding:16px;border-radius:12px;margin:20px 0">
                            <h4 style="margin-bottom:12px;font-size:0.95rem">Ù…Ø«Ø§Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</h4>
                            <div style="font-size:0.9rem;color:var(--text-secondary)">
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                    <span>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©:</span>
                                    <span>10,000 Ø±.Ø³</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                    <span>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (<span id="exampleCommRate">0.155</span>%):</span>
                                    <span id="exampleCommValue">15.50 Ø±.Ø³</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                    <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (<span id="exampleTaxRate">15</span>% Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©):</span>
                                    <span id="exampleTaxValue">2.33 Ø±.Ø³</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:600;border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
                                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…:</span>
                                    <span id="exampleTotalFees">17.83 Ø±.Ø³</span>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:16px">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù… Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close-btn" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addStockForm" onsubmit="addStock(event)">
                <div class="form-group">
                    <label>Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…</label>
                    <input type="text" id="symbol" placeholder="Ù…Ø«Ø§Ù„: 2222 Ø£Ùˆ Ø£Ø±Ø§Ù…ÙƒÙˆ" autocomplete="off" required>
                    <div class="stock-hint" id="stockHint">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</div>
                    <div class="stock-search-results" id="searchResults"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
                    <input type="text" id="stockName" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" required>
                    <div class="stock-info-box" id="stockInfo">
                        <div class="stock-info-row">
                            <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                            <strong id="currentPriceInfo">-</strong>
                        </div>
                        <div class="stock-info-row">
                            <span>Ø§Ù„Ù‚Ø·Ø§Ø¹:</span>
                            <span id="sectorInfo">-</span>
                        </div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                    <div class="form-group">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… <span style="color:var(--danger)">*</span></label>
                        <input type="number" id="shares" step="1" min="1" placeholder="100" required>
                    </div>
                    <div class="form-group">
                        <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø±.Ø³) <span style="color:var(--danger)">*</span></label>
                        <input type="number" id="buyPrice" step="0.01" min="0.01" placeholder="30.00" required oninput="calculateFees('add')">
                    </div>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡ <span style="color:var(--danger)">*</span></label>
                    <input type="date" id="buyDate" required>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø±.Ø³) <span style="color:var(--text-muted);font-size:0.8rem">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                        <input type="number" id="commission" step="0.01" min="0" placeholder="ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø±.Ø³) <span style="color:var(--text-muted);font-size:0.8rem">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                        <input type="number" id="tax" step="0.01" min="0" placeholder="ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                    </div>
                </div>
                <div class="fees-preview" id="feesPreview" style="background:var(--bg-secondary);padding:12px 16px;border-radius:10px;margin-bottom:16px;display:none">
                    <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                        <span>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©:</span>
                        <span id="totalValuePreview">0.00 Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                        <span>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</span>
                        <span id="commissionPreview">0.00 Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                        <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</span>
                        <span id="taxPreview">0.00 Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.95rem;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:</span>
                        <span id="grandTotalPreview">0.00 Ø±.Ø³</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                    <select id="stockWallet" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;font-family:inherit;font-size:1rem;background:white">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) --</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:18px">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù‡Ù…</button>
            </form>
        </div>
    </div>

    <!-- Orders Modal -->
    <div class="modal" id="ordersModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ordersModalTitle">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³Ù‡Ù…</h2>
                <button class="close-btn" onclick="closeOrdersModal()">&times;</button>
            </div>

            <div style="background:var(--accent-gradient);padding:20px;border-radius:16px;margin-bottom:24px">
                <div class="stock-info-row" style="border:none;color:white">
                    <span style="opacity:0.8">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                    <strong id="summaryShares">0</strong>
                </div>
                <div class="stock-info-row" style="border:none;color:white">
                    <span style="opacity:0.8">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ø±Ø§Ø¡:</span>
                    <strong id="summaryAvgPrice">0.00 Ø±.Ø³</strong>
                </div>
                <div class="stock-info-row" style="border:none;color:white">
                    <span style="opacity:0.8">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:</span>
                    <strong id="summaryTotalCost">0.00 Ø±.Ø³</strong>
                </div>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('add-order')">Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±</div>
                <div class="modal-tab" onclick="switchTab('orders-list')">Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</div>
            </div>

            <div id="add-order-tab">
                <div class="order-type-selector">
                    <div class="order-type-btn active" onclick="selectOrderType('buy')">
                        <strong style="color:var(--success);font-size:1.1rem">Ø´Ø±Ø§Ø¡</strong>
                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                    </div>
                    <div class="order-type-btn sell" onclick="selectOrderType('sell')">
                        <strong style="color:var(--danger);font-size:1.1rem">Ø¨ÙŠØ¹</strong>
                        <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px">ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                    </div>
                </div>

                <form id="orderForm" onsubmit="submitOrder(event)">
                    <input type="hidden" id="orderSymbol">
                    <input type="hidden" id="orderType" value="buy">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                        <div class="form-group">
                            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… <span style="color:var(--danger)">*</span></label>
                            <input type="number" id="orderShares" step="1" min="1" placeholder="100" required oninput="calculateFees('order')">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³) <span style="color:var(--danger)">*</span></label>
                            <input type="number" id="orderPrice" step="0.01" min="0.01" placeholder="30.00" required oninput="calculateFees('order')">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® <span style="color:var(--danger)">*</span></label>
                        <input type="date" id="orderDate" required>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                        <div class="form-group">
                            <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø±.Ø³) <span style="color:var(--text-muted);font-size:0.8rem">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                            <input type="number" id="orderCommission" step="0.01" min="0" placeholder="ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø±.Ø³) <span style="color:var(--text-muted);font-size:0.8rem">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                            <input type="number" id="orderTax" step="0.01" min="0" placeholder="ØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                    </div>
                    <div class="fees-preview" id="orderFeesPreview" style="background:var(--bg-secondary);padding:12px 16px;border-radius:10px;margin-bottom:16px;display:none">
                        <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                            <span>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©:</span>
                            <span id="orderTotalValuePreview">0.00 Ø±.Ø³</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                            <span>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</span>
                            <span id="orderCommissionPreview">0.00 Ø±.Ø³</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</span>
                            <span id="orderTaxPreview">0.00 Ø±.Ø³</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.95rem;font-weight:600;color:var(--text-primary);border-top:1px solid var(--border);padding-top:8px;margin-top:8px">
                            <span id="orderGrandTotalLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:</span>
                            <span id="orderGrandTotalPreview">0.00 Ø±.Ø³</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                        <select id="orderWallet" style="width:100%;padding:14px;border:2px solid var(--border);border-radius:12px;font-family:inherit;font-size:1rem;background:white">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) --</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center" id="orderSubmitBtn">Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø± Ø´Ø±Ø§Ø¡</button>
                </form>
            </div>

            <div id="orders-list-tab" style="display:none">
                <div class="orders-list" id="ordersList"></div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div class="modal" id="walletModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="walletModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="close-btn" onclick="closeWalletModal()">&times;</button>
            </div>
            <form id="walletForm" onsubmit="submitWallet(event)">
                <input type="hidden" id="walletId">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                    <input type="text" id="walletName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                    <input type="text" id="walletAccountNumber" placeholder="Ù…Ø«Ø§Ù„: 01234567890">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØ³ÙŠØ·</label>
                    <input type="text" id="walletBroker" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠØ©" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø­ÙØ¸Ø© <span style="color:var(--danger)">*</span></label>
                    <div class="strategy-selector" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px">
                        <div class="strategy-option" onclick="selectStrategy('speculative')" id="strategySpeculative" style="padding:16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;transition:all 0.2s">
                            <div style="font-size:1.5rem;margin-bottom:8px">ğŸ°</div>
                            <div style="font-weight:600;color:var(--warning)">Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">ØªØ¯Ø§ÙˆÙ„ ÙŠÙˆÙ…ÙŠ/Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
                        </div>
                        <div class="strategy-option" onclick="selectStrategy('balanced')" id="strategyBalanced" style="padding:16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;transition:all 0.2s">
                            <div style="font-size:1.5rem;margin-bottom:8px">âš–ï¸</div>
                            <div style="font-weight:600;color:var(--info)">Ù…ØªÙˆØ§Ø²Ù†Ø©</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">Ù…Ø²ÙŠØ¬ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª</div>
                        </div>
                        <div class="strategy-option" onclick="selectStrategy('long_term')" id="strategyLongTerm" style="padding:16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;transition:all 0.2s">
                            <div style="font-size:1.5rem;margin-bottom:8px">ğŸ¦</div>
                            <div style="font-weight:600;color:var(--success)">Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø¨Ø¹ÙŠØ¯Ø© Ø§Ù„Ù…Ø¯Ù‰</div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">Ø§Ø­ØªÙØ§Ø¸ Ø·ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¬Ù„</div>
                        </div>
                    </div>
                    <input type="hidden" id="walletStrategy" value="" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ© (Ø±.Ø³)</label>
                    <input type="number" id="walletBuyingPower" step="0.01" min="0" placeholder="0.00" value="0">
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="walletDescription" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." rows="2" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:12px;font-family:inherit;resize:vertical"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:18px" id="walletSubmitBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
            </form>
        </div>
    </div>

    <!-- Buying Power Modal -->
    <div class="modal" id="buyingPowerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</h2>
                <button class="close-btn" onclick="closeBuyingPowerModal()">&times;</button>
            </div>
            <form id="buyingPowerForm" onsubmit="submitBuyingPower(event)">
                <input type="hidden" id="bpWalletId">
                <div style="background:var(--bg-secondary);padding:16px;border-radius:12px;margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©:</span>
                        <strong id="bpWalletName">-</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                        <span>Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
                        <strong id="bpCurrentAmount" style="color:var(--success)">0.00 Ø±.Ø³</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                    <div class="order-type-selector">
                        <div class="order-type-btn active" onclick="selectBpOperation('add')" id="bpAddBtn">
                            <strong style="color:var(--success);font-size:1rem">Ø¥ÙŠØ¯Ø§Ø¹</strong>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯</div>
                        </div>
                        <div class="order-type-btn sell" onclick="selectBpOperation('subtract')" id="bpSubtractBtn">
                            <strong style="color:var(--danger);font-size:1rem">Ø³Ø­Ø¨</strong>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px">ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯</div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="bpOperation" value="add">
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</label>
                    <input type="number" id="bpAmount" step="0.01" min="0.01" placeholder="1000.00" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:18px">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</button>
            </form>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal" id="editOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2>
                <button class="close-btn" onclick="closeEditOrderModal()">&times;</button>
            </div>
            <form id="editOrderForm" onsubmit="submitEditOrder(event)">
                <input type="hidden" id="editOrderId">
                <input type="hidden" id="editOrderSymbol">

                <div style="background:var(--bg-secondary);padding:16px;border-radius:12px;margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Ø§Ù„Ø³Ù‡Ù…:</span>
                        <strong id="editOrderStockName">-</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                        <span>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span>
                        <strong id="editOrderType" style="font-weight:700">-</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <input type="number" id="editOrderShares" step="1" min="1" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label>
                    <input type="number" id="editOrderPrice" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="editOrderDate" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                    <select id="editOrderWallet" style="padding:12px;border:2px solid var(--border);border-radius:12px;width:100%">
                        <option value="">-- Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø© --</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Ø±.Ø³)</label>
                        <input type="number" id="editOrderCommission" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ø±.Ø³)</label>
                        <input type="number" id="editOrderTax" step="0.01" min="0">
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-top:20px">
                    <button type="submit" class="btn btn-primary" style="flex:1;justify-content:center;padding:16px">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button type="button" class="btn" style="padding:16px;background:var(--danger-light);color:var(--danger)" onclick="deleteOrderFromEdit()">Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal" id="importExportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø±</h2>
                <button class="close-btn" onclick="closeImportExportModal()">&times;</button>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchImportExportTab('export')">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø±</div>
                <div class="modal-tab" onclick="switchImportExportTab('import')">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</div>
            </div>

            <!-- Export Tab -->
            <div id="export-tab">
                <div style="text-align:center;padding:30px">
                    <div style="font-size:4rem;margin-bottom:16px">ğŸ“¤</div>
                    <h3 style="margin-bottom:12px">ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø±</h3>
                    <p style="color:var(--text-secondary);margin-bottom:24px">
                        Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ¹ ÙÙŠ Ù…Ø­ÙØ¸ØªÙƒ
                    </p>
                    <a href="/api/export/orders" class="btn btn-primary" style="display:inline-flex;text-decoration:none;padding:16px 32px">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:8px">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV
                    </a>
                </div>
            </div>

            <!-- Import Tab -->
            <div id="import-tab" style="display:none">
                <div style="padding:20px">
                    <div style="background:var(--info-light);padding:16px;border-radius:12px;margin-bottom:20px">
                        <h4 style="color:var(--info);margin-bottom:8px">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</h4>
                        <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:12px">
                            ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù CSV Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:
                        </p>
                        <code style="display:block;background:white;padding:12px;border-radius:8px;font-size:0.85rem;direction:ltr;text-align:left">
                            Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…, Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©, Ù†ÙˆØ¹ Ø§Ù„Ø£Ù…Ø±, Ø§Ù„ÙƒÙ…ÙŠØ©, Ø§Ù„Ø³Ø¹Ø±, Ø§Ù„ØªØ§Ø±ÙŠØ®, Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­ÙØ¸Ø©
                        </code>
                        <div style="margin-top:12px">
                            <a href="/api/export/template" style="color:var(--info);font-size:0.9rem">
                                ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº
                            </a>
                        </div>
                    </div>

                    <form id="importForm" onsubmit="submitImport(event)">
                        <div class="form-group">
                            <label>Ø§Ø®ØªØ± Ù…Ù„Ù CSV</label>
                            <input type="file" id="importFile" accept=".csv" required
                                   style="width:100%;padding:14px;border:2px dashed var(--border);border-radius:12px;background:var(--bg-secondary)">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:18px" id="importBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:8px">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Ø±ÙØ¹ ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
                        </button>
                    </form>

                    <div id="importResult" style="display:none;margin-top:20px"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock History Modal -->
    <div class="modal" id="stockHistoryModal">
        <div class="modal-content" style="max-width:900px">
            <div class="modal-header">
                <h2 id="stockHistoryTitle">ØªØ§Ø±ÙŠØ® Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‡Ù…</h2>
                <button class="close-btn" onclick="closeStockHistoryModal()">&times;</button>
            </div>

            <!-- Summary Cards -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">
                <div style="background:var(--bg-secondary);padding:14px;border-radius:12px;text-align:center">
                    <div style="font-size:0.85rem;color:var(--text-secondary)">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                    <div style="font-size:1.3rem;font-weight:700;margin-top:4px" id="historyTotalShares">0</div>
                </div>
                <div style="background:var(--bg-secondary);padding:14px;border-radius:12px;text-align:center">
                    <div style="font-size:0.85rem;color:var(--text-secondary)">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                    <div style="font-size:1.3rem;font-weight:700;margin-top:4px" id="historyAvgCost">0.00</div>
                </div>
                <div style="background:var(--bg-secondary);padding:14px;border-radius:12px;text-align:center">
                    <div style="font-size:0.85rem;color:var(--text-secondary)">Ø§Ù„Ø±Ø¨Ø­ ØºÙŠØ± Ø§Ù„Ù…Ø­Ù‚Ù‚</div>
                    <div style="font-size:1.3rem;font-weight:700;margin-top:4px" id="historyUnrealizedProfit">0.00</div>
                </div>
                <div style="background:var(--bg-secondary);padding:14px;border-radius:12px;text-align:center">
                    <div style="font-size:0.85rem;color:var(--text-secondary)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</div>
                    <div style="font-size:1.3rem;font-weight:700;margin-top:4px" id="historyTotalFees">0.00</div>
                </div>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchHistoryTab('history')">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                <div class="modal-tab" onclick="switchHistoryTab('calculator')">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±</div>
                <div class="modal-tab" onclick="switchHistoryTab('corporate')">Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</div>
            </div>

            <!-- History Tab -->
            <div id="history-tab">
                <div style="max-height:350px;overflow-y:auto">
                    <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
                        <thead style="position:sticky;top:0;background:white">
                            <tr style="border-bottom:2px solid var(--border)">
                                <th style="padding:12px;text-align:right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ù†ÙˆØ¹</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ù…ØªÙˆØ³Ø·</th>
                                <th style="padding:12px;text-align:center">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="8" style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Calculator Tab -->
            <div id="calculator-tab" style="display:none">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                    <div>
                        <h4 style="margin-bottom:16px">Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                        <form id="simulateForm" onsubmit="simulateOrder(event)">
                            <div class="order-type-selector" style="margin-bottom:16px">
                                <div class="order-type-btn active" onclick="selectSimulationType('buy')" id="simBuyBtn">
                                    <strong style="color:var(--success)">Ø´Ø±Ø§Ø¡</strong>
                                </div>
                                <div class="order-type-btn sell" onclick="selectSimulationType('sell')" id="simSellBtn">
                                    <strong style="color:var(--danger)">Ø¨ÙŠØ¹</strong>
                                </div>
                            </div>
                            <input type="hidden" id="simOrderType" value="buy">
                            <input type="hidden" id="simSymbol">
                            <div class="form-group">
                                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <input type="number" id="simShares" step="1" min="1" placeholder="100" required oninput="updateSimPreview()">
                            </div>
                            <div class="form-group">
                                <label>Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label>
                                <input type="number" id="simPrice" step="0.01" min="0.01" placeholder="30.00" required oninput="updateSimPreview()">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø«ÙŠØ±</button>
                        </form>
                    </div>
                    <div>
                        <h4 style="margin-bottom:16px">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</h4>
                        <div id="simulationResult" style="background:var(--bg-secondary);padding:20px;border-radius:12px;min-height:200px">
                            <div style="text-align:center;color:var(--text-secondary);padding:40px">
                                Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ£Ø«ÙŠØ±
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Corporate Actions Tab (Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„) -->
            <div id="corporate-tab" style="display:none">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                    <div>
                        <h4 style="margin-bottom:16px;display:flex;align-items:center;gap:8px">
                            <span style="font-size:1.2rem">ğŸ</span> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø­Ø© Ø£Ø³Ù‡Ù…
                        </h4>
                        <div style="background:var(--bg-secondary);padding:16px;border-radius:12px;margin-bottom:16px;font-size:0.9rem">
                            <p style="margin:0;color:var(--text-secondary)">
                                <strong>Ù…Ø«Ø§Ù„:</strong> Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© 1 Ø³Ù‡Ù… Ù„ÙƒÙ„ 2 Ø³Ù‡Ù… Ù…Ù…Ù„ÙˆÙƒØŒ Ø£Ø¯Ø®Ù„:
                            </p>
                            <p style="margin:8px 0 0 0">Ø§Ù„Ø¨Ø³Ø· = 1ØŒ Ø§Ù„Ù…Ù‚Ø§Ù… = 2</p>
                        </div>
                        <form id="corporateActionForm" onsubmit="addCorporateAction(event)">
                            <input type="hidden" id="corpSymbol">
                            <div class="form-group">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
                                <select id="corpActionType" required style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px">
                                    <option value="bonus">Ù…Ù†Ø­Ø© Ø£Ø³Ù‡Ù… Ù…Ø¬Ø§Ù†ÙŠØ©</option>
                                    <option value="split">ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ø³Ù‡Ù…</option>
                                    <option value="reverse_split">ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù‡Ù…</option>
                                </select>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label>Ø§Ù„Ø¨Ø³Ø· (Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</label>
                                    <input type="number" id="corpNumerator" step="1" min="1" value="1" required oninput="simulateCorporateAction()">
                                </div>
                                <div class="form-group">
                                    <label>Ø§Ù„Ù…Ù‚Ø§Ù… (Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)</label>
                                    <input type="number" id="corpDenominator" step="1" min="1" value="2" required oninput="simulateCorporateAction()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                                <input type="date" id="corpDate" required>
                            </div>
                            <div class="form-group">
                                <label>Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="text" id="corpDescription" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ 2026">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">
                                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†Ø­Ø©
                            </button>
                        </form>
                    </div>
                    <div>
                        <h4 style="margin-bottom:16px">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±</h4>
                        <div id="corporateSimResult" style="background:var(--bg-secondary);padding:20px;border-radius:12px;min-height:250px">
                            <div style="text-align:center;color:var(--text-secondary);padding:40px">
                                Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±
                            </div>
                        </div>

                        <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø­ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
                        <h4 style="margin:24px 0 16px">Ø³Ø¬Ù„ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h4>
                        <div id="corporateActionsHistory" style="max-height:200px;overflow-y:auto">
                            <div style="text-align:center;color:var(--text-secondary);padding:20px">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø³Ø¬Ù„Ø©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Modal (Deposit/Withdrawal) -->
    <div class="modal" id="transactionModal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h2>Ø¥ÙŠØ¯Ø§Ø¹ / Ø³Ø­Ø¨</h2>
                <button class="close-btn" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm" onsubmit="submitTransaction(event)">
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                    <select id="transactionType" required>
                        <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹</option>
                        <option value="withdrawal">Ø³Ø­Ø¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø­ÙØ¸Ø©</label>
                    <select id="transactionWallet" required>
                        <!-- ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="transactionNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:16px">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                </button>
            </form>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let allStocks = [];
        let allWallets = [];
        let currentOrderSymbol = '';
        let portfolioChart = null;
        let currentPage = 'portfolio';
        let editingWalletId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
            loadAllStocks();
            loadWalletsForSelect();
            loadCommissionSettings(); // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
            document.getElementById('buyDate').valueAsDate = new Date();
            document.getElementById('orderDate').valueAsDate = new Date();

            const symbolInput = document.getElementById('symbol');
            symbolInput.addEventListener('input', handleSymbolInput);

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³ÙˆÙ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ…ÙŠØ©
            document.getElementById('shares').addEventListener('input', () => calculateFees('add'));

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.form-group')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });

            initChart();
            setTimeout(loadAnalysis, 1000);
        });

        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(page + 'Page').classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            if (page === 'analysis') loadFullAnalysis();
            if (page === 'news') loadGlobalPrices();
            if (page === 'marketNews') loadMarketNews();
            if (page === 'dividends') loadDividends();
            if (page === 'speculative') loadSpeculativeData();
            if (page === 'longTerm') loadLongTermData();
            if (page === 'performance') loadPerformanceData();
            if (page === 'wallets') loadWallets();
            if (page === 'settings') loadSettingsPage();
            if (page === 'dashboard') loadDashboard();
            if (page === 'operations') loadAllOperations();
            if (page === 'walletPerformance') loadWalletPerformance();
        }

        // ================== Market News ==================
        let allMarketNews = [];

        async function loadMarketNews() {
            const container = document.getElementById('marketNewsContainer');
            container.innerHTML = `<div class="empty-state" style="padding:60px">
                <div style="font-size:3rem;margin-bottom:16px">ğŸ“°</div>
                <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</h3>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/news/all?limit=50`);
                const data = await response.json();

                allMarketNews = data.news || [];

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                updateNewsCounts(allMarketNews);

                // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                renderMarketNews(allMarketNews);

            } catch (error) {
                console.error('Error loading news:', error);
                container.innerHTML = `<div class="empty-state" style="padding:60px">
                    <div style="font-size:3rem;margin-bottom:16px">âš ï¸</div>
                    <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3>
                    <button class="btn btn-primary" onclick="loadMarketNews()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>`;
            }
        }

        function updateNewsCounts(news) {
            const argaamCount = news.filter(n => n.source === 'Ø£Ø±Ù‚Ø§Ù…').length;
            const aleqtCount = news.filter(n => n.source === 'Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©').length;
            const maaalCount = news.filter(n => n.source === 'Ù…Ø§Ù„').length;

            document.getElementById('argaamCount').textContent = argaamCount;
            document.getElementById('aleqtCount').textContent = aleqtCount;
            document.getElementById('maaalCount').textContent = maaalCount;
        }

        function renderMarketNews(news) {
            const container = document.getElementById('marketNewsContainer');

            if (!news || news.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:60px">
                    <div style="font-size:3rem;margin-bottom:16px">ğŸ“­</div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±</h3>
                </div>`;
                return;
            }

            const sourceColors = {
                'Ø£Ø±Ù‚Ø§Ù…': '#3b82f6',
                'Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©': '#10b981',
                'Ù…Ø§Ù„': '#f59e0b'
            };

            const sourceIcons = {
                'Ø£Ø±Ù‚Ø§Ù…': 'ğŸ“Š',
                'Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©': 'ğŸ“°',
                'Ù…Ø§Ù„': 'ğŸ’°'
            };

            container.innerHTML = `
                <div class="news-grid" style="display:grid;gap:16px">
                    ${news.map(item => {
                        const color = sourceColors[item.source] || '#6b7280';
                        const icon = sourceIcons[item.source] || 'ğŸ“„';

                        return `
                        <div class="news-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s"
                             onclick="openNewsUrl('${item.url}')"
                             onmouseover="this.style.borderColor='${color}';this.style.transform='translateY(-2px)'"
                             onmouseout="this.style.borderColor='var(--border)';this.style.transform='translateY(0)'">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
                                <div style="flex:1">
                                    <h3 style="font-size:1.05rem;font-weight:600;margin-bottom:12px;line-height:1.6;color:var(--text)">
                                        ${item.title}
                                    </h3>
                                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                                        <span style="display:inline-flex;align-items:center;gap:6px;background:${color}20;color:${color};padding:4px 12px;border-radius:6px;font-size:0.85rem;font-weight:500">
                                            ${icon} ${item.source}
                                        </span>
                                        <span style="color:var(--text-muted);font-size:0.85rem">
                                            ${item.date || 'Ø§Ù„ÙŠÙˆÙ…'}
                                        </span>
                                        ${item.category ? `<span style="color:var(--text-muted);font-size:0.8rem;background:var(--bg-secondary);padding:3px 8px;border-radius:4px">${item.category}</span>` : ''}
                                    </div>
                                </div>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" style="flex-shrink:0">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function filterNewsBySource() {
            const source = document.getElementById('newsSourceFilter').value;

            let filtered;
            if (source === 'all') {
                filtered = allMarketNews;
            } else {
                filtered = allMarketNews.filter(n => n.source === source);
            }

            renderMarketNews(filtered);
        }

        async function searchMarketNews() {
            const query = document.getElementById('newsSearchInput').value.trim();

            if (!query) {
                renderMarketNews(allMarketNews);
                return;
            }

            const container = document.getElementById('marketNewsContainer');
            container.innerHTML = `<div class="empty-state" style="padding:40px">
                <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</h3>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/news/search?q=${encodeURIComponent(query)}&limit=30`);
                const data = await response.json();

                if (data.news && data.news.length > 0) {
                    renderMarketNews(data.news);
                } else {
                    container.innerHTML = `<div class="empty-state" style="padding:60px">
                        <div style="font-size:3rem;margin-bottom:16px">ğŸ”</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}"</h3>
                        <button class="btn btn-secondary" onclick="loadMarketNews()" style="margin-top:16px">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
                    </div>`;
                }

            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function refreshMarketNews() {
            const container = document.getElementById('marketNewsContainer');
            container.innerHTML = `<div class="empty-state" style="padding:60px">
                <div style="font-size:3rem;margin-bottom:16px">ğŸ”„</div>
                <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</h3>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/news/refresh`);
                const data = await response.json();

                allMarketNews = data.news || [];
                updateNewsCounts(allMarketNews);
                renderMarketNews(allMarketNews);

                // Reset filter
                document.getElementById('newsSourceFilter').value = 'all';
                document.getElementById('newsSearchInput').value = '';

            } catch (error) {
                console.error('Refresh error:', error);
                loadMarketNews();
            }
        }

        function openNewsUrl(url) {
            window.open(url, '_blank');
        }

        // ================== Wallet Performance Analysis ==================
        let walletPerformanceData = null;

        async function loadWalletPerformance() {
            const content = document.getElementById('walletPerformanceContent');
            content.innerHTML = `<div class="empty-state" style="padding:60px">
                <div style="font-size:3rem;margin-bottom:16px">ğŸ“Š</div>
                <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡...</h3>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/wallet-performance`);
                const data = await response.json();
                walletPerformanceData = data;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù…
                const summary = data.overall_summary;
                document.getElementById('totalInvested').textContent = formatNumber(summary.total_invested) + ' Ø±.Ø³';
                document.getElementById('totalRealized').textContent = formatNumber(summary.realized_profit_loss) + ' Ø±.Ø³';
                document.getElementById('totalRealized').style.color = summary.realized_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)';
                document.getElementById('totalDividendsPerf').textContent = formatNumber(summary.total_dividends) + ' Ø±.Ø³';
                document.getElementById('netProfitLoss').textContent = formatNumber(summary.net_profit_loss) + ' Ø±.Ø³';
                document.getElementById('netProfitLoss').style.color = summary.net_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)';

                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸
                const selector = document.getElementById('walletPerformanceSelector');
                selector.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>';
                data.wallets.forEach(wallet => {
                    selector.innerHTML += `<option value="${wallet.wallet_id}">${wallet.wallet_name}</option>`;
                });

                // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸
                renderWalletPerformance(data.wallets);

            } catch (error) {
                console.error('Error loading wallet performance:', error);
                content.innerHTML = `<div class="empty-state" style="padding:60px">
                    <div style="font-size:3rem;margin-bottom:16px">âŒ</div>
                    <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                </div>`;
            }
        }

        function filterWalletPerformance() {
            if (!walletPerformanceData) return;

            const selectedWallet = document.getElementById('walletPerformanceSelector').value;

            if (selectedWallet === 'all') {
                renderWalletPerformance(walletPerformanceData.wallets);
            } else {
                const wallet = walletPerformanceData.wallets.find(w => w.wallet_id === selectedWallet);
                if (wallet) {
                    renderWalletPerformance([wallet]);
                }
            }
        }

        function renderWalletPerformance(wallets) {
            const content = document.getElementById('walletPerformanceContent');

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            let totalWinning = 0;
            let totalLosing = 0;
            wallets.forEach(w => {
                totalWinning += w.summary.winning_trades;
                totalLosing += w.summary.losing_trades;
            });
            const totalTrades = totalWinning + totalLosing;
            const winRate = totalTrades > 0 ? ((totalWinning / totalTrades) * 100).toFixed(1) : 0;

            document.getElementById('winningCount').textContent = totalWinning;
            document.getElementById('losingCount').textContent = totalLosing;
            document.getElementById('winRatePerf').textContent = winRate + '%';

            let html = '';

            wallets.forEach(wallet => {
                html += `
                <div class="card" style="margin-bottom:24px">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <h3 style="margin:0">${wallet.wallet_name}</h3>
                            <p style="margin:4px 0 0;color:var(--text-muted);font-size:0.9rem">
                                ${wallet.summary.total_trades} ØµÙÙ‚Ø© Ù…Ù‚ÙÙ„Ø© | ${wallet.summary.open_positions_count} Ù…Ø±ÙƒØ² Ù…ÙØªÙˆØ­
                            </p>
                        </div>
                        <div style="text-align:left">
                            <div style="font-size:1.5rem;font-weight:700;color:${wallet.summary.net_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ${wallet.summary.net_profit_loss >= 0 ? '+' : ''}${formatNumber(wallet.summary.net_profit_loss)} Ø±.Ø³
                            </div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">
                                Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: ${wallet.summary.win_rate}%
                            </div>
                        </div>
                    </div>

                    <!-- Wallet Stats -->
                    <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:12px;margin:20px 0;padding:16px;background:var(--bg-secondary);border-radius:12px">
                        <div style="text-align:center">
                            <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±</div>
                            <div style="font-weight:600">${formatNumber(wallet.summary.total_invested)}</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                            <div style="font-weight:600">${formatNumber(wallet.summary.current_value)}</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚</div>
                            <div style="font-weight:600;color:${wallet.summary.realized_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatNumber(wallet.summary.realized_profit_loss)}</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
                            <div style="font-weight:600;color:var(--success)">${formatNumber(wallet.summary.total_dividends)}</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ø±Ø³ÙˆÙ…</div>
                            <div style="font-weight:600;color:var(--danger)">${formatNumber(wallet.summary.total_fees)}</div>
                        </div>
                    </div>

                    <!-- Open Positions -->
                    ${wallet.open_positions.length > 0 ? `
                    <div style="margin-bottom:24px">
                        <h4 style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
                            <span style="background:var(--primary-light);color:var(--primary);padding:4px 12px;border-radius:20px;font-size:0.85rem">Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…ÙØªÙˆØ­Ø©</span>
                        </h4>
                        <div style="overflow-x:auto">
                            <table class="data-table" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø³Ù‡Ù…</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                        <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                        <th>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</th>
                                        <th>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${wallet.open_positions.map(pos => `
                                    <tr>
                                        <td>
                                            <strong>${pos.name}</strong>
                                            <div style="font-size:0.8rem;color:var(--text-muted)">${pos.symbol}</div>
                                        </td>
                                        <td>${pos.shares}</td>
                                        <td>${formatNumber(pos.avg_cost)} Ø±.Ø³</td>
                                        <td>${formatNumber(pos.current_price)} Ø±.Ø³</td>
                                        <td style="color:${pos.unrealized_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                            ${pos.unrealized_profit_loss >= 0 ? '+' : ''}${formatNumber(pos.unrealized_profit_loss)} Ø±.Ø³
                                            <div style="font-size:0.8rem">(${pos.unrealized_percent >= 0 ? '+' : ''}${pos.unrealized_percent}%)</div>
                                        </td>
                                        <td style="color:var(--success)">${formatNumber(pos.dividends_received)} Ø±.Ø³</td>
                                        <td style="color:${pos.total_return >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                            ${pos.total_return >= 0 ? '+' : ''}${formatNumber(pos.total_return)} Ø±.Ø³
                                        </td>
                                        <td>
                                            <span style="background:${pos.analysis.color}20;color:${pos.analysis.color};padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600">
                                                ${pos.analysis.status_ar}
                                            </span>
                                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">${pos.analysis.recommendation}</div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Closed Trades -->
                    ${wallet.trades.length > 0 ? `
                    <div>
                        <h4 style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
                            <span style="background:var(--text-muted)20;color:var(--text-secondary);padding:4px 12px;border-radius:20px;font-size:0.85rem">Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©</span>
                        </h4>
                        <div style="overflow-x:auto">
                            <table class="data-table" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø³Ù‡Ù…</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                        <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                        <th>Ù…Ø¯Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸</th>
                                        <th>Ø±Ø¨Ø­ Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</th>
                                        <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙƒÙ„ÙŠ</th>
                                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${wallet.trades.map(trade => `
                                    <tr style="background:${trade.is_profitable ? 'var(--success-light)' : 'var(--danger-light)'}">
                                        <td>
                                            <strong>${trade.name}</strong>
                                            <div style="font-size:0.8rem;color:var(--text-muted)">${trade.symbol}</div>
                                        </td>
                                        <td>${trade.shares}</td>
                                        <td>${formatNumber(trade.buy_price_avg)} Ø±.Ø³</td>
                                        <td>${formatNumber(trade.sell_price)} Ø±.Ø³</td>
                                        <td>${trade.holding_days} ÙŠÙˆÙ…</td>
                                        <td style="color:${trade.price_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                            ${trade.price_profit_loss >= 0 ? '+' : ''}${formatNumber(trade.price_profit_loss)} Ø±.Ø³
                                        </td>
                                        <td style="color:var(--success)">${formatNumber(trade.dividends_received)} Ø±.Ø³</td>
                                        <td style="font-weight:600;color:${trade.total_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                            ${trade.total_profit_loss >= 0 ? '+' : ''}${formatNumber(trade.total_profit_loss)} Ø±.Ø³
                                            <div style="font-size:0.8rem">(${trade.profit_percent >= 0 ? '+' : ''}${trade.profit_percent}%)</div>
                                        </td>
                                        <td>
                                            <span style="font-size:0.85rem;color:var(--text-secondary)">${trade.reason}</span>
                                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">${trade.sell_date}</div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : '<div style="text-align:center;color:var(--text-muted);padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…Ù‚ÙÙ„Ø©</div>'}
                </div>
                `;
            });

            if (html === '') {
                html = `<div class="empty-state" style="padding:60px">
                    <div style="font-size:3rem;margin-bottom:16px">ğŸ“Š</div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h3>
                </div>`;
            }

            content.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        async function loadSettingsPage() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('settingCommissionRate').value = data.commission_rate_percent;
                    document.getElementById('settingTaxRate').value = data.tax_rate_percent;
                    updateSettingsExample();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø«Ø§Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
        function updateSettingsExample() {
            const commRate = parseFloat(document.getElementById('settingCommissionRate').value) || 0;
            const taxRate = parseFloat(document.getElementById('settingTaxRate').value) || 0;
            const sampleValue = 10000;

            const commission = sampleValue * (commRate / 100);
            const tax = commission * (taxRate / 100);
            const totalFees = commission + tax;

            document.getElementById('exampleCommRate').textContent = commRate;
            document.getElementById('exampleTaxRate').textContent = taxRate;
            document.getElementById('exampleCommValue').textContent = `${formatNumber(commission)} Ø±.Ø³`;
            document.getElementById('exampleTaxValue').textContent = `${formatNumber(tax)} Ø±.Ø³`;
            document.getElementById('exampleTotalFees').textContent = `${formatNumber(totalFees)} Ø±.Ø³`;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        async function saveSettings(event) {
            event.preventDefault();
            const commRate = parseFloat(document.getElementById('settingCommissionRate').value);
            const taxRate = parseFloat(document.getElementById('settingTaxRate').value);

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        commission_rate: commRate / 100,
                        tax_rate: taxRate / 100
                    })
                });
                if (response.ok) {
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    await loadCommissionSettings(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            }
        }

        // ===== Stock History & Simulator Functions =====
        let currentHistorySymbol = '';

        async function openStockHistoryModal(symbol, name) {
            currentHistorySymbol = symbol;
            document.getElementById('stockHistoryTitle').textContent = `ØªØ§Ø±ÙŠØ® Ø¹Ù…Ù„ÙŠØ§Øª ${name}`;
            document.getElementById('simSymbol').value = symbol;
            document.getElementById('corpSymbol').value = symbol;
            document.getElementById('corpDate').valueAsDate = new Date();
            document.getElementById('stockHistoryModal').classList.add('active');
            switchHistoryTab('history');
            await loadStockHistory(symbol);
        }

        function closeStockHistoryModal() {
            document.getElementById('stockHistoryModal').classList.remove('active');
        }

        function switchHistoryTab(tab) {
            document.querySelectorAll('#stockHistoryModal .modal-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('history-tab').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('calculator-tab').style.display = tab === 'calculator' ? 'block' : 'none';
            document.getElementById('corporate-tab').style.display = tab === 'corporate' ? 'block' : 'none';
            event.target.classList.add('active');

            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ§Ø¨
            if (tab === 'corporate') {
                const symbol = document.getElementById('corpSymbol').value;
                if (symbol) {
                    loadCorporateActions(symbol);
                    simulateCorporateAction();
                }
            }
        }

        async function loadStockHistory(symbol) {
            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/history`);
                if (!response.ok) throw new Error('Failed to load history');

                const data = await response.json();

                // Update summary
                document.getElementById('historyTotalShares').textContent = data.summary.total_shares;
                document.getElementById('historyAvgCost').textContent = `${formatNumber(data.summary.avg_cost)} Ø±.Ø³`;

                const unrealizedProfit = data.summary.unrealized_profit;
                const unrealizedEl = document.getElementById('historyUnrealizedProfit');
                unrealizedEl.textContent = `${formatNumber(unrealizedProfit)} Ø±.Ø³`;
                unrealizedEl.className = unrealizedProfit >= 0 ? 'positive' : 'negative';

                document.getElementById('historyTotalFees').textContent = `${formatNumber(data.summary.total_fees_paid)} Ø±.Ø³`;

                // Update table
                const tbody = document.getElementById('historyTableBody');
                if (data.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
                    return;
                }

                tbody.innerHTML = data.history.map(h => `
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:10px">${h.date}</td>
                        <td style="padding:10px;text-align:center">
                            <span style="padding:4px 10px;border-radius:6px;font-size:0.8rem;
                                background:${h.order_type === 'buy' ? 'var(--success-light)' : 'var(--danger-light)'};
                                color:${h.order_type === 'buy' ? 'var(--success)' : 'var(--danger)'}">
                                ${h.order_type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}
                            </span>
                        </td>
                        <td style="padding:10px;text-align:center">${h.shares}</td>
                        <td style="padding:10px;text-align:center">${formatNumber(h.price)}</td>
                        <td style="padding:10px;text-align:center">${formatNumber(h.total_fees)}</td>
                        <td style="padding:10px;text-align:center;font-weight:600">${h.running_shares}</td>
                        <td style="padding:10px;text-align:center">${formatNumber(h.avg_cost)}</td>
                        <td style="padding:10px;text-align:center;color:${h.realized_profit >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${h.order_type === 'sell' ? formatNumber(h.realized_profit) : '-'}
                        </td>
                    </tr>
                `).join('');

                // Set simulator default price
                document.getElementById('simPrice').value = data.current_price.toFixed(2);

            } catch (error) {
                console.error('Error loading stock history:', error);
            }
        }

        function selectSimulationType(type) {
            document.getElementById('simOrderType').value = type;
            document.getElementById('simBuyBtn').classList.toggle('active', type === 'buy');
            document.getElementById('simSellBtn').classList.toggle('active', type === 'sell');
            document.getElementById('simSellBtn').classList.toggle('sell', type === 'sell');
            updateSimPreview();
        }

        async function simulateOrder(event) {
            event.preventDefault();
            const symbol = document.getElementById('simSymbol').value;
            const orderType = document.getElementById('simOrderType').value;
            const shares = parseFloat(document.getElementById('simShares').value);
            const price = parseFloat(document.getElementById('simPrice').value);

            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_type: orderType, shares, price })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                    return;
                }

                const data = await response.json();
                displaySimulationResult(data);

            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            }
        }

        function displaySimulationResult(data) {
            const resultDiv = document.getElementById('simulationResult');
            const isBuy = data.simulation.order_type === 'buy';

            resultDiv.innerHTML = `
                <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Ù‚ÙŠÙ…Ø© Ø§Ù„ØµÙÙ‚Ø©:</span>
                        <span>${formatNumber(data.simulation.total_value)} Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© + Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                        <span>${formatNumber(data.simulation.total_fees)} Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-weight:600">
                        <span>${isBuy ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:' : 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…:'}</span>
                        <span>${formatNumber(data.simulation.total_cost)} Ø±.Ø³</span>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
                        <div style="font-size:0.9rem">
                            <div>Ø§Ù„ÙƒÙ…ÙŠØ©: <strong>${data.before.shares}</strong></div>
                            <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <strong>${formatNumber(data.before.avg_cost)}</strong></div>
                            <div>Ø§Ù„Ø±Ø¨Ø­: <strong class="${data.before.profit_loss >= 0 ? 'positive' : 'negative'}">${formatNumber(data.before.profit_loss)}</strong></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
                        <div style="font-size:0.9rem">
                            <div>Ø§Ù„ÙƒÙ…ÙŠØ©: <strong>${data.after.shares}</strong></div>
                            <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <strong>${formatNumber(data.after.avg_cost)}</strong></div>
                            <div>Ø§Ù„Ø±Ø¨Ø­: <strong class="${data.after.profit_loss >= 0 ? 'positive' : 'negative'}">${formatNumber(data.after.profit_loss)}</strong></div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                    <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px">Ø§Ù„ØªØ£Ø«ÙŠØ±</div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>ØªØºÙŠØ± Ø§Ù„Ù…ØªÙˆØ³Ø·:</span>
                        <span class="${data.impact.avg_cost_change <= 0 ? 'positive' : 'negative'}">${data.impact.avg_cost_change > 0 ? '+' : ''}${formatNumber(data.impact.avg_cost_change)} Ø±.Ø³</span>
                    </div>
                    ${!isBuy ? `
                    <div style="display:flex;justify-content:space-between;font-weight:600">
                        <span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚:</span>
                        <span class="${data.impact.realized_profit >= 0 ? 'positive' : 'negative'}">${formatNumber(data.impact.realized_profit)} Ø±.Ø³</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function updateSimPreview() {
            // Optional: could add live preview updates
        }

        // ===== Corporate Actions Functions (Ø²ÙŠØ§Ø¯Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„) =====

        async function simulateCorporateAction() {
            const symbol = document.getElementById('corpSymbol').value;
            if (!symbol) return;

            const actionType = document.getElementById('corpActionType').value;
            const numerator = parseFloat(document.getElementById('corpNumerator').value) || 1;
            const denominator = parseFloat(document.getElementById('corpDenominator').value) || 2;

            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/simulate-corporate-action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action_type: actionType,
                        ratio_numerator: numerator,
                        ratio_denominator: denominator
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    document.getElementById('corporateSimResult').innerHTML = `
                        <div style="text-align:center;color:var(--danger);padding:40px">
                            ${error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£'}
                        </div>
                    `;
                    return;
                }

                const data = await response.json();
                displayCorporateSimulation(data);

            } catch (error) {
                console.error('Error simulating corporate action:', error);
            }
        }

        function displayCorporateSimulation(data) {
            const resultDiv = document.getElementById('corporateSimResult');
            const actionTypeAr = {
                'bonus': 'Ù…Ù†Ø­Ø© Ø£Ø³Ù‡Ù…',
                'split': 'ØªØ¬Ø²Ø¦Ø©',
                'reverse_split': 'ØªØ¬Ù…ÙŠØ¹'
            };

            resultDiv.innerHTML = `
                <div style="text-align:center;margin-bottom:20px">
                    <div style="font-size:2rem;color:var(--primary);margin-bottom:8px">ğŸ</div>
                    <div style="font-size:1.1rem;font-weight:600">${actionTypeAr[data.simulation.action_type] || data.simulation.action_type}</div>
                    <div style="color:var(--text-secondary)">${data.simulation.description}</div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                    <div style="background:var(--bg-primary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:0.8rem;color:var(--text-secondary)">Ù‚Ø¨Ù„</div>
                        <div style="font-size:1.2rem;font-weight:700">${data.before.shares}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary)">Ø³Ù‡Ù…</div>
                    </div>
                    <div style="background:var(--bg-primary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:0.8rem;color:var(--text-secondary)">Ø¨Ø¹Ø¯</div>
                        <div style="font-size:1.2rem;font-weight:700;color:var(--success)">${data.after.shares}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary)">Ø³Ù‡Ù…</div>
                    </div>
                </div>

                <div style="border-top:1px solid var(--border);padding-top:16px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span style="color:var(--text-secondary)">Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ù†Ø­Ø©:</span>
                        <span style="font-weight:600;color:var(--success)">+${data.after.bonus_shares}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span style="color:var(--text-secondary)">Ù†Ø³Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©:</span>
                        <span style="font-weight:600;color:var(--success)">+${data.impact.shares_increase_percent}%</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span style="color:var(--text-secondary)">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…:</span>
                        <span>${formatNumber(data.before.avg_cost)} Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span style="color:var(--text-secondary)">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯:</span>
                        <span style="font-weight:600;color:var(--success)">${formatNumber(data.after.avg_cost)} Ø±.Ø³</span>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                        <span style="color:var(--text-secondary)">Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…ØªÙˆØ³Ø·:</span>
                        <span style="font-weight:600;color:var(--success)">-${data.impact.avg_cost_decrease_percent}%</span>
                    </div>
                </div>

                <div style="margin-top:16px;padding:12px;background:var(--success-light);border-radius:8px;text-align:center">
                    <div style="font-size:0.85rem;color:var(--success)">
                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ø§ ØªØªØºÙŠØ± (${formatNumber(data.before.total_cost)} Ø±.Ø³)
                    </div>
                </div>
            `;
        }

        async function addCorporateAction(event) {
            event.preventDefault();

            const symbol = document.getElementById('corpSymbol').value;
            const actionType = document.getElementById('corpActionType').value;
            const numerator = parseFloat(document.getElementById('corpNumerator').value);
            const denominator = parseFloat(document.getElementById('corpDenominator').value);
            const date = document.getElementById('corpDate').value;
            const description = document.getElementById('corpDescription').value;

            if (!symbol || !numerator || !denominator || !date) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/corporate-actions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action_type: actionType,
                        ratio_numerator: numerator,
                        ratio_denominator: denominator,
                        date: date,
                        description: description
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                    return;
                }

                alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†Ø­Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nØ£Ø³Ù‡Ù… Ø§Ù„Ù…Ù†Ø­Ø©: ${data.impact.bonus_shares}\nØ§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${data.impact.avg_cost_after} Ø±.Ø³`);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await loadCorporateActions(symbol);
                await loadStockHistory(symbol);
                await loadPortfolio();

                // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('corpDescription').value = '';

            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†Ø­Ø©');
                console.error(error);
            }
        }

        async function loadCorporateActions(symbol) {
            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/corporate-actions`);
                if (!response.ok) return;

                const data = await response.json();
                const historyDiv = document.getElementById('corporateActionsHistory');

                if (data.corporate_actions.length === 0) {
                    historyDiv.innerHTML = `
                        <div style="text-align:center;color:var(--text-secondary);padding:20px">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø³Ø¬Ù„Ø©
                        </div>
                    `;
                    return;
                }

                const actionTypeAr = {
                    'bonus': 'Ù…Ù†Ø­Ø©',
                    'split': 'ØªØ¬Ø²Ø¦Ø©',
                    'reverse_split': 'ØªØ¬Ù…ÙŠØ¹'
                };

                historyDiv.innerHTML = data.corporate_actions.map(action => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px">
                        <div>
                            <div style="font-weight:600">
                                <span style="color:var(--success)">ğŸ</span>
                                ${actionTypeAr[action.action_type] || action.action_type}
                                (${action.ratio_numerator}:${action.ratio_denominator})
                            </div>
                            <div style="font-size:0.8rem;color:var(--text-secondary)">${action.date} ${action.description ? '- ' + action.description : ''}</div>
                        </div>
                        <button onclick="deleteCorporateAction('${symbol}', '${action.action_id}')" class="btn btn-danger" style="padding:4px 10px;font-size:0.8rem">
                            Ø­Ø°Ù
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading corporate actions:', error);
            }
        }

        async function deleteCorporateAction(symbol, actionId) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ')) return;

            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/corporate-actions/${actionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadCorporateActions(symbol);
                    await loadStockHistory(symbol);
                    await loadPortfolio();
                    simulateCorporateAction();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡');
            }
        }

        function initChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');

            const gradient = ctx.createLinearGradient(0, 0, 0, 280);
            gradient.addColorStop(0, 'rgba(22, 163, 74, 0.2)');
            gradient.addColorStop(1, 'rgba(22, 163, 74, 0)');

            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'],
                    datasets: [{
                        label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#16a34a',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#16a34a',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#16a34a',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (context) => `${formatNumber(context.raw)} Ø±.Ø³`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e2e8f0' },
                            ticks: {
                                color: '#64748b',
                                callback: (value) => formatNumber(value, 0)
                            }
                        }
                    }
                }
            });
        }

        async function loadAllStocks() {
            try {
                const response = await fetch(`${API_BASE}/all-stocks`);
                const data = await response.json();
                allStocks = data.stocks || [];
                console.log('Loaded stocks:', allStocks.length);
            } catch (error) {
                console.error('Error loading stocks:', error);
                allStocks = [];
            }
        }

        function handleSymbolInput() {
            const query = document.getElementById('symbol').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                document.getElementById('stockInfo').style.display = 'none';
                document.getElementById('stockName').value = '';
                return;
            }

            // Search in all stocks
            const filtered = allStocks.filter(stock =>
                stock.code.includes(query) ||
                stock.name.includes(query) ||
                (stock.symbol && stock.symbol.includes(query))
            ).slice(0, 10);

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="stock-search-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(stock => `
                    <div class="stock-search-item" onclick="selectStock('${stock.code}', '${stock.name}', '${stock.sector}')">
                        <div>
                            <div style="font-weight:600">${stock.name}</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">${stock.sector}</div>
                        </div>
                        <div style="font-family:monospace;color:var(--text-muted)">${stock.code}</div>
                    </div>
                `).join('');
            }
            resultsDiv.style.display = 'block';
        }

        async function fetchStockPrice(code) {
            try {
                const response = await fetch(`${API_BASE}/price/${code}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currentPriceInfo').textContent = data.price > 0 ? `${data.price.toFixed(2)} Ø±.Ø³` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                    // Ù…Ù„Ø¡ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (data.price > 0) {
                        document.getElementById('buyPrice').value = data.price.toFixed(2);
                    }
                }
            } catch (error) {
                document.getElementById('currentPriceInfo').textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            }
        }

        function selectStock(code, name, sector) {
            document.getElementById('symbol').value = code;
            document.getElementById('stockName').value = name;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('sectorInfo').textContent = sector;
            document.getElementById('stockHint').textContent = 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù‡Ù…';
            document.getElementById('stockHint').className = 'stock-hint success';
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('currentPriceInfo').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            fetchStockPrice(code);
        }

        let portfolioDividends = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª

        async function loadPortfolio() {
            try {
                const [portfolioRes, dividendsRes, walletsRes] = await Promise.all([
                    fetch(`${API_BASE}/portfolio`),
                    fetch(`${API_BASE}/dividends/portfolio`),
                    fetch(`${API_BASE}/wallets`)
                ]);
                const data = await portfolioRes.json();
                const divData = await dividendsRes.json();
                const walletsDataRes = await walletsRes.json();

                // ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø±Ù…Ø²
                portfolioDividends = {};
                if (divData.stocks) {
                    divData.stocks.forEach(s => {
                        portfolioDividends[s.symbol] = s.total_dividends || 0;
                    });
                }

                // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸
                walletsData = {};
                if (walletsDataRes.wallets) {
                    walletsDataRes.wallets.forEach(w => {
                        walletsData[w.wallet_id] = w;
                    });
                }

                renderPortfolio(data);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…Ù‚ÙÙ„Ø©
        let closedPositionsVisible = true;
        function toggleClosedPositions() {
            const content = document.getElementById('closedPositionsContent');
            const icon = document.getElementById('toggleClosedIcon');
            const text = document.getElementById('toggleClosedText');

            closedPositionsVisible = !closedPositionsVisible;

            if (closedPositionsVisible) {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                text.textContent = 'Ø¥Ø®ÙØ§Ø¡';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                text.textContent = 'Ø¥Ø¸Ù‡Ø§Ø±';
            }
        }

        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        let allOpenStocks = [];
        let walletsData = {};
        let walletVisibility = {};  // Ø­Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ù…Ø­ÙØ¸Ø©

        function renderPortfolio(data) {
            const container = document.getElementById('groupedStocksContainer');
            const emptyState = document.getElementById('emptyState');
            const closedCard = document.getElementById('closedPositionsCard');
            const closedBody = document.getElementById('closedPositionsBody');

            // ÙØµÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¹Ù† Ø§Ù„Ù…Ù‚ÙÙ„Ø©
            const openStocks = data.stocks.filter(s => s.shares > 0);
            const closedStocks = data.stocks.filter(s => s.shares === 0);

            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            allOpenStocks = openStocks;

            if (openStocks.length === 0 && closedStocks.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                closedCard.style.display = 'none';
                updateSummary({ total_cost: 0, total_value: 0, total_profit_loss: 0, total_profit_loss_percent: 0 }, 0, null);
                return;
            }

            emptyState.style.display = openStocks.length === 0 ? 'block' : 'none';
            document.getElementById('tableStockCount').textContent = `${openStocks.length} Ø£Ø³Ù‡Ù…`;

            let bestStock = openStocks.length > 0 ? openStocks[0] : null;
            openStocks.forEach(s => {
                if (bestStock && s.profit_loss_percent > bestStock.profit_loss_percent) bestStock = s;
            });

            const colors = [
                'linear-gradient(135deg, #1e293b, #334155)',
                'linear-gradient(135deg, #16a34a, #22c55e)',
                'linear-gradient(135deg, #0ea5e9, #38bdf8)',
                'linear-gradient(135deg, #eab308, #facc15)',
                'linear-gradient(135deg, #f97316, #fb923c)',
                'linear-gradient(135deg, #8b5cf6, #a78bfa)',
                'linear-gradient(135deg, #ec4899, #f472b6)'
            ];

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø©
            const stocksByWallet = {};
            openStocks.forEach(stock => {
                const walletId = stock.wallet_id || 'no_wallet';
                if (!stocksByWallet[walletId]) {
                    stocksByWallet[walletId] = [];
                }
                stocksByWallet[walletId].push(stock);
            });

            // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            updateChartWalletOptions(stocksByWallet);

            // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            let html = '';
            let colorIndex = 0;

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸ (Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø© Ø£Ø®ÙŠØ±Ø§Ù‹)
            const walletIds = Object.keys(stocksByWallet).sort((a, b) => {
                if (a === 'no_wallet') return 1;
                if (b === 'no_wallet') return -1;
                const nameA = walletsData[a]?.name || a;
                const nameB = walletsData[b]?.name || b;
                return nameA.localeCompare(nameB, 'ar');
            });

            walletIds.forEach(walletId => {
                const stocks = stocksByWallet[walletId];
                const walletInfo = walletsData[walletId] || {};
                const walletName = walletId === 'no_wallet' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø©' : (walletInfo.name || walletId);
                const brokerName = walletInfo.broker || '';

                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©
                let walletTotalCost = 0;
                let walletTotalValue = 0;
                let walletTotalDividends = 0;

                stocks.forEach(s => {
                    walletTotalCost += s.total_cost || 0;
                    walletTotalValue += s.current_value || 0;
                    walletTotalDividends += portfolioDividends[s.symbol] || 0;
                });

                const walletProfitLoss = walletTotalValue - walletTotalCost;
                const walletProfitLossPercent = walletTotalCost > 0 ? (walletProfitLoss / walletTotalCost) * 100 : 0;
                const walletProfitWithDividends = walletProfitLoss + walletTotalDividends;

                // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (walletVisibility[walletId] === undefined) {
                    walletVisibility[walletId] = true;
                }
                const isVisible = walletVisibility[walletId];

                html += `
                <div class="wallet-group" style="margin-bottom:20px;border:1px solid var(--border);border-radius:12px;overflow:hidden">
                    <div class="wallet-header" onclick="toggleWalletGroup('${walletId}')"
                         style="background:var(--bg-secondary);padding:16px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:${isVisible ? '1px solid var(--border)' : 'none'}">
                        <div style="display:flex;align-items:center;gap:12px">
                            <svg id="walletIcon_${walletId}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.3s;transform:rotate(${isVisible ? '0' : '-90'}deg)">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <div>
                                <span style="font-weight:600;font-size:1.1rem">${walletName}</span>
                                ${brokerName ? `<span style="color:var(--text-muted);font-size:0.85rem;margin-right:8px">(${brokerName})</span>` : ''}
                                <span style="background:var(--primary);color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;margin-right:8px">${stocks.length} Ø³Ù‡Ù…</span>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:20px">
                            <div style="text-align:left">
                                <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ù‚ÙŠÙ…Ø©</div>
                                <div style="font-weight:600">${formatNumber(walletTotalValue)} Ø±.Ø³</div>
                            </div>
                            <div style="text-align:left">
                                <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
                                <div class="${walletProfitWithDividends >= 0 ? 'positive' : 'negative'}" style="font-weight:600">
                                    ${walletProfitWithDividends >= 0 ? '+' : ''}${formatNumber(walletProfitWithDividends)} Ø±.Ø³
                                    <span style="font-size:0.85rem">(${walletProfitLossPercent >= 0 ? '+' : ''}${walletProfitLossPercent.toFixed(2)}%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="walletContent_${walletId}" style="display:${isVisible ? 'block' : 'none'}">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø³Ù‡Ù…</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                    <th>Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                    <th>Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</th>
                                    <th>Ø§Ù„Ø±Ø¨Ø­ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹</th>
                                    <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stocks.map((stock, i) => {
                                    const stockDividends = portfolioDividends[stock.symbol] || 0;
                                    const profitAfterDividends = stock.profit_loss + stockDividends;
                                    const profitAfterDividendsPercent = stock.total_cost > 0 ? (profitAfterDividends / stock.total_cost) * 100 : 0;
                                    const stockColorIndex = colorIndex + i;

                                    return `
                                    <tr>
                                        <td>
                                            <div class="stock-info">
                                                <div class="stock-logo" style="background:${colors[stockColorIndex % colors.length]}">${stock.name.substring(0, 2)}</div>
                                                <div>
                                                    <div class="stock-name">${stock.name}</div>
                                                    <div class="stock-code">${stock.symbol}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>${formatNumber(stock.shares, 0)}</td>
                                        <td>${formatNumber(stock.buy_price)} Ø±.Ø³</td>
                                        <td>${formatNumber(stock.current_price)} Ø±.Ø³</td>
                                        <td>${formatNumber(stock.current_value)} Ø±.Ø³</td>
                                        <td class="${stock.profit_loss >= 0 ? 'positive' : 'negative'}">${stock.profit_loss >= 0 ? '+' : ''}${formatNumber(stock.profit_loss)} Ø±.Ø³</td>
                                        <td class="positive">${stockDividends > 0 ? '+' + formatNumber(stockDividends) : '0.00'} Ø±.Ø³</td>
                                        <td class="${profitAfterDividends >= 0 ? 'positive' : 'negative'}" style="font-weight:700">${profitAfterDividends >= 0 ? '+' : ''}${formatNumber(profitAfterDividends)} Ø±.Ø³</td>
                                        <td class="${profitAfterDividendsPercent >= 0 ? 'positive' : 'negative'}">${profitAfterDividendsPercent >= 0 ? '+' : ''}${profitAfterDividendsPercent.toFixed(2)}%</td>
                                        <td>
                                            <button class="action-btn" onclick="openStockHistoryModal('${stock.symbol}', '${stock.name}')" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                </svg>
                                            </button>
                                            <button class="action-btn" onclick="openOrdersModal('${stock.symbol}', '${stock.name}')" title="Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 5v14M5 12h14"></path>
                                                </svg>
                                            </button>
                                            <button class="action-btn danger" onclick="deleteStock('${stock.symbol}')" title="Ø­Ø°Ù">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18"></path>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                colorIndex += stocks.length;
            });

            container.innerHTML = html;

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ù‚ÙÙ„Ø©
            if (closedStocks.length > 0) {
                closedCard.style.display = 'block';
                document.getElementById('closedPositionsCount').textContent = `${closedStocks.length} Ø³Ù‡Ù…`;

                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                closedStocks.sort((a, b) => {
                    const dateA = a.last_order_date || a.last_sell_date || '';
                    const dateB = b.last_order_date || b.last_sell_date || '';
                    return dateB.localeCompare(dateA);
                });

                closedBody.innerHTML = closedStocks.map((stock, i) => {
                    const stockDividends = portfolioDividends[stock.symbol] || 0;
                    const realizedPL = stock.realized_profit_loss || 0;
                    const totalPL = realizedPL + stockDividends;
                    const lastDate = stock.last_order_date || stock.last_sell_date || '-';

                    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    let totalBuys = 0;
                    let totalSells = 0;
                    if (stock.orders) {
                        stock.orders.forEach(o => {
                            if (o.order_type === 'buy') totalBuys += o.total_cost || (o.shares * o.price);
                            else totalSells += o.total_value || (o.shares * o.price);
                        });
                    }

                    return `
                    <tr style="background:${totalPL >= 0 ? 'var(--success-light)' : 'var(--danger-light)'}">
                        <td>
                            <div class="stock-info">
                                <div class="stock-logo" style="background:linear-gradient(135deg, #6b7280, #9ca3af)">${stock.name.substring(0, 2)}</div>
                                <div>
                                    <div class="stock-name">${stock.name}</div>
                                    <div class="stock-code">${stock.symbol}</div>
                                </div>
                            </div>
                        </td>
                        <td>${formatNumber(totalBuys)} Ø±.Ø³</td>
                        <td>${formatNumber(totalSells)} Ø±.Ø³</td>
                        <td class="positive">${stockDividends > 0 ? '+' + formatNumber(stockDividends) : '0.00'} Ø±.Ø³</td>
                        <td class="${totalPL >= 0 ? 'positive' : 'negative'}" style="font-weight:700">
                            ${totalPL >= 0 ? '+' : ''}${formatNumber(totalPL)} Ø±.Ø³
                        </td>
                        <td style="color:var(--text-muted)">${lastDate}</td>
                        <td>
                            <button class="action-btn" onclick="openStockHistoryModal('${stock.symbol}', '${stock.name}')" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </button>
                            <button class="action-btn" onclick="openOrdersModal('${stock.symbol}', '${stock.name}')" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø±Ø§Ø¡">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `}).join('');
            } else {
                closedCard.style.display = 'none';
            }

            updateSummary(data.summary, openStocks.length, bestStock);
            updateChart(openStocks);

            if (data.last_updated) {
                document.getElementById('updateTime').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date(data.last_updated).toLocaleString('ar-SA')}`;
            }
        }

        function updateSummary(summary, count, bestStock) {
            document.getElementById('totalCost').textContent = formatNumber(summary.total_cost);
            document.getElementById('totalValue').textContent = formatNumber(summary.total_value);
            document.getElementById('stockCount').textContent = count;

            const profitEl = document.getElementById('totalProfit');
            const profitPercentEl = document.getElementById('totalProfitPercent');

            profitEl.innerHTML = `${summary.total_profit_loss >= 0 ? '+' : ''}${formatNumber(summary.total_profit_loss)} <small>Ø±.Ø³</small>`;

            profitPercentEl.innerHTML = `<span>${summary.total_profit_loss_percent >= 0 ? '+' : ''}${summary.total_profit_loss_percent.toFixed(2)}%</span>`;
            profitPercentEl.className = summary.total_profit_loss_percent >= 0 ? 'change positive' : 'change negative';

            if (bestStock) {
                document.getElementById('bestStockName').textContent = bestStock.name;
                const bestReturn = document.getElementById('bestStockReturn');
                bestReturn.innerHTML = `<span class="${bestStock.profit_loss_percent >= 0 ? 'positive' : 'negative'}">${bestStock.profit_loss_percent >= 0 ? '+' : ''}${bestStock.profit_loss_percent.toFixed(2)}%</span>`;
            }
        }

        function updateChart(stocks) {
            const totalCost = stocks.reduce((sum, s) => sum + s.total_cost, 0);
            const totalValue = stocks.reduce((sum, s) => sum + s.current_value, 0);

            const data = [];
            for (let i = 0; i < 12; i++) {
                const factor = 0.85 + (Math.random() * 0.3);
                data.push(Math.round(totalCost * factor));
            }
            data[11] = totalValue;

            portfolioChart.data.datasets[0].data = data;
            portfolioChart.update();
        }

        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
        function toggleWalletGroup(walletId) {
            const content = document.getElementById(`walletContent_${walletId}`);
            const icon = document.getElementById(`walletIcon_${walletId}`);

            if (!content || !icon) return;

            walletVisibility[walletId] = !walletVisibility[walletId];

            if (walletVisibility[walletId]) {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                content.parentElement.querySelector('.wallet-header').style.borderBottom = '1px solid var(--border)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                content.parentElement.querySelector('.wallet-header').style.borderBottom = 'none';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙÙŠ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        function updateChartWalletOptions(stocksByWallet) {
            const select = document.getElementById('chartWalletFilter');
            if (!select) return;

            const currentValue = select.value;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            let options = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>';

            Object.keys(stocksByWallet).forEach(walletId => {
                const walletInfo = walletsData[walletId] || {};
                const walletName = walletId === 'no_wallet' ? 'Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø©' : (walletInfo.name || walletId);
                const stockCount = stocksByWallet[walletId].length;
                options += `<option value="${walletId}">${walletName} (${stockCount} Ø³Ù‡Ù…)</option>`;
            });

            select.innerHTML = options;

            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                select.value = currentValue;
            }
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ÙØ¸Ø©
        function filterChartByWallet() {
            const select = document.getElementById('chartWalletFilter');
            const selectedWallet = select.value;

            let filteredStocks;
            if (selectedWallet === 'all') {
                filteredStocks = allOpenStocks;
            } else {
                filteredStocks = allOpenStocks.filter(s => (s.wallet_id || 'no_wallet') === selectedWallet);
            }

            updateChart(filteredStocks);
        }

        async function loadAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/analysis/portfolio`);
                const data = await response.json();
                renderQuickAnalysis(data.analyses);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderQuickAnalysis(analyses) {
            const container = document.getElementById('quickAnalysis');
            if (!analyses || analyses.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding:40px"><p>Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠØ§Øª</p></div>';
                return;
            }

            document.getElementById('analysisBadge').textContent = analyses.filter(a => a.recommendation !== 'hold').length;

            container.innerHTML = analyses.slice(0, 4).map(a => {
                const badgeClass = a.recommendation === 'buy' ? 'buy' : a.recommendation === 'sell' ? 'sell' : 'hold';
                const badgeText = a.recommendation === 'buy' ? 'Ø´Ø±Ø§Ø¡' : a.recommendation === 'sell' ? 'Ø¨ÙŠØ¹' : 'Ø§Ø­ØªÙØ§Ø¸';

                return `
                    <div class="analysis-item">
                        <div class="analysis-header">
                            <div class="analysis-stock">
                                <div class="stock-avatar" style="background:linear-gradient(135deg, #1e293b, #334155);color:white">${(a.name || a.symbol).substring(0, 2)}</div>
                                <div>
                                    <div style="font-weight:600">${a.name || a.symbol}</div>
                                    <div style="font-size:0.8rem;color:var(--text-muted)">${a.current_price?.toFixed(2) || 0} Ø±.Ø³</div>
                                </div>
                            </div>
                            <span class="analysis-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="analysis-levels">
                            ${a.levels?.support?.[0] ? `<div class="level-item"><span class="level-dot support"></span>Ø¯Ø¹Ù…: ${a.levels.support[0]}</div>` : ''}
                            ${a.levels?.resistance?.[0] ? `<div class="level-item"><span class="level-dot resistance"></span>Ù…Ù‚Ø§ÙˆÙ…Ø©: ${a.levels.resistance[0]}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadFullAnalysis() {
            const container = document.getElementById('fullAnalysis');
            container.innerHTML = '<div class="empty-state"><h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</h3></div>';

            try {
                const response = await fetch(`${API_BASE}/analysis/portfolio`);
                const data = await response.json();

                if (!data.analyses || data.analyses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3></div>';
                    return;
                }

                container.innerHTML = `
                    <div class="stats-grid" style="margin-bottom:24px">
                        <div class="stat-card" style="background:var(--success-light);border-color:var(--success)">
                            <h4 style="color:var(--success)">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h4>
                            <div class="value" style="color:var(--success)">${data.analyses.filter(a => a.recommendation === 'buy').length}</div>
                        </div>
                        <div class="stat-card" style="background:var(--danger-light);border-color:var(--danger)">
                            <h4 style="color:var(--danger)">ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h4>
                            <div class="value" style="color:var(--danger)">${data.analyses.filter(a => a.recommendation === 'sell').length}</div>
                        </div>
                        <div class="stat-card" style="background:var(--warning-light);border-color:var(--warning)">
                            <h4 style="color:var(--warning)">Ø§Ø­ØªÙØ§Ø¸</h4>
                            <div class="value" style="color:var(--warning)">${data.analyses.filter(a => a.recommendation === 'hold').length}</div>
                        </div>
                    </div>
                    <div class="side-panels">
                        ${data.analyses.map(a => {
                            const badgeClass = a.recommendation === 'buy' ? 'buy' : a.recommendation === 'sell' ? 'sell' : 'hold';
                            const badgeText = a.recommendation === 'buy' ? 'Ø´Ø±Ø§Ø¡' : a.recommendation === 'sell' ? 'Ø¨ÙŠØ¹' : 'Ø§Ø­ØªÙØ§Ø¸';

                            return `
                                <div class="card">
                                    <div class="analysis-header" style="margin-bottom:16px">
                                        <div class="analysis-stock">
                                            <div class="stock-avatar" style="background:linear-gradient(135deg, #1e293b, #334155);color:white">${(a.name || a.symbol).substring(0, 2)}</div>
                                            <div>
                                                <div style="font-weight:600;font-size:1.1rem">${a.name || a.symbol}</div>
                                                <div style="color:var(--text-muted)">${a.symbol}</div>
                                            </div>
                                        </div>
                                        <span class="analysis-badge ${badgeClass}" style="font-size:0.9rem;padding:8px 16px">${badgeText}</span>
                                    </div>
                                    <div style="margin-bottom:16px">
                                        <p style="color:var(--text-secondary)">${a.message}</p>
                                    </div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                                        <div style="background:var(--bg-secondary);padding:14px;border-radius:12px">
                                            <div style="color:var(--text-muted);font-size:0.8rem;margin-bottom:4px">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                                            <div style="font-weight:600">${a.current_price?.toFixed(2) || 0} Ø±.Ø³</div>
                                        </div>
                                        <div style="background:var(--bg-secondary);padding:14px;border-radius:12px">
                                            <div style="color:var(--text-muted);font-size:0.8rem;margin-bottom:4px">Ø§Ù„Ø«Ù‚Ø©</div>
                                            <div style="font-weight:600">${a.confidence || 50}%</div>
                                        </div>
                                    </div>
                                    ${a.levels ? `
                                        <div style="display:flex;gap:12px">
                                            ${a.levels.support?.length ? `<div style="flex:1;background:var(--success-light);padding:12px;border-radius:10px">
                                                <div style="color:var(--success);font-size:0.8rem;margin-bottom:4px">Ø§Ù„Ø¯Ø¹Ù…</div>
                                                <div style="font-weight:600;color:var(--success)">${a.levels.support[0]}</div>
                                            </div>` : ''}
                                            ${a.levels.resistance?.length ? `<div style="flex:1;background:var(--danger-light);padding:12px;border-radius:10px">
                                                <div style="color:var(--danger);font-size:0.8rem;margin-bottom:4px">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©</div>
                                                <div style="font-weight:600;color:var(--danger)">${a.levels.resistance[0]}</div>
                                            </div>` : ''}
                                        </div>
                                    ` : ''}
                                    ${a.detailed_recommendations?.length ? `
                                        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                                            ${a.detailed_recommendations.map(r => `
                                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                                    <span style="width:8px;height:8px;border-radius:50%;background:${r.type.includes('sell') ? 'var(--danger)' : r.type.includes('buy') ? 'var(--success)' : 'var(--warning)'}"></span>
                                                    <span style="font-size:0.9rem">${r.reason}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3></div>';
            }
        }

        async function loadGlobalPrices() {
            const container = document.getElementById('globalPricesContainer');
            container.innerHTML = '<div class="empty-state" style="padding:40px"><h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©...</h3></div>';

            try {
                const response = await fetch(`${API_BASE}/global-prices`);
                const data = await response.json();

                // Categories mapping
                const categories = [
                    { key: 'energy', name: 'Ø§Ù„Ù†ÙØ· ÙˆØ§Ù„Ø·Ø§Ù‚Ø©', icon: 'ğŸ›¢ï¸' },
                    { key: 'precious_metals', name: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ø«Ù…ÙŠÙ†Ø©', icon: 'ğŸ¥‡' },
                    { key: 'industrial_metals', name: 'Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©', icon: 'âš™ï¸' },
                    { key: 'petrochemicals', name: 'Ø³Ù„Ø© Ø§Ù„Ø¨ØªØ±ÙˆÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª', icon: 'ğŸ­' },
                    { key: 'shipping', name: 'Ù†Ù‚Ù„ Ø§Ù„Ù†ÙØ·', icon: 'ğŸš¢' },
                    { key: 'refining', name: 'Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„ØªÙƒØ±ÙŠØ±', icon: 'â›½' },
                ];

                let html = '';

                categories.forEach(cat => {
                    const items = data[cat.key];
                    if (!items || items.length === 0) return;

                    html += `
                        <div style="margin-bottom:32px">
                            <h3 style="font-size:1.15rem;margin-bottom:16px;display:flex;align-items:center;gap:10px;padding-bottom:12px;border-bottom:2px solid var(--border)">
                                <span style="font-size:1.4rem">${cat.icon}</span> ${cat.name}
                            </h3>
                            <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:16px">
                                ${items.map(p => renderPriceCard(p)).join('')}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html || '<div class="empty-state"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</h3></div>';

                // Initialize sparklines
                initSparklines();

            } catch (error) {
                console.error('Error loading global prices:', error);
                container.innerHTML = '<div class="empty-state"><h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3><p>ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p><button class="btn btn-primary" onclick="loadGlobalPrices()" style="margin-top:16px">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button></div>';
            }
        }

        function renderPriceCard(p) {
            const isPositive = p.change_pct >= 0;
            const changeColor = isPositive ? '#10b981' : '#ef4444';
            const changeBg = isPositive ? '#10b98115' : '#ef444415';
            const arrow = isPositive ? 'â–²' : 'â–¼';
            const sparklineId = `sparkline_${p.symbol?.replace(/[^a-zA-Z0-9]/g, '_') || Math.random().toString(36).substr(2, 9)}`;

            return `
                <div class="price-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;border-right:4px solid ${changeColor};transition:all 0.2s"
                     onmouseover="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.1)';this.style.transform='translateY(-2px)'"
                     onmouseout="this.style.boxShadow='none';this.style.transform='translateY(0)'">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:1.6rem">${p.icon || 'ğŸ“Š'}</span>
                                <div>
                                    <div style="font-weight:700;font-size:1.05rem;color:var(--text)">${p.name}</div>
                                    <div style="font-size:0.8rem;color:var(--text-muted)">${p.name_en || ''}</div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:left">
                            <div style="font-size:1.5rem;font-weight:800;color:var(--text)">${formatPriceNumber(p.price)}</div>
                            <div style="font-size:0.8rem;color:var(--text-muted)">${p.unit || p.currency || 'USD'}</div>
                        </div>
                    </div>

                    ${p.sparkline && p.sparkline.length > 3 ? `
                        <div style="height:40px;margin:12px 0">
                            <canvas id="${sparklineId}" data-values="${JSON.stringify(p.sparkline)}" data-color="${changeColor}" style="width:100%;height:40px"></canvas>
                        </div>
                    ` : ''}

                    <div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid var(--border)">
                        <div style="display:flex;align-items:center;gap:10px">
                            <span style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:8px;font-size:0.9rem;font-weight:600;background:${changeBg};color:${changeColor}">
                                ${arrow} ${Math.abs(p.change_pct || 0).toFixed(2)}%
                            </span>
                            <span style="font-size:0.85rem;color:${changeColor};font-weight:500">
                                ${p.change >= 0 ? '+' : ''}${formatPriceNumber(p.change || 0)}
                            </span>
                        </div>
                        ${p.note ? `<span style="font-size:0.75rem;color:var(--text-muted);background:var(--bg-secondary);padding:3px 8px;border-radius:4px">${p.note}</span>` : ''}
                        ${p.market_state === 'REGULAR' ? '<span style="font-size:0.7rem;background:#10b98120;color:#10b981;padding:3px 8px;border-radius:4px">Ù…Ø¨Ø§Ø´Ø±</span>' : ''}
                    </div>

                    ${p.high_52w && p.low_52w ? `
                        <div style="margin-top:12px;padding-top:10px;border-top:1px dashed var(--border)">
                            <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted)">
                                <span>Ø£Ø¯Ù†Ù‰ 52 Ø£Ø³Ø¨ÙˆØ¹: ${formatPriceNumber(p.low_52w)}</span>
                                <span>Ø£Ø¹Ù„Ù‰ 52 Ø£Ø³Ø¨ÙˆØ¹: ${formatPriceNumber(p.high_52w)}</span>
                            </div>
                            <div style="margin-top:6px;height:4px;background:var(--bg-secondary);border-radius:2px;position:relative">
                                <div style="position:absolute;height:100%;background:linear-gradient(90deg, #ef4444, #f59e0b, #10b981);border-radius:2px;width:100%"></div>
                                <div style="position:absolute;width:8px;height:8px;background:var(--text);border-radius:50%;top:-2px;left:${Math.min(100, Math.max(0, ((p.price - p.low_52w) / (p.high_52w - p.low_52w)) * 100))}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function formatPriceNumber(num) {
            if (typeof num !== 'number') return num;
            if (num >= 1000) return num.toLocaleString('en-US', { maximumFractionDigits: 2 });
            if (num >= 100) return num.toFixed(2);
            if (num >= 1) return num.toFixed(2);
            return num.toFixed(4);
        }

        function initSparklines() {
            // Find all sparkline canvases and draw them
            document.querySelectorAll('canvas[id^="sparkline_"]').forEach(canvas => {
                try {
                    const values = JSON.parse(canvas.dataset.values || '[]');
                    const color = canvas.dataset.color || '#10b981';

                    if (values.length < 2) return;

                    const ctx = canvas.getContext('2d');
                    const width = canvas.offsetWidth;
                    const height = canvas.offsetHeight;

                    canvas.width = width * 2;
                    canvas.height = height * 2;
                    ctx.scale(2, 2);

                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const range = max - min || 1;

                    const stepX = width / (values.length - 1);

                    // Draw gradient fill
                    const gradient = ctx.createLinearGradient(0, 0, 0, height);
                    gradient.addColorStop(0, color + '40');
                    gradient.addColorStop(1, color + '00');

                    ctx.beginPath();
                    ctx.moveTo(0, height);

                    values.forEach((val, i) => {
                        const x = i * stepX;
                        const y = height - ((val - min) / range) * height * 0.85;
                        if (i === 0) ctx.lineTo(x, y);
                        else ctx.lineTo(x, y);
                    });

                    ctx.lineTo(width, height);
                    ctx.closePath();
                    ctx.fillStyle = gradient;
                    ctx.fill();

                    // Draw line
                    ctx.beginPath();
                    values.forEach((val, i) => {
                        const x = i * stepX;
                        const y = height - ((val - min) / range) * height * 0.85;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.stroke();

                    // Draw end point
                    const lastX = (values.length - 1) * stepX;
                    const lastY = height - ((values[values.length - 1] - min) / range) * height * 0.85;
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();

                } catch (e) {
                    console.error('Sparkline error:', e);
                }
            });
        }

        async function loadDividends() {
            const container = document.getElementById('dividendsContainer');
            container.innerHTML = '<div class="empty-state"><h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª...</h3></div>';

            try {
                const response = await fetch(`${API_BASE}/dividends/portfolio`);
                const data = await response.json();

                container.innerHTML = `
                    <div class="dividend-summary">
                        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h4>
                        <div class="amount">${formatNumber(data.total_dividends)} Ø±.Ø³</div>
                    </div>
                    ${data.stocks?.length ? data.stocks.map(s => `
                        <div class="card" style="margin-bottom:20px">
                            <div class="card-header">
                                <div style="display:flex;align-items:center;gap:12px">
                                    <div class="stock-avatar" style="background:linear-gradient(135deg, #1e293b, #334155);color:white">${s.name.substring(0, 2)}</div>
                                    <div>
                                        <h3 style="margin:0">${s.name}</h3>
                                        <div style="font-size:0.85rem;color:var(--text-muted)">${s.symbol} â€¢ ${s.shares} Ø³Ù‡Ù… â€¢ Ù…Ù†Ø° ${s.buy_date}</div>
                                    </div>
                                </div>
                                <div style="text-align:left">
                                    <div style="font-size:1.5rem;font-weight:700;color:var(--success)">${formatNumber(s.total_dividends)} Ø±.Ø³</div>
                                    <div style="font-size:0.85rem;color:var(--text-muted)">${s.dividend_count} ØªÙˆØ²ÙŠØ¹Ø§Øª</div>
                                </div>
                            </div>
                            ${s.dividends?.length ? `
                                <div style="margin-top:16px">
                                    <table style="width:100%;border-collapse:collapse">
                                        <thead>
                                            <tr style="background:var(--bg-secondary)">
                                                <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted);font-size:0.85rem">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted);font-size:0.85rem">Ø§Ù„Ù†ÙˆØ¹</th>
                                                <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted);font-size:0.85rem">Ù„Ù„Ø³Ù‡Ù…</th>
                                                <th style="padding:12px;text-align:right;font-weight:500;color:var(--text-muted);font-size:0.85rem">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${s.dividends.map(d => `
                                                <tr style="border-bottom:1px solid var(--border)">
                                                    <td style="padding:12px">${d.date}</td>
                                                    <td style="padding:12px"><span style="background:var(--success-light);color:var(--success);padding:4px 10px;border-radius:6px;font-size:0.8rem">${d.type}</span></td>
                                                    <td style="padding:12px">${d.amount_per_share} Ø±.Ø³</td>
                                                    <td style="padding:12px;font-weight:600;color:var(--success)">${formatNumber(d.total_amount)} Ø±.Ø³</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p style="text-align:center;color:var(--text-muted);padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ù‡Ù…</p>'}
                            ${s.upcoming ? `
                                <div style="margin-top:16px;padding:16px;background:var(--info-light);border-radius:12px;border:1px solid var(--info)">
                                    <div style="display:flex;justify-content:space-between;align-items:center">
                                        <div>
                                            <div style="font-weight:600;color:var(--info)">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                                            <div style="font-size:0.85rem;color:var(--text-secondary)">${s.upcoming.expected_next_date} â€¢ ${s.upcoming.dividend_type}</div>
                                        </div>
                                        <div style="font-weight:700;color:var(--info)">${s.upcoming.expected_amount} Ø±.Ø³ Ù„Ù„Ø³Ù‡Ù…</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : '<div class="empty-state" style="padding:30px"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ²ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>'}
                `;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h3></div>';
            }
        }

        async function refreshPrices() {
            document.getElementById('loading').classList.add('active');
            try {
                const response = await fetch(`${API_BASE}/refresh-prices`, { method: 'POST' });
                const data = await response.json();
                renderPortfolio(data);
                loadAnalysis();
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±');
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('symbol').value = '';
            document.getElementById('stockName').value = '';
            document.getElementById('shares').value = '100';
            document.getElementById('buyPrice').value = '';
            document.getElementById('stockWallet').value = '';
            document.getElementById('stockInfo').style.display = 'none';
            document.getElementById('stockHint').textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©';
            document.getElementById('stockHint').className = 'stock-hint';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addStockForm').reset();
            document.getElementById('buyDate').valueAsDate = new Date();
        }

        async function addStock(event) {
            event.preventDefault();
            const walletId = document.getElementById('stockWallet').value;
            const commission = document.getElementById('commission').value;
            const tax = document.getElementById('tax').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)
            if (!walletId) {
                alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù‡Ù…');
                document.getElementById('stockWallet').focus();
                return;
            }

            const shares = parseFloat(document.getElementById('shares').value);
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const totalValue = shares * buyPrice;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©
            let totalCost = totalValue;
            if (commission) {
                totalCost += parseFloat(commission) + (tax ? parseFloat(tax) : 0);
            } else {
                // Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©
                const autoCommission = totalValue * commissionSettings.commission_rate;
                const autoTax = autoCommission * commissionSettings.tax_rate;
                totalCost += autoCommission + autoTax;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§ÙÙŠ
            const selectedWallet = allWallets.find(w => w.wallet_id === walletId);
            if (selectedWallet && selectedWallet.buying_power < totalCost) {
                const shortage = totalCost - selectedWallet.buying_power;
                alert(`Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ!\n\nØ§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${formatNumber(totalCost)} Ø±.Ø³\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: ${formatNumber(selectedWallet.buying_power)} Ø±.Ø³\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ø§Ù‚Øµ: ${formatNumber(shortage)} Ø±.Ø³\n\nÙŠØ±Ø¬Ù‰ Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹.`);
                return;
            }

            const stockData = {
                symbol: document.getElementById('symbol').value,
                name: document.getElementById('stockName').value,
                shares: shares,
                buy_price: buyPrice,
                buy_date: document.getElementById('buyDate').value,
                wallet_id: walletId
            };

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
            if (commission) {
                stockData.commission = parseFloat(commission);
            }
            if (tax) {
                stockData.tax = parseFloat(tax);
            }

            try {
                const response = await fetch(`${API_BASE}/stocks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(stockData)
                });
                if (response.ok) {
                    closeAddModal();
                    loadPortfolio();
                    loadAnalysis();
                    loadWalletsForSelect(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù‡Ù…');
            }
        }

        async function deleteStock(symbol) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ù‡Ù…ØŸ')) return;
            try {
                await fetch(`${API_BASE}/stocks/${encodeURIComponent(symbol)}`, { method: 'DELETE' });
                loadPortfolio();
                loadAnalysis();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function openOrdersModal(symbol, name) {
            currentOrderSymbol = symbol;
            document.getElementById('ordersModalTitle').textContent = `Ø£ÙˆØ§Ù…Ø± ${name}`;
            document.getElementById('orderSymbol').value = symbol;
            document.getElementById('orderDate').valueAsDate = new Date();
            document.getElementById('ordersModal').classList.add('active');
            selectOrderType('buy');
            switchTab('add-order');
            await loadStockOrders(symbol);
        }

        function closeOrdersModal() {
            document.getElementById('ordersModal').classList.remove('active');
        }

        async function loadStockOrders(symbol) {
            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/orders`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('summaryShares').textContent = formatNumber(data.summary.shares, 0);
                    document.getElementById('summaryAvgPrice').textContent = formatNumber(data.summary.buy_price) + ' Ø±.Ø³';
                    document.getElementById('summaryTotalCost').textContent = formatNumber(data.summary.total_cost) + ' Ø±.Ø³';
                    renderOrdersList(data.orders);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderOrdersList(orders) {
            const container = document.getElementById('ordersList');
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:24px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø±</p>';
                return;
            }
            container.innerHTML = orders.map(order => `
                <div class="order-item ${order.order_type}">
                    <div>
                        <div class="order-type-label ${order.order_type}">${order.order_type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</div>
                        <div style="font-size:0.9rem;color:var(--text-secondary);margin-top:4px">${formatNumber(order.shares, 0)} Ø³Ù‡Ù… Ã— ${formatNumber(order.price)} = ${formatNumber(order.shares * order.price)} Ø±.Ø³</div>
                        <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px">${order.date}</div>
                    </div>
                    <button class="action-btn danger" onclick="deleteOrder('${order.order_id}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-tab')[tabName === 'add-order' ? 0 : 1].classList.add('active');
            document.getElementById('add-order-tab').style.display = tabName === 'add-order' ? 'block' : 'none';
            document.getElementById('orders-list-tab').style.display = tabName === 'orders-list' ? 'block' : 'none';
        }

        function selectOrderType(type) {
            document.getElementById('orderType').value = type;
            document.querySelectorAll('.order-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.order-type-btn')[type === 'buy' ? 0 : 1].classList.add('active');
            document.getElementById('orderSubmitBtn').textContent = type === 'buy' ? 'Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø± Ø´Ø±Ø§Ø¡' : 'Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø± Ø¨ÙŠØ¹';
            document.getElementById('orderSubmitBtn').style.background = type === 'buy' ? 'var(--success)' : 'var(--danger)';
        }

        async function submitOrder(event) {
            event.preventDefault();
            const walletId = document.getElementById('orderWallet').value;
            const commission = document.getElementById('orderCommission').value;
            const tax = document.getElementById('orderTax').value;
            const orderType = document.getElementById('orderType').value;
            const shares = parseFloat(document.getElementById('orderShares').value);
            const price = parseFloat(document.getElementById('orderPrice').value);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)
            if (!walletId) {
                alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù…Ø±');
                document.getElementById('orderWallet').focus();
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§ÙÙŠ (ÙÙ‚Ø· Ù„Ù„Ø´Ø±Ø§Ø¡)
            if (orderType === 'buy') {
                const totalValue = shares * price;
                let totalCost = totalValue;

                if (commission) {
                    totalCost += parseFloat(commission) + (tax ? parseFloat(tax) : 0);
                } else {
                    const autoCommission = totalValue * commissionSettings.commission_rate;
                    const autoTax = autoCommission * commissionSettings.tax_rate;
                    totalCost += autoCommission + autoTax;
                }

                const selectedWallet = allWallets.find(w => w.wallet_id === walletId);
                if (selectedWallet && selectedWallet.buying_power < totalCost) {
                    const shortage = totalCost - selectedWallet.buying_power;
                    alert(`Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ!\n\nØ§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${formatNumber(totalCost)} Ø±.Ø³\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: ${formatNumber(selectedWallet.buying_power)} Ø±.Ø³\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ø§Ù‚Øµ: ${formatNumber(shortage)} Ø±.Ø³\n\nÙŠØ±Ø¬Ù‰ Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹.`);
                    return;
                }
            }

            const orderData = {
                order_type: orderType,
                shares: shares,
                price: price,
                date: document.getElementById('orderDate').value,
                wallet_id: walletId
            };

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
            if (commission) {
                orderData.commission = parseFloat(commission);
            }
            if (tax) {
                orderData.tax = parseFloat(tax);
            }

            try {
                const response = await fetch(`${API_BASE}/stocks/${currentOrderSymbol}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (response.ok) {
                    document.getElementById('orderForm').reset();
                    document.getElementById('orderDate').valueAsDate = new Date();
                    document.getElementById('orderFeesPreview').style.display = 'none';
                    await loadStockOrders(currentOrderSymbol);
                    loadPortfolio();
                    loadAnalysis();
                    loadWalletsForSelect(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©
                } else {
                    const error = await response.json();
                    alert(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±ØŸ')) return;
            try {
                await fetch(`${API_BASE}/stocks/${currentOrderSymbol}/orders/${orderId}`, { method: 'DELETE' });
                await loadStockOrders(currentOrderSymbol);
                loadPortfolio();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function formatNumber(num, decimals = 2) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num || 0);
        }

        // ===== Commission Settings =====
        let commissionSettings = {
            commission_rate: 0.00155,
            tax_rate: 0.15
        };

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
        async function loadCommissionSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                if (response.ok) {
                    const data = await response.json();
                    commissionSettings = {
                        commission_rate: data.commission_rate,
                        tax_rate: data.tax_rate
                    };
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ…
        async function calculateFees(formType) {
            let shares, price, previewContainer;

            if (formType === 'add') {
                shares = parseFloat(document.getElementById('shares').value) || 0;
                price = parseFloat(document.getElementById('buyPrice').value) || 0;
                previewContainer = document.getElementById('feesPreview');
            } else {
                shares = parseFloat(document.getElementById('orderShares').value) || 0;
                price = parseFloat(document.getElementById('orderPrice').value) || 0;
                previewContainer = document.getElementById('orderFeesPreview');
            }

            if (shares <= 0 || price <= 0) {
                previewContainer.style.display = 'none';
                return;
            }

            const totalValue = shares * price;
            const commission = totalValue * commissionSettings.commission_rate;
            const tax = commission * commissionSettings.tax_rate;
            const orderType = formType === 'order' ? document.getElementById('orderType').value : 'buy';
            const grandTotal = orderType === 'buy'
                ? totalValue + commission + tax
                : totalValue - commission - tax;

            if (formType === 'add') {
                document.getElementById('totalValuePreview').textContent = `${formatNumber(totalValue)} Ø±.Ø³`;
                document.getElementById('commissionPreview').textContent = `${formatNumber(commission)} Ø±.Ø³`;
                document.getElementById('taxPreview').textContent = `${formatNumber(tax)} Ø±.Ø³`;
                document.getElementById('grandTotalPreview').textContent = `${formatNumber(grandTotal)} Ø±.Ø³`;
            } else {
                document.getElementById('orderTotalValuePreview').textContent = `${formatNumber(totalValue)} Ø±.Ø³`;
                document.getElementById('orderCommissionPreview').textContent = `${formatNumber(commission)} Ø±.Ø³`;
                document.getElementById('orderTaxPreview').textContent = `${formatNumber(tax)} Ø±.Ø³`;
                document.getElementById('orderGrandTotalPreview').textContent = `${formatNumber(grandTotal)} Ø±.Ø³`;
                document.getElementById('orderGrandTotalLabel').textContent = orderType === 'buy'
                    ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:'
                    : 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…:';
            }

            previewContainer.style.display = 'block';
        }

        // ===== Speculative Trading Functions =====
        let speculativeChart = null;

        async function loadSpeculativeData() {
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ© ÙÙ‚Ø·
            try {
                const portfolioResponse = await fetch(`${API_BASE}/portfolio/by-strategy/speculative`);
                if (portfolioResponse.ok) {
                    const portfolioData = await portfolioResponse.json();
                    const ownedStocks = portfolioData.stocks.filter(s => s.shares > 0);

                    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠ
                    document.getElementById('specCapital').textContent = formatNumber(portfolioData.summary.total_value) + ' Ø±.Ø³';
                    document.getElementById('openTrades').textContent = ownedStocks.length;
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©
                const walletsResponse = await fetch(`${API_BASE}/wallets/by-strategy/speculative`);
                if (walletsResponse.ok) {
                    const walletsData = await walletsResponse.json();
                    const totalBuyingPower = walletsData.wallets.reduce((sum, w) => sum + (w.buying_power || 0), 0);
                    // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                }
            } catch (error) {
                console.error('Error loading speculative data:', error);
            }

            // Update stats
            document.getElementById('todayTrades').textContent = '0';
            document.getElementById('todayProfit').innerHTML = '0.00 <small>Ø±.Ø³</small>';
            document.getElementById('successRate').textContent = '0%';
            document.getElementById('avgTradeTime').innerHTML = '0 <small>Ø¯Ù‚ÙŠÙ‚Ø©</small>';

            // Load signals for speculative wallets
            await scanSignalsSpeculative();
            // Load momentum stocks for speculative wallets
            await scanMomentumSpeculative();
            // Load volume leaders
            await loadVolumeLeaders();
            // Detect breakouts
            await detectBreakouts();
        }

        async function scanSignalsSpeculative() {
            const container = document.getElementById('signalScanner');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</div>';

            try {
                const response = await fetch(`${API_BASE}/portfolio/by-strategy/speculative`);
                const data = await response.json();

                if (!data.stocks || data.stocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</div>';
                    return;
                }

                const ownedStocks = data.stocks.filter(s => s.shares > 0);
                if (ownedStocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù…Ù…Ù„ÙˆÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</div>';
                    return;
                }

                container.innerHTML = ownedStocks.map(s => {
                    const isProfit = s.profit_loss >= 0;
                    const signalType = isProfit ? 'Ø±Ø¨Ø­' : 'Ø®Ø³Ø§Ø±Ø©';
                    const signalColor = isProfit ? 'var(--success)' : 'var(--danger)';
                    const signalBg = isProfit ? 'var(--success-light)' : 'var(--danger-light)';

                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:${signalBg};border-radius:10px;margin-bottom:8px">
                            <div>
                                <div style="font-weight:600">${s.name || s.symbol}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted)">${s.current_price?.toFixed(2) || 0} Ø±.Ø³ Ã— ${s.shares} Ø³Ù‡Ù…</div>
                            </div>
                            <div style="text-align:left">
                                <span style="background:${signalColor};color:white;padding:4px 12px;border-radius:6px;font-size:0.8rem">${signalType}</span>
                                <div style="font-size:0.75rem;color:${signalColor};margin-top:4px;font-weight:600">${s.profit_loss_percent?.toFixed(2) || 0}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­</div>';
            }
        }

        async function scanMomentumSpeculative() {
            const container = document.getElementById('momentumStocks');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

            try {
                const response = await fetch(`${API_BASE}/portfolio/by-strategy/speculative`);
                const data = await response.json();

                if (!data.stocks || data.stocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</div>';
                    return;
                }

                // Sort by profit/loss percentage to find momentum stocks
                const momentumStocks = data.stocks
                    .filter(s => s.profit_loss_percent !== 0 && s.shares > 0)
                    .sort((a, b) => Math.abs(b.profit_loss_percent) - Math.abs(a.profit_loss_percent))
                    .slice(0, 5);

                if (momentumStocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¨Ø²Ø®Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø¶Ø§Ø±Ø¨ÙŠØ©</div>';
                    return;
                }

                container.innerHTML = momentumStocks.map(s => {
                    const isPositive = s.profit_loss_percent >= 0;
                    const color = isPositive ? 'var(--success)' : 'var(--danger)';
                    const arrow = isPositive ? 'â†‘' : 'â†“';

                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;border:1px solid var(--border)">
                            <div>
                                <div style="font-weight:600">${s.name}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted)">${s.current_price?.toFixed(2) || 0} Ø±.Ø³</div>
                            </div>
                            <div style="color:${color};font-weight:700">
                                ${arrow} ${Math.abs(s.profit_loss_percent).toFixed(2)}%
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
            }
        }

        async function scanSignals() {
            const container = document.getElementById('signalScanner');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</div>';

            try {
                const response = await fetch(`${API_BASE}/analysis/portfolio`);
                const data = await response.json();

                if (!data.analyses || data.analyses.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„Ù…Ø³Ø­</div>';
                    return;
                }

                const signals = data.analyses.filter(a => a.recommendation !== 'hold');

                if (signals.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                    return;
                }

                container.innerHTML = signals.map(s => {
                    const signalType = s.recommendation === 'buy' ? 'ØµØ¹ÙˆØ¯' : 'Ù‡Ø¨ÙˆØ·';
                    const signalColor = s.recommendation === 'buy' ? 'var(--success)' : 'var(--danger)';
                    const signalBg = s.recommendation === 'buy' ? 'var(--success-light)' : 'var(--danger-light)';

                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:${signalBg};border-radius:10px;margin-bottom:8px">
                            <div>
                                <div style="font-weight:600">${s.name || s.symbol}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted)">${s.current_price?.toFixed(2) || 0} Ø±.Ø³</div>
                            </div>
                            <div style="text-align:left">
                                <span style="background:${signalColor};color:white;padding:4px 12px;border-radius:6px;font-size:0.8rem">${signalType}</span>
                                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">${s.confidence || 50}% Ø«Ù‚Ø©</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­</div>';
            }
        }

        async function scanMomentum() {
            const container = document.getElementById('momentumStocks');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

            try {
                const response = await fetch(`${API_BASE}/portfolio`);
                const data = await response.json();

                if (!data.stocks || data.stocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>';
                    return;
                }

                // Sort by profit/loss percentage to find momentum stocks
                const momentumStocks = data.stocks
                    .filter(s => s.profit_loss_percent !== 0)
                    .sort((a, b) => Math.abs(b.profit_loss_percent) - Math.abs(a.profit_loss_percent))
                    .slice(0, 5);

                if (momentumStocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø¨Ø²Ø®Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                    return;
                }

                container.innerHTML = momentumStocks.map(s => {
                    const isPositive = s.profit_loss_percent >= 0;
                    const color = isPositive ? 'var(--success)' : 'var(--danger)';
                    const arrow = isPositive ? 'â†‘' : 'â†“';

                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;border:1px solid var(--border)">
                            <div>
                                <div style="font-weight:600">${s.name}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted)">${s.current_price?.toFixed(2) || 0} Ø±.Ø³</div>
                            </div>
                            <div style="color:${color};font-weight:700">
                                ${arrow} ${Math.abs(s.profit_loss_percent).toFixed(2)}%
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>';
            }
        }

        async function loadVolumeLeaders() {
            const container = document.getElementById('volumeLeaders');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            try {
                const response = await fetch(`${API_BASE}/portfolio`);
                const data = await response.json();

                if (!data.stocks || data.stocks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>';
                    return;
                }

                // Sort by total value as proxy for volume activity
                const volumeStocks = data.stocks
                    .sort((a, b) => b.current_value - a.current_value)
                    .slice(0, 5);

                container.innerHTML = volumeStocks.map((s, i) => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;border:1px solid var(--border)">
                        <div style="display:flex;align-items:center;gap:12px">
                            <span style="background:var(--info-light);color:var(--info);width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">${i + 1}</span>
                            <div>
                                <div style="font-weight:600">${s.name}</div>
                                <div style="font-size:0.85rem;color:var(--text-muted)">${s.shares} Ø³Ù‡Ù…</div>
                            </div>
                        </div>
                        <div style="text-align:left">
                            <div style="font-weight:600">${formatNumber(s.current_value)} Ø±.Ø³</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
            }
        }

        async function detectBreakouts() {
            const container = document.getElementById('breakoutStocks');
            container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ´Ù...</div>';

            try {
                const response = await fetch(`${API_BASE}/analysis/portfolio`);
                const data = await response.json();

                if (!data.analyses || data.analyses.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ø£Ø¶Ù Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>';
                    return;
                }

                // Find stocks near support or resistance levels
                const breakouts = data.analyses.filter(a => {
                    if (!a.levels || !a.current_price) return false;
                    const price = a.current_price;
                    const resistance = a.levels.resistance?.[0];
                    const support = a.levels.support?.[0];

                    // Check if price is within 3% of support or resistance
                    const nearResistance = resistance && Math.abs(price - resistance) / resistance < 0.03;
                    const nearSupport = support && Math.abs(price - support) / support < 0.03;

                    return nearResistance || nearSupport;
                });

                if (breakouts.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ±Ø§Ù‚Ø§Øª Ù…ØªÙˆÙ‚Ø¹Ø©</div>';
                    return;
                }

                container.innerHTML = breakouts.map(b => {
                    const price = b.current_price;
                    const resistance = b.levels.resistance?.[0];
                    const support = b.levels.support?.[0];
                    const nearResistance = resistance && Math.abs(price - resistance) / resistance < 0.03;

                    return `
                        <div style="padding:12px;background:${nearResistance ? 'var(--danger-light)' : 'var(--success-light)'};border-radius:10px;margin-bottom:8px">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <div>
                                    <div style="font-weight:600">${b.name || b.symbol}</div>
                                    <div style="font-size:0.85rem;color:var(--text-muted)">${price?.toFixed(2)} Ø±.Ø³</div>
                                </div>
                                <div style="text-align:left">
                                    <span style="background:${nearResistance ? 'var(--danger)' : 'var(--success)'};color:white;padding:4px 10px;border-radius:6px;font-size:0.8rem">
                                        ${nearResistance ? 'Ù‚Ø±Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©' : 'Ù‚Ø±Ø¨ Ø§Ù„Ø¯Ø¹Ù…'}
                                    </span>
                                    <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">
                                        ${nearResistance ? resistance?.toFixed(2) : support?.toFixed(2)} Ø±.Ø³
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ´Ù</div>';
            }
        }

        function calculateTrade() {
            const entry = parseFloat(document.getElementById('calcEntryPrice').value) || 0;
            const quantity = parseFloat(document.getElementById('calcQuantity').value) || 0;
            const target = parseFloat(document.getElementById('calcTargetPrice').value) || 0;

            const total = entry * quantity;
            const profit = (target - entry) * quantity;
            const profitPercent = entry > 0 ? ((target - entry) / entry * 100) : 0;
            const stopLoss = entry * 0.97; // 3% stop loss

            document.getElementById('calcTotal').textContent = formatNumber(total) + ' Ø±.Ø³';
            document.getElementById('calcProfit').textContent = (profit >= 0 ? '+' : '') + formatNumber(profit) + ' Ø±.Ø³';
            document.getElementById('calcPercent').textContent = (profitPercent >= 0 ? '+' : '') + profitPercent.toFixed(2) + '%';
            document.getElementById('calcStopLoss').textContent = formatNumber(stopLoss);
        }

        function openAlertModal() {
            alert('Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        // ===== Long Term Investment Functions =====
        async function loadLongTermData() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰
                const portfolioResponse = await fetch(`${API_BASE}/portfolio/by-strategy/long_term`);
                if (portfolioResponse.ok) {
                    const portfolioData = await portfolioResponse.json();
                    const ownedStocks = portfolioData.stocks.filter(s => s.shares > 0);

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    document.getElementById('longTermValue').innerHTML = `${formatNumber(portfolioData.summary.total_value)} <small>Ø±.Ø³</small>`;

                    const profitLoss = portfolioData.summary.total_profit_loss;
                    const profitColor = profitLoss >= 0 ? 'var(--success)' : 'var(--danger)';
                    document.getElementById('longTermProfit').innerHTML = `<span style="color:${profitColor}">${profitLoss >= 0 ? '+' : ''}${formatNumber(profitLoss)}</span> <small>Ø±.Ø³</small>`;

                    document.getElementById('longTermStocksCount').innerHTML = `${ownedStocks.length} <small>Ø³Ù‡Ù…</small>`;

                    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù‡Ù…
                    renderLongTermStocks(ownedStocks);
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©
                const walletsResponse = await fetch(`${API_BASE}/wallets/by-strategy/long_term`);
                if (walletsResponse.ok) {
                    const walletsData = await walletsResponse.json();
                    renderLongTermWallets(walletsData.wallets);
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©
                const dividendsResponse = await fetch(`${API_BASE}/dividends/portfolio`);
                if (dividendsResponse.ok) {
                    const dividendsData = await dividendsResponse.json();
                    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ÙˆØ²Ø¹Ø© Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© ÙÙ‚Ø·
                    const totalDividends = dividendsData.total_dividends || 0;
                    document.getElementById('longTermDividends').innerHTML = `${formatNumber(totalDividends)} <small>Ø±.Ø³</small>`;
                }
            } catch (error) {
                console.error('Error loading long term data:', error);
            }
        }

        function renderLongTermStocks(stocks) {
            const container = document.getElementById('longTermStocksList');

            if (!stocks || stocks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <div style="font-size:3rem;margin-bottom:16px">ğŸ¦</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
                        <p style="color:var(--text-muted);margin-top:8px">Ø£Ø¶Ù Ù…Ø­ÙØ¸Ø© Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰ Ù…Ù† Ø´Ø§Ø´Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
                    <thead>
                        <tr style="border-bottom:2px solid var(--border)">
                            <th style="padding:12px;text-align:right">Ø§Ù„Ø³Ù‡Ù…</th>
                            <th style="padding:12px;text-align:center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th style="padding:12px;text-align:center">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                            <th style="padding:12px;text-align:center">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                            <th style="padding:12px;text-align:center">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            <th style="padding:12px;text-align:left">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stocks.map(s => {
                            const isProfit = s.profit_loss >= 0;
                            const profitColor = isProfit ? 'var(--success)' : 'var(--danger)';

                            return `
                                <tr style="border-bottom:1px solid var(--border)">
                                    <td style="padding:12px">
                                        <div style="font-weight:600">${s.name}</div>
                                        <div style="font-size:0.8rem;color:var(--text-muted)">${s.symbol}</div>
                                    </td>
                                    <td style="padding:12px;text-align:center">${s.shares}</td>
                                    <td style="padding:12px;text-align:center">${formatNumber(s.avg_buy_price)} Ø±.Ø³</td>
                                    <td style="padding:12px;text-align:center">${formatNumber(s.current_price)} Ø±.Ø³</td>
                                    <td style="padding:12px;text-align:center">${formatNumber(s.current_value)} Ø±.Ø³</td>
                                    <td style="padding:12px;text-align:left">
                                        <div style="color:${profitColor};font-weight:600">${isProfit ? '+' : ''}${formatNumber(s.profit_loss)} Ø±.Ø³</div>
                                        <div style="font-size:0.8rem;color:${profitColor}">${isProfit ? '+' : ''}${s.profit_loss_percent?.toFixed(2) || 0}%</div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderLongTermWallets(wallets) {
            const container = document.getElementById('longTermWalletsList');

            if (!wallets || wallets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰</p>
                        <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px">Ø£Ø¶Ù Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ø®ØªØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© "Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø¨Ø¹ÙŠØ¯Ø© Ø§Ù„Ù…Ø¯Ù‰"</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:16px">
                    ${wallets.map(w => `
                        <div style="background:var(--bg-secondary);padding:20px;border-radius:12px;border:1px solid var(--border)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:1.5rem">ğŸ¦</span>
                                    <div>
                                        <div style="font-weight:600">${w.name}</div>
                                        <div style="font-size:0.8rem;color:var(--text-muted)">${w.broker || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                    </div>
                                </div>
                                <span style="background:var(--success-light);color:var(--success);padding:4px 10px;border-radius:20px;font-size:0.75rem">Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid var(--border)">
                                <div>
                                    <div style="font-size:0.8rem;color:var(--text-muted)">Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</div>
                                    <div style="font-weight:600;color:var(--success)">${formatNumber(w.buying_power)} Ø±.Ø³</div>
                                </div>
                                ${w.account_number ? `
                                <div style="text-align:left">
                                    <div style="font-size:0.8rem;color:var(--text-muted)">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
                                    <div style="font-weight:600">${w.account_number}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ===== Performance Measurement Functions =====
        let performanceChart = null;
        let sectorChart = null;

        async function loadPerformanceData() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ù…Ù„Ø©
                if (walletsWithStocksData.length === 0) {
                    await loadWalletsDataOnly();
                }

                const response = await fetch(`${API_BASE}/portfolio`);
                const data = await response.json();

                if (!data.stocks || data.stocks.length === 0) {
                    return;
                }

                // Calculate performance metrics
                const totalCost = data.summary.total_cost;
                const totalValue = data.summary.total_value;
                const totalReturn = data.summary.total_profit_loss;
                const totalReturnPercent = data.summary.total_profit_loss_percent;

                // Update summary cards
                document.getElementById('totalReturn').textContent = `${totalReturnPercent >= 0 ? '+' : ''}${totalReturnPercent.toFixed(2)}%`;
                document.getElementById('totalReturnAmount').textContent = `${totalReturn >= 0 ? '+' : ''}${formatNumber(totalReturn)} Ø±.Ø³`;
                document.getElementById('totalReturnAmount').className = totalReturn >= 0 ? 'change positive' : 'change negative';

                // Estimate annual return (assuming 1 year holding)
                document.getElementById('annualReturn').textContent = `${totalReturnPercent >= 0 ? '+' : ''}${totalReturnPercent.toFixed(2)}%`;

                // Calculate max drawdown (simplified - using worst stock)
                const worstStock = data.stocks.reduce((min, s) => s.profit_loss_percent < min.profit_loss_percent ? s : min, data.stocks[0]);
                const maxDrawdown = Math.min(0, worstStock.profit_loss_percent);
                document.getElementById('maxDrawdown').textContent = `${maxDrawdown.toFixed(2)}%`;

                // Sharpe ratio (simplified calculation)
                const avgReturn = totalReturnPercent;
                const riskFreeRate = 5.5; // Saudi risk-free rate approximation
                const volatility = Math.abs(worstStock.profit_loss_percent - totalReturnPercent);
                const sharpeRatio = volatility > 0 ? ((avgReturn - riskFreeRate) / volatility).toFixed(2) : 'N/A';
                document.getElementById('sharpeRatio').textContent = sharpeRatio;

                // Load charts
                initPerformanceChart(data.stocks);
                initSectorChart(data.stocks);

                // Load monthly returns
                loadMonthlyReturns(data.stocks);

                // Load best/worst performers
                loadPerformers(data.stocks);

                // Calculate risk metrics
                calculateRiskMetrics(data);

                // Benchmark comparison
                loadBenchmarkComparison(data);

            } catch (error) {
                console.error('Error loading performance data:', error);
            }
        }

        function initPerformanceChart(stocks) {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            if (performanceChart) {
                performanceChart.destroy();
            }

            const totalCost = stocks.reduce((sum, s) => sum + s.total_cost, 0);
            const totalValue = stocks.reduce((sum, s) => sum + s.current_value, 0);

            // Generate simulated historical data
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
            const performanceData = [];
            for (let i = 0; i < 12; i++) {
                const factor = 0.85 + (Math.random() * 0.3);
                performanceData.push(Math.round(totalCost * factor));
            }
            performanceData[11] = totalValue;

            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 280);
            gradient.addColorStop(0, 'rgba(22, 163, 74, 0.3)');
            gradient.addColorStop(1, 'rgba(22, 163, 74, 0)');

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                        data: performanceData,
                        borderColor: '#16a34a',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function initSectorChart(stocks) {
            const ctx = document.getElementById('sectorChart');
            if (!ctx) return;

            if (sectorChart) {
                sectorChart.destroy();
            }

            // Group stocks by value for pie chart
            const stockData = stocks.map(s => ({
                name: s.name,
                value: s.current_value
            }));

            const colors = ['#16a34a', '#0ea5e9', '#eab308', '#dc2626', '#8b5cf6', '#f97316', '#06b6d4', '#ec4899'];

            sectorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: stockData.map(s => s.name),
                    datasets: [{
                        data: stockData.map(s => s.value),
                        backgroundColor: colors.slice(0, stockData.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true,
                            labels: {
                                padding: 20,
                                font: { family: 'Cairo' }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function loadMonthlyReturns(stocks) {
            const container = document.getElementById('monthlyReturnsBody');
            if (!container) return;

            // Generate simulated monthly returns
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];

            container.innerHTML = months.slice(0, new Date().getMonth() + 1).map((month, i) => {
                const returnVal = (Math.random() * 10 - 3).toFixed(2);
                const isPositive = parseFloat(returnVal) >= 0;
                return `
                    <tr style="border-bottom:1px solid var(--border)">
                        <td style="padding:12px">${month}</td>
                        <td style="padding:12px;color:${isPositive ? 'var(--success)' : 'var(--danger)'}">${isPositive ? '+' : ''}${returnVal}%</td>
                        <td style="padding:12px">${formatNumber(Math.random() * 100000 + 50000)} Ø±.Ø³</td>
                    </tr>
                `;
            }).join('');
        }

        function loadPerformers(stocks) {
            const bestContainer = document.getElementById('bestPerformers');
            const worstContainer = document.getElementById('worstPerformers');

            if (!bestContainer || !worstContainer) return;

            const sorted = [...stocks].sort((a, b) => b.profit_loss_percent - a.profit_loss_percent);
            const best = sorted.slice(0, 3);
            const worst = sorted.slice(-3).reverse();

            bestContainer.innerHTML = best.map((s, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--success-light);border-radius:10px;margin-bottom:8px">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="background:var(--success);color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.8rem">${i + 1}</span>
                        <span style="font-weight:600">${s.name}</span>
                    </div>
                    <span style="color:var(--success);font-weight:700">+${s.profit_loss_percent.toFixed(2)}%</span>
                </div>
            `).join('');

            worstContainer.innerHTML = worst.map((s, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--danger-light);border-radius:10px;margin-bottom:8px">
                    <div style="display:flex;align-items:center;gap:10px">
                        <span style="background:var(--danger);color:white;width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.8rem">${i + 1}</span>
                        <span style="font-weight:600">${s.name}</span>
                    </div>
                    <span style="color:var(--danger);font-weight:700">${s.profit_loss_percent.toFixed(2)}%</span>
                </div>
            `).join('');
        }

        function calculateRiskMetrics(data) {
            const stocks = data.stocks;
            const returns = stocks.map(s => s.profit_loss_percent);

            // Calculate standard deviation (volatility)
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
            const volatilityVal = Math.sqrt(variance);

            document.getElementById('volatility').textContent = `${volatilityVal.toFixed(2)}%`;

            // Beta (simplified - assuming 1 for now)
            document.getElementById('beta').textContent = '1.00';

            // Alpha (simplified)
            const alphaVal = mean - 5.5; // Excess return over risk-free
            document.getElementById('alpha').textContent = `${alphaVal >= 0 ? '+' : ''}${alphaVal.toFixed(2)}%`;

            // Sortino Ratio
            const negativeReturns = returns.filter(r => r < 0);
            const downside = negativeReturns.length > 0 ?
                Math.sqrt(negativeReturns.reduce((sum, r) => sum + Math.pow(r, 2), 0) / negativeReturns.length) : 1;
            const sortinoVal = ((mean - 5.5) / downside).toFixed(2);
            document.getElementById('sortino').textContent = sortinoVal;

            // VaR (95%)
            const sortedReturns = [...returns].sort((a, b) => a - b);
            const varIndex = Math.floor(sortedReturns.length * 0.05);
            const var95 = sortedReturns[varIndex] || sortedReturns[0] || 0;
            document.getElementById('var95').textContent = `${var95.toFixed(2)}%`;
        }

        function loadBenchmarkComparison(data) {
            const portfolioReturn = data.summary.total_profit_loss_percent;
            // Simulated TASI return
            const tasiReturn = parseFloat((Math.random() * 15 - 2).toFixed(2));
            const difference = portfolioReturn - tasiReturn;

            // Update the existing HTML elements
            document.getElementById('yourPerformance').textContent = `${portfolioReturn >= 0 ? '+' : ''}${portfolioReturn.toFixed(2)}%`;
            document.getElementById('yourPerformance').className = portfolioReturn >= 0 ? 'positive' : 'negative';

            document.getElementById('tasiPerformance').textContent = `${tasiReturn >= 0 ? '+' : ''}${tasiReturn.toFixed(2)}%`;

            document.getElementById('outperformance').textContent = `${difference >= 0 ? '+' : ''}${difference.toFixed(2)}%`;
            document.getElementById('outperformance').style.color = difference >= 0 ? 'var(--success)' : 'var(--danger)';

            // Update progress bars (normalize to 0-100 scale)
            const maxVal = Math.max(Math.abs(portfolioReturn), Math.abs(tasiReturn), 20);
            const yourBarWidth = Math.min(100, ((portfolioReturn + maxVal) / (maxVal * 2)) * 100);
            const tasiBarWidth = Math.min(100, ((tasiReturn + maxVal) / (maxVal * 2)) * 100);

            document.getElementById('yourPerfBar').style.width = yourBarWidth + '%';
            document.getElementById('yourPerfBar').style.background = portfolioReturn >= 0 ? 'var(--success)' : 'var(--danger)';

            document.getElementById('tasiPerfBar').style.width = tasiBarWidth + '%';

            // Update investment summary
            const winningStocks = data.stocks.filter(s => s.profit_loss_percent > 0);
            const losingStocks = data.stocks.filter(s => s.profit_loss_percent < 0);

            document.getElementById('totalTrades').textContent = data.stocks.length;
            document.getElementById('winningTrades').textContent = winningStocks.length;
            document.getElementById('losingTrades').textContent = losingStocks.length;

            if (winningStocks.length > 0) {
                const avgWin = winningStocks.reduce((sum, s) => sum + s.profit_loss_percent, 0) / winningStocks.length;
                document.getElementById('avgWin').textContent = '+' + avgWin.toFixed(2) + '%';
            }

            if (losingStocks.length > 0) {
                const avgLoss = losingStocks.reduce((sum, s) => sum + s.profit_loss_percent, 0) / losingStocks.length;
                document.getElementById('avgLoss').textContent = avgLoss.toFixed(2) + '%';
            }
        }

        function setPerformancePeriod(period) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            // Reload data with new period (simplified - just reload)
            loadPerformanceData();
        }

        // ==================== Wallets Functions ====================

        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡
        let selectedWalletsForPerformance = new Set();
        let walletsWithStocksData = [];

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶Ù‡Ø§)
        async function loadWalletsDataOnly() {
            try {
                const [walletsResponse, portfolioResponse] = await Promise.all([
                    fetch(`${API_BASE}/wallets`),
                    fetch(`${API_BASE}/portfolio`)
                ]);
                const walletsData = await walletsResponse.json();
                const portfolioData = await portfolioResponse.json();

                allWallets = walletsData.wallets || [];
                const allStocks = portfolioData.stocks || [];

                // Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø§Ù„Ù…Ø­Ø§ÙØ¸
                walletsWithStocksData = allWallets.map(wallet => {
                    const walletStocks = allStocks.filter(s => s.wallet_id === wallet.wallet_id && s.shares > 0);
                    const walletValue = walletStocks.reduce((sum, s) => sum + (s.current_value || 0), 0);
                    const walletCost = walletStocks.reduce((sum, s) => sum + (s.total_cost || 0), 0);
                    const walletProfit = walletValue - walletCost;
                    return {
                        ...wallet,
                        stocks: walletStocks,
                        total_value: walletValue,
                        total_cost: walletCost,
                        profit_loss: walletProfit,
                        profit_loss_percent: walletCost > 0 ? (walletProfit / walletCost) * 100 : 0
                    };
                });

                // Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø©
                const unassignedStocks = allStocks.filter(s => !s.wallet_id && s.shares > 0);
                if (unassignedStocks.length > 0) {
                    const unassignedValue = unassignedStocks.reduce((sum, s) => sum + (s.current_value || 0), 0);
                    const unassignedCost = unassignedStocks.reduce((sum, s) => sum + (s.total_cost || 0), 0);
                    walletsWithStocksData.push({
                        wallet_id: 'unassigned',
                        name: 'Ø£Ø³Ù‡Ù… Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø©',
                        broker: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        buying_power: 0,
                        stocks: unassignedStocks,
                        total_value: unassignedValue,
                        total_cost: unassignedCost,
                        profit_loss: unassignedValue - unassignedCost,
                        profit_loss_percent: unassignedCost > 0 ? ((unassignedValue - unassignedCost) / unassignedCost) * 100 : 0
                    });
                }

                // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡
                renderWalletSelectionForPerformance(walletsWithStocksData);
            } catch (error) {
                console.error('Error loading wallets data:', error);
            }
        }

        async function loadWallets() {
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ø£Ø³Ù‡Ù… Ù…Ø¹Ø§Ù‹
                const [walletsResponse, portfolioResponse] = await Promise.all([
                    fetch(`${API_BASE}/wallets`),
                    fetch(`${API_BASE}/portfolio`)
                ]);
                const walletsData = await walletsResponse.json();
                const portfolioData = await portfolioResponse.json();

                allWallets = walletsData.wallets || [];
                const allStocks = portfolioData.stocks || [];

                // Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø© (Ø£Ø³Ù‡Ù… = 0 Ù…Ø¹ Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø© Ù…Ø­Ù‚Ù‚)
                const closedTrades = allStocks.filter(s => s.shares === 0 && s.realized_profit_loss !== 0);

                // Ø±Ø¨Ø· Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø§Ù„Ù…Ø­Ø§ÙØ¸
                walletsWithStocksData = allWallets.map(wallet => {
                    const walletStocks = allStocks.filter(s => s.wallet_id === wallet.wallet_id && s.shares > 0);
                    const walletValue = walletStocks.reduce((sum, s) => sum + (s.current_value || 0), 0);
                    const walletCost = walletStocks.reduce((sum, s) => sum + (s.total_cost || 0), 0);
                    const walletProfit = walletValue - walletCost;
                    return {
                        ...wallet,
                        stocks: walletStocks,
                        total_value: walletValue,
                        total_cost: walletCost,
                        profit_loss: walletProfit,
                        profit_loss_percent: walletCost > 0 ? (walletProfit / walletCost) * 100 : 0
                    };
                });

                // Ø§Ù„Ø£Ø³Ù‡Ù… Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø© (Ù…Ù…Ù„ÙˆÙƒØ©)
                const unassignedStocks = allStocks.filter(s => !s.wallet_id && s.shares > 0);
                if (unassignedStocks.length > 0) {
                    const unassignedValue = unassignedStocks.reduce((sum, s) => sum + (s.current_value || 0), 0);
                    const unassignedCost = unassignedStocks.reduce((sum, s) => sum + (s.total_cost || 0), 0);
                    walletsWithStocksData.push({
                        wallet_id: 'unassigned',
                        name: 'Ø£Ø³Ù‡Ù… Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø©',
                        broker: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        buying_power: 0,
                        stocks: unassignedStocks,
                        total_value: unassignedValue,
                        total_cost: unassignedCost,
                        profit_loss: unassignedValue - unassignedCost,
                        profit_loss_percent: unassignedCost > 0 ? ((unassignedValue - unassignedCost) / unassignedCost) * 100 : 0
                    });
                }

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø© ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù†ÙØµÙ„Ø©
                if (closedTrades.length > 0) {
                    // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
                    closedTrades.sort((a, b) => (b.last_sell_date || '').localeCompare(a.last_sell_date || ''));
                    const totalRealizedProfit = closedTrades.reduce((sum, s) => sum + (s.realized_profit_loss || 0), 0);

                    walletsWithStocksData.push({
                        wallet_id: 'closed_trades',
                        name: 'ØµÙÙ‚Ø§Øª Ù…Ù‚ÙÙ„Ø©',
                        broker: 'Ø£Ø±Ø¨Ø§Ø­ Ù…Ø­Ù‚Ù‚Ø©',
                        buying_power: 0,
                        stocks: closedTrades,
                        is_closed_trades: true,
                        total_value: 0,
                        total_cost: 0,
                        profit_loss: totalRealizedProfit,
                        profit_loss_percent: 0
                    });
                }

                // Update stats
                const totalBuyingPower = allWallets.reduce((sum, w) => sum + (w.buying_power || 0), 0);
                const totalWalletsValue = walletsWithStocksData.filter(w => !w.is_closed_trades).reduce((sum, w) => sum + (w.total_value || 0), 0);
                const totalStocksCount = walletsWithStocksData.filter(w => !w.is_closed_trades).reduce((sum, w) => sum + (w.stocks?.length || 0), 0);

                document.getElementById('totalBuyingPower').innerHTML = `${formatNumber(totalBuyingPower)} <small>Ø±.Ø³</small>`;
                document.getElementById('totalWalletsValue').innerHTML = `${formatNumber(totalWalletsValue)} <small>Ø±.Ø³</small>`;
                document.getElementById('walletsCount').textContent = allWallets.length;
                document.getElementById('totalWalletsStocks').textContent = totalStocksCount;

                renderWalletsWithStocks(walletsWithStocksData);

                // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø¨Ø¯ÙˆÙ† Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©)
                renderWalletSelectionForPerformance(walletsWithStocksData.filter(w => !w.is_closed_trades));

            } catch (error) {
                console.error('Error loading wallets:', error);
            }
        }

        async function loadWalletsForSelect() {
            try {
                const response = await fetch(`${API_BASE}/wallets`);
                const data = await response.json();
                allWallets = data.wallets || [];

                const select = document.getElementById('stockWallet');
                if (select) {
                    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) --</option>';
                    allWallets.forEach(wallet => {
                        select.innerHTML += `<option value="${wallet.wallet_id}">${wallet.name} - ${wallet.broker} (${formatNumber(wallet.buying_power)} Ø±.Ø³)</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading wallets for select:', error);
            }
        }

        function renderWalletsWithStocks(wallets) {
            const container = document.getElementById('walletsWithStocks');

            if (wallets.length === 0) {
                container.innerHTML = `
                    <div class="card" style="padding:60px;text-align:center">
                        <div style="font-size:4rem;margin-bottom:16px">ğŸ’¼</div>
                        <h3 style="margin-bottom:8px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙØ¸</h3>
                        <p style="color:var(--text-secondary)">Ø£Ø¶Ù Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ø¨Ø¯Ø¡</p>
                    </div>
                `;
                return;
            }

            // Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            const walletColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];

            container.innerHTML = wallets.map((wallet, idx) => {
                const color = wallet.is_closed_trades ? '#64748b' : walletColors[idx % walletColors.length];
                const isUnassigned = wallet.wallet_id === 'unassigned';
                const isClosedTrades = wallet.is_closed_trades;

                // Ù„Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø© - Ø¹Ø±Ø¶ Ù…Ø®ØªÙ„Ù
                if (isClosedTrades) {
                    return `
                        <div class="card" style="margin-bottom:20px;border-right:5px solid ${color};opacity:0.9">
                            <!-- Closed Trades Header -->
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:20px;background:linear-gradient(135deg, ${color}15 0%, ${color}08 100%);border-radius:16px 16px 0 0;margin:-1px -1px 0 -1px">
                                <div>
                                    <h3 style="font-size:1.3rem;margin-bottom:6px;display:flex;align-items:center;gap:10px">
                                        <span style="font-size:1.2rem">ğŸ“¦</span>
                                        ${wallet.name}
                                    </h3>
                                    <div style="display:flex;align-items:center;gap:10px">
                                        <span style="background:${color}20;color:${color};padding:4px 12px;border-radius:8px;font-size:0.85rem;font-weight:500">ØµÙÙ‚Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ©</span>
                                        <span style="color:var(--text-secondary);font-size:0.85rem">${wallet.stocks?.length || 0} ØµÙÙ‚Ø©</span>
                                    </div>
                                </div>
                                <div style="text-align:left">
                                    <div style="font-size:0.8rem;color:var(--text-secondary)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©</div>
                                    <div style="font-size:1.5rem;font-weight:700;color:${wallet.profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                        ${wallet.profit_loss >= 0 ? '+' : ''}${formatNumber(wallet.profit_loss)} <small>Ø±.Ø³</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Closed Trades Table -->
                            ${wallet.stocks && wallet.stocks.length > 0 ? `
                                <div style="padding:16px">
                                    <table style="width:100%;border-collapse:collapse;font-size:0.85rem">
                                        <thead>
                                            <tr style="background:var(--bg-secondary)">
                                                <th style="padding:10px;text-align:right;font-weight:500">Ø§Ù„Ø³Ù‡Ù…</th>
                                                <th style="padding:10px;text-align:center;font-weight:500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù‚ÙØ§Ù„</th>
                                                <th style="padding:10px;text-align:center;font-weight:500">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${wallet.stocks.map(stock => `
                                                <tr style="border-bottom:1px solid var(--border)">
                                                    <td style="padding:10px">
                                                        <div style="font-weight:600">${stock.name}</div>
                                                        <div style="font-size:0.75rem;color:var(--text-secondary)">${stock.symbol}</div>
                                                    </td>
                                                    <td style="padding:10px;text-align:center;color:var(--text-secondary)">${stock.last_sell_date || '-'}</td>
                                                    <td style="padding:10px;text-align:center">
                                                        <span style="padding:4px 12px;border-radius:8px;font-weight:700;
                                                            background:${stock.realized_profit_loss >= 0 ? 'var(--success-light)' : 'var(--danger-light)'};
                                                            color:${stock.realized_profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                                            ${stock.realized_profit_loss >= 0 ? '+' : ''}${formatNumber(stock.realized_profit_loss)} Ø±.Ø³
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                const strategyIcons = { 'speculative': 'ğŸ°', 'balanced': 'âš–ï¸', 'long_term': 'ğŸ¦' };
                const strategyColors = { 'speculative': 'var(--warning)', 'balanced': 'var(--info)', 'long_term': 'var(--success)' };
                const strategyIcon = strategyIcons[wallet.strategy] || 'âš–ï¸';
                const strategyColor = strategyColors[wallet.strategy] || 'var(--info)';
                const strategyDisplay = wallet.strategy_display || 'Ù…ØªÙˆØ§Ø²Ù†Ø©';

                return `
                    <div class="card" style="margin-bottom:20px;border-right:5px solid ${color}">
                        <!-- Wallet Header -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:20px;background:linear-gradient(135deg, ${color}10 0%, ${color}05 100%);border-radius:16px 16px 0 0;margin:-1px -1px 0 -1px">
                            <div>
                                <h3 style="font-size:1.3rem;margin-bottom:6px;display:flex;align-items:center;gap:10px">
                                    <span style="width:12px;height:12px;background:${color};border-radius:3px"></span>
                                    ${wallet.name}
                                    ${wallet.account_number ? `<span style="font-size:0.8rem;color:var(--text-secondary);font-weight:400">(${wallet.account_number})</span>` : ''}
                                </h3>
                                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                    <span style="background:${color}20;color:${color};padding:4px 12px;border-radius:8px;font-size:0.85rem;font-weight:500">${wallet.broker}</span>
                                    <span style="background:${strategyColor}20;color:${strategyColor};padding:4px 12px;border-radius:8px;font-size:0.85rem;font-weight:500;display:flex;align-items:center;gap:4px">
                                        <span>${strategyIcon}</span> ${strategyDisplay}
                                    </span>
                                    <span style="color:var(--text-secondary);font-size:0.85rem">${wallet.stocks?.length || 0} Ø³Ù‡Ù…</span>
                                </div>
                            </div>
                            ${!isUnassigned ? `
                                <div style="display:flex;gap:8px">
                                    <button onclick="openBuyingPowerModal('${wallet.wallet_id}')" class="btn btn-outline" style="padding:6px 12px;font-size:0.8rem">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯</button>
                                    <button onclick="editWallet('${wallet.wallet_id}')" class="btn btn-outline" style="padding:6px 12px;font-size:0.8rem">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button onclick="deleteWallet('${wallet.wallet_id}')" class="btn" style="padding:6px 12px;font-size:0.8rem;background:var(--danger-light);color:var(--danger)">Ø­Ø°Ù</button>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Wallet Stats -->
                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;padding:16px;background:var(--bg-secondary)">
                            <div style="text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ù‡Ù…</div>
                                <div style="font-size:1.1rem;font-weight:700">${formatNumber(wallet.total_value)}</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                                <div style="font-size:1.1rem;font-weight:600">${formatNumber(wallet.total_cost)}</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
                                <div style="font-size:1.1rem;font-weight:700;color:${wallet.profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                    ${wallet.profit_loss >= 0 ? '+' : ''}${formatNumber(wallet.profit_loss)}
                                </div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                                <div style="font-size:1.1rem;font-weight:700;color:${wallet.profit_loss_percent >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                    ${wallet.profit_loss_percent >= 0 ? '+' : ''}${wallet.profit_loss_percent.toFixed(2)}%
                                </div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</div>
                                <div style="font-size:1.1rem;font-weight:600;color:var(--info)">${formatNumber(wallet.buying_power || 0)}</div>
                            </div>
                        </div>

                        <!-- Stocks Table -->
                        ${wallet.stocks && wallet.stocks.length > 0 ? `
                            <div style="padding:16px">
                                <table style="width:100%;border-collapse:collapse;font-size:0.85rem">
                                    <thead>
                                        <tr style="background:var(--bg-secondary)">
                                            <th style="padding:10px;text-align:right;font-weight:500">Ø§Ù„Ø³Ù‡Ù…</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                            <th style="padding:10px;text-align:center;font-weight:500">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${wallet.stocks.map(stock => `
                                            <tr style="border-bottom:1px solid var(--border)">
                                                <td style="padding:10px">
                                                    <div style="font-weight:600">${stock.name}</div>
                                                    <div style="font-size:0.75rem;color:var(--text-secondary)">${stock.symbol}</div>
                                                </td>
                                                <td style="padding:10px;text-align:center;font-weight:600">${stock.shares}</td>
                                                <td style="padding:10px;text-align:center">${formatNumber(stock.buy_price)}</td>
                                                <td style="padding:10px;text-align:center;font-weight:600">${formatNumber(stock.current_price)}</td>
                                                <td style="padding:10px;text-align:center">${formatNumber(stock.current_value)}</td>
                                                <td style="padding:10px;text-align:center;font-weight:600;color:${stock.profit_loss >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                                    ${stock.profit_loss >= 0 ? '+' : ''}${formatNumber(stock.profit_loss)}
                                                </td>
                                                <td style="padding:10px;text-align:center">
                                                    <span style="padding:3px 8px;border-radius:12px;font-size:0.8rem;font-weight:600;
                                                        background:${stock.profit_loss_percent >= 0 ? 'var(--success-light)' : 'var(--danger-light)'};
                                                        color:${stock.profit_loss_percent >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                                        ${stock.profit_loss_percent >= 0 ? '+' : ''}${stock.profit_loss_percent.toFixed(2)}%
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding:40px;text-align:center;color:var(--text-secondary)">
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø©</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // ====== Ø¯ÙˆØ§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡ ======

        function renderWalletSelectionForPerformance(wallets) {
            const container = document.getElementById('walletSelectionForPerformance');
            if (!container) return;

            // Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ù…Ø­Ø§ÙØ¸
            const walletColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            if (selectedWalletsForPerformance.size === 0) {
                wallets.forEach(w => selectedWalletsForPerformance.add(w.wallet_id));
            }

            container.innerHTML = wallets.map((wallet, idx) => {
                const color = walletColors[idx % walletColors.length];
                const isSelected = selectedWalletsForPerformance.has(wallet.wallet_id);
                const stocksCount = wallet.stocks?.length || 0;

                return `
                    <label style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:${isSelected ? color + '15' : 'white'};
                        border:2px solid ${isSelected ? color : 'var(--border)'};border-radius:12px;cursor:pointer;transition:all 0.2s;min-width:200px"
                        onclick="toggleWalletForPerformance('${wallet.wallet_id}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="width:18px;height:18px;accent-color:${color}"
                            onchange="toggleWalletForPerformance('${wallet.wallet_id}')" onclick="event.stopPropagation()">
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;gap:6px">
                                <span style="width:10px;height:10px;background:${color};border-radius:2px"></span>
                                <span style="font-weight:600;font-size:0.9rem">${wallet.name}</span>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:2px">
                                ${stocksCount} Ø³Ù‡Ù… | ${formatNumber(wallet.total_value)} Ø±.Ø³
                            </div>
                        </div>
                    </label>
                `;
            }).join('');

            updateSelectedWalletsStats();
        }

        function toggleWalletForPerformance(walletId) {
            if (selectedWalletsForPerformance.has(walletId)) {
                selectedWalletsForPerformance.delete(walletId);
            } else {
                selectedWalletsForPerformance.add(walletId);
            }
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
            renderWalletSelectionForPerformance(walletsWithStocksData);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            updatePerformanceChart();
        }

        function selectAllWalletsForPerformance() {
            walletsWithStocksData.forEach(w => selectedWalletsForPerformance.add(w.wallet_id));
            renderWalletSelectionForPerformance(walletsWithStocksData);
            updatePerformanceChart();
        }

        function deselectAllWalletsForPerformance() {
            selectedWalletsForPerformance.clear();
            renderWalletSelectionForPerformance(walletsWithStocksData);
            updatePerformanceChart();
        }

        function updateSelectedWalletsStats() {
            const selectedWallets = walletsWithStocksData.filter(w => selectedWalletsForPerformance.has(w.wallet_id));
            const totalValue = selectedWallets.reduce((sum, w) => sum + (w.total_value || 0), 0);

            document.getElementById('selectedWalletsCount').textContent = selectedWallets.length;
            document.getElementById('selectedWalletsValue').textContent = formatNumber(totalValue) + ' Ø±.Ø³';
        }

        function updatePerformanceChart() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const selectedWallets = walletsWithStocksData.filter(w => selectedWalletsForPerformance.has(w.wallet_id));

            // ØªØ­Ø¯ÙŠØ« Legend
            const legendContainer = document.getElementById('performanceChartLegend');
            const walletColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];

            if (legendContainer) {
                if (selectedWallets.length > 1) {
                    legendContainer.innerHTML = selectedWallets.map((w, idx) => {
                        const color = walletColors[idx % walletColors.length];
                        return `
                            <div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:${color}15;border-radius:6px">
                                <span style="width:12px;height:12px;background:${color};border-radius:2px"></span>
                                <span style="font-size:0.8rem;font-weight:500">${w.name}</span>
                            </div>
                        `;
                    }).join('') + `
                        <div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:#1e293b15;border-radius:6px;border:1px dashed #1e293b">
                            <span style="width:12px;height:12px;background:#1e293b;border-radius:2px"></span>
                            <span style="font-size:0.8rem;font-weight:600">Ø§Ù„Ù…Ø¬Ù…Ø¹</span>
                        </div>
                    `;
                    legendContainer.style.display = 'flex';
                } else if (selectedWallets.length === 1) {
                    legendContainer.innerHTML = `
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="width:12px;height:12px;background:${walletColors[0]};border-radius:2px"></span>
                            <span style="font-size:0.85rem;font-weight:500">${selectedWallets[0].name}</span>
                        </div>
                    `;
                    legendContainer.style.display = 'flex';
                } else {
                    legendContainer.innerHTML = '<span style="color:var(--text-muted);font-size:0.85rem">Ø§Ø®ØªØ± Ù…Ø­ÙØ¸Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</span>';
                }
            }

            // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
            loadPerformanceData();
        }

        function renderWalletsList(wallets) {
            // Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… - Ø§Ù„Ø¢Ù† Ù†Ø³ØªØ®Ø¯Ù… renderWalletsWithStocks
            renderWalletsWithStocks(walletsWithStocksData);
        }

        function selectStrategy(strategy) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            document.querySelectorAll('.strategy-option').forEach(opt => {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            });

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
            const selectedOpt = document.getElementById('strategy' + strategy.charAt(0).toUpperCase() + strategy.slice(1).replace('_t', 'T').replace('_term', 'Term'));
            if (selectedOpt) {
                const colors = {
                    'speculative': 'var(--warning)',
                    'balanced': 'var(--info)',
                    'long_term': 'var(--success)'
                };
                selectedOpt.style.borderColor = colors[strategy];
                selectedOpt.style.background = colors[strategy] + '15';
            }

            document.getElementById('walletStrategy').value = strategy;
        }

        function openWalletModal(walletId = null) {
            editingWalletId = walletId;
            const modal = document.getElementById('walletModal');
            const title = document.getElementById('walletModalTitle');
            const submitBtn = document.getElementById('walletSubmitBtn');
            const form = document.getElementById('walletForm');

            form.reset();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
            document.querySelectorAll('.strategy-option').forEach(opt => {
                opt.style.borderColor = 'var(--border)';
                opt.style.background = 'transparent';
            });
            document.getElementById('walletStrategy').value = '';

            if (walletId) {
                const wallet = allWallets.find(w => w.wallet_id === walletId);
                if (wallet) {
                    title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø©';
                    submitBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                    document.getElementById('walletId').value = wallet.wallet_id;
                    document.getElementById('walletName').value = wallet.name;
                    document.getElementById('walletAccountNumber').value = wallet.account_number || '';
                    document.getElementById('walletBroker').value = wallet.broker;
                    document.getElementById('walletBuyingPower').value = wallet.buying_power;
                    document.getElementById('walletDescription').value = wallet.description || '';
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
                    if (wallet.strategy) {
                        selectStrategy(wallet.strategy);
                    }
                }
            } else {
                title.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                submitBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©';
                document.getElementById('walletId').value = '';
                document.getElementById('walletAccountNumber').value = '';
            }

            modal.classList.add('active');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('active');
            editingWalletId = null;
        }

        function editWallet(walletId) {
            openWalletModal(walletId);
        }

        async function submitWallet(event) {
            event.preventDefault();

            const walletId = document.getElementById('walletId').value;
            const strategy = document.getElementById('walletStrategy').value;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
            if (!strategy) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø­ÙØ¸Ø©');
                return;
            }

            const data = {
                name: document.getElementById('walletName').value,
                account_number: document.getElementById('walletAccountNumber').value,
                broker: document.getElementById('walletBroker').value,
                strategy: strategy,
                buying_power: parseFloat(document.getElementById('walletBuyingPower').value) || 0,
                description: document.getElementById('walletDescription').value
            };

            try {
                let response;
                if (walletId) {
                    response = await fetch(`${API_BASE}/wallets/${walletId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${API_BASE}/wallets`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();

                if (result.success) {
                    closeWalletModal();
                    loadWallets();
                    loadWalletsForSelect();
                } else {
                    alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteWallet(walletId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­ÙØ¸Ø©ØŸ')) return;

            try {
                const response = await fetch(`${API_BASE}/wallets/${walletId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    loadWallets();
                    loadWalletsForSelect();
                } else {
                    alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        function openBuyingPowerModal(walletId) {
            const wallet = allWallets.find(w => w.wallet_id === walletId);
            if (!wallet) return;

            document.getElementById('bpWalletId').value = walletId;
            document.getElementById('bpWalletName').textContent = wallet.name;
            document.getElementById('bpCurrentAmount').textContent = formatNumber(wallet.buying_power) + ' Ø±.Ø³';
            document.getElementById('bpAmount').value = '';
            document.getElementById('bpOperation').value = 'add';

            // Reset buttons
            document.getElementById('bpAddBtn').classList.add('active');
            document.getElementById('bpSubtractBtn').classList.remove('active');

            document.getElementById('buyingPowerModal').classList.add('active');
        }

        function closeBuyingPowerModal() {
            document.getElementById('buyingPowerModal').classList.remove('active');
        }

        function selectBpOperation(operation) {
            document.getElementById('bpOperation').value = operation;

            if (operation === 'add') {
                document.getElementById('bpAddBtn').classList.add('active');
                document.getElementById('bpSubtractBtn').classList.remove('active');
            } else {
                document.getElementById('bpAddBtn').classList.remove('active');
                document.getElementById('bpSubtractBtn').classList.add('active');
            }
        }

        async function submitBuyingPower(event) {
            event.preventDefault();

            const walletId = document.getElementById('bpWalletId').value;
            const amount = parseFloat(document.getElementById('bpAmount').value);
            const operation = document.getElementById('bpOperation').value;

            try {
                const response = await fetch(`${API_BASE}/wallets/${walletId}/buying-power`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, operation })
                });

                const result = await response.json();

                if (result.success) {
                    closeBuyingPowerModal();
                    loadWallets();
                    loadWalletsForSelect();
                } else {
                    alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // ==================== Import/Export Functions ====================

        function openImportExportModal() {
            document.getElementById('importExportModal').classList.add('active');
            document.getElementById('importResult').style.display = 'none';
            document.getElementById('importForm').reset();
        }

        function closeImportExportModal() {
            document.getElementById('importExportModal').classList.remove('active');
        }

        function switchImportExportTab(tab) {
            document.querySelectorAll('#importExportModal .modal-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (tab === 'export') {
                document.getElementById('export-tab').style.display = 'block';
                document.getElementById('import-tab').style.display = 'none';
            } else {
                document.getElementById('export-tab').style.display = 'none';
                document.getElementById('import-tab').style.display = 'block';
            }
        }

        async function submitImport(event) {
            event.preventDefault();

            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...';

            try {
                const response = await fetch(`${API_BASE}/import/orders`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                const resultDiv = document.getElementById('importResult');

                if (result.success) {
                    let html = `
                        <div style="background:var(--success-light);padding:16px;border-radius:12px;border:1px solid var(--success)">
                            <h4 style="color:var(--success);margin-bottom:8px">âœ“ ${result.message}</h4>
                    `;

                    if (result.errors && result.errors.length > 0) {
                        html += `
                            <div style="margin-top:12px;padding:12px;background:var(--warning-light);border-radius:8px">
                                <strong style="color:var(--warning)">ØªØ­Ø°ÙŠØ±Ø§Øª:</strong>
                                <ul style="margin:8px 0 0 20px;font-size:0.9rem;color:var(--text-secondary)">
                                    ${result.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    loadPortfolio();
                    loadAnalysis();
                } else {
                    resultDiv.innerHTML = `
                        <div style="background:var(--danger-light);padding:16px;border-radius:12px;border:1px solid var(--danger)">
                            <h4 style="color:var(--danger);margin-bottom:8px">âœ— Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h4>
                            <p style="color:var(--text-secondary)">${result.error}</p>
                        </div>
                    `;
                }

                resultDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('importResult').innerHTML = `
                    <div style="background:var(--danger-light);padding:16px;border-radius:12px;border:1px solid var(--danger)">
                        <h4 style="color:var(--danger)">âœ— Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h4>
                    </div>
                `;
                document.getElementById('importResult').style.display = 'block';
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:8px">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Ø±ÙØ¹ ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
                `;
            }
        }

        // ==================== Dashboard Functions ====================

        function openTransactionModal() {
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('transactionDate').valueAsDate = new Date();
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸
            const walletSelect = document.getElementById('transactionWallet');
            walletSelect.innerHTML = allWallets.map(w =>
                `<option value="${w.wallet_id}">${w.name} - ${w.broker}</option>`
            ).join('');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionForm').reset();
        }

        async function submitTransaction(e) {
            e.preventDefault();

            const data = {
                type: document.getElementById('transactionType').value,
                wallet_id: document.getElementById('transactionWallet').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                date: document.getElementById('transactionDate').value,
                note: document.getElementById('transactionNote').value
            };

            try {
                const response = await fetch(`${API_BASE}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeTransactionModal();
                    loadDashboard();
                    showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
                }
            } catch (error) {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        async function loadDashboard() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø©
                const transResponse = await fetch(`${API_BASE}/transactions/summary`);
                if (transResponse.ok) {
                    const transData = await transResponse.json();
                    document.getElementById('totalDeposits').innerHTML = `${formatNumber(transData.total_deposits)} <small>Ø±.Ø³</small>`;
                    document.getElementById('totalWithdrawals').innerHTML = `${formatNumber(transData.total_withdrawals)} <small>Ø±.Ø³</small>`;
                    document.getElementById('netDeposits').innerHTML = `${formatNumber(transData.net_deposits)} <small>Ø±.Ø³</small>`;

                    // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    renderTransactionsHistory(transData.transactions || []);
                }

                // ØªØ­Ù…ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø© ÙÙ‚Ø·
                const portfolioResponse = await fetch(`${API_BASE}/portfolio/by-strategy/balanced`);
                if (portfolioResponse.ok) {
                    const portfolioData = await portfolioResponse.json();
                    document.getElementById('dashboardPortfolioValue').innerHTML =
                        `${formatNumber(portfolioData.summary.total_value)} <small>Ø±.Ø³</small>`;

                    // ØªØ­Ù…ÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ© Ù„Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø©
                    const ownedStocks = portfolioData.stocks.filter(s => s.shares > 0);
                    loadOwnedStocksAnalysisBalanced(ownedStocks);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadOwnedStocksAnalysisBalanced(stocks) {
            const container = document.getElementById('ownedStocksAnalysis');

            if (!stocks || stocks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†Ø©</p>
                        <p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px">Ø£Ø¶Ù Ù…Ø­ÙØ¸Ø© Ù…ØªÙˆØ§Ø²Ù†Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ...</div>';

            try {
                const analysisResponse = await fetch(`${API_BASE}/dashboard/stocks-analysis/balanced`);
                if (analysisResponse.ok) {
                    const analysisData = await analysisResponse.json();
                    renderOwnedStocksAnalysis(analysisData.stocks);
                } else {
                    renderOwnedStocksAnalysis(stocks.map(s => ({...s, analysis: null})));
                }
            } catch (error) {
                renderOwnedStocksAnalysis(stocks.map(s => ({...s, analysis: null})));
            }
        }

        function renderTransactionsHistory(transactions) {
            const container = document.getElementById('transactionsHistory');

            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ùˆ Ø³Ø­Ø¨</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
                    <thead>
                        <tr style="border-bottom:2px solid var(--border)">
                            <th style="padding:12px;text-align:right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th style="padding:12px;text-align:center">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th style="padding:12px;text-align:center">Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                            <th style="padding:12px;text-align:left">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th style="padding:12px;text-align:center">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th style="padding:12px;text-align:center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(t => `
                            <tr style="border-bottom:1px solid var(--border)">
                                <td style="padding:12px">${t.date}</td>
                                <td style="padding:12px;text-align:center">
                                    <span style="padding:4px 12px;border-radius:20px;font-size:0.8rem;
                                        background:${t.type === 'deposit' ? 'var(--success-light)' : 'var(--danger-light)'};
                                        color:${t.type === 'deposit' ? 'var(--success)' : 'var(--danger)'}">
                                        ${t.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'}
                                    </span>
                                </td>
                                <td style="padding:12px;text-align:center">${t.wallet_name || '-'}</td>
                                <td style="padding:12px;text-align:left;font-weight:600;
                                    color:${t.type === 'deposit' ? 'var(--success)' : 'var(--danger)'}">
                                    ${t.type === 'deposit' ? '+' : '-'}${formatNumber(t.amount)} Ø±.Ø³
                                </td>
                                <td style="padding:12px;text-align:center;color:var(--text-secondary)">${t.note || '-'}</td>
                                <td style="padding:12px;text-align:center">
                                    <button onclick="deleteTransaction('${t.id}')"
                                        style="background:var(--danger-light);color:var(--danger);border:none;padding:6px 12px;border-radius:8px;cursor:pointer">
                                        Ø­Ø°Ù
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteTransaction(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;

            try {
                const response = await fetch(`${API_BASE}/transactions/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadDashboard();
                    showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'success');
                }
            } catch (error) {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        }

        async function loadOwnedStocksAnalysis(stocks) {
            const container = document.getElementById('ownedStocksAnalysis');

            if (!stocks || stocks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ù…Ù…Ù„ÙˆÙƒØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ...</div>';

            try {
                const analysisResponse = await fetch(`${API_BASE}/dashboard/stocks-analysis`);
                if (analysisResponse.ok) {
                    const analysisData = await analysisResponse.json();
                    renderOwnedStocksAnalysis(analysisData.stocks);
                } else {
                    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØ­Ù„ÙŠÙ„
                    renderOwnedStocksAnalysis(stocks.map(s => ({...s, analysis: null})));
                }
            } catch (error) {
                renderOwnedStocksAnalysis(stocks.map(s => ({...s, analysis: null})));
            }
        }

        function renderOwnedStocksAnalysis(stocks) {
            const container = document.getElementById('ownedStocksAnalysis');

            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
            const totalPortfolioValue = stocks.reduce((sum, s) => sum + (s.current_value || 0), 0);
            document.getElementById('strategyCore').textContent = formatNumber(totalPortfolioValue * 0.5);
            document.getElementById('strategyMid').textContent = formatNumber(totalPortfolioValue * 0.3);
            document.getElementById('strategySpec').textContent = formatNumber(totalPortfolioValue * 0.2);
            document.getElementById('totalStocksCount').innerHTML = `${stocks.length} <small>Ø³Ù‡Ù…</small>`;

            container.innerHTML = stocks.map((stock, stockIndex) => {
                const analysis = stock.analysis || {};
                const levels = analysis.levels || {};
                const mas = analysis.moving_averages || {};
                const supplyDemand = analysis.supply_demand || {};
                const priceAction = analysis.price_action || {};
                const tradingLevels = analysis.trading_levels || {};
                const currentVsAvg = tradingLevels.current_vs_avg || {};

                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (15% ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
                const maxTradePercent = 15;
                const maxTradeShares = Math.floor(stock.shares * (maxTradePercent / 100));
                const maxTradeValue = maxTradeShares * (stock.current_price || 0);

                // ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
                const coreShares = Math.floor(stock.shares * 0.5);      // 50% Ø§Ø³ØªØ«Ù…Ø§Ø± Ø£Ø³Ø§Ø³ÙŠ
                const midShares = Math.floor(stock.shares * 0.3);       // 30% Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰
                const specShares = stock.shares - coreShares - midShares; // 20% Ù…Ø¶Ø§Ø±Ø¨Ø©

                return `
                    <div style="border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px;background:var(--bg-card)">
                        <!-- Header with Quick Stats -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--border)">
                            <div>
                                <h3 style="font-size:1.2rem;margin-bottom:4px;display:flex;align-items:center;gap:8px">
                                    ${stock.name}
                                    <span style="padding:4px 10px;border-radius:12px;font-size:0.75rem;font-weight:600;
                                        background:${tradingLevels.recommendation === 'ØªØ¹Ø²ÙŠØ²' || tradingLevels.recommendation === 'Ø´Ø±Ø§Ø¡ Ù…Ø­ØªÙ…Ù„' ? 'var(--success)' :
                                                    tradingLevels.recommendation === 'Ø¬Ù†ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø¬Ø²Ø¦ÙŠ' || tradingLevels.recommendation === 'Ø¨ÙŠØ¹ Ù…Ø­ØªÙ…Ù„' ? 'var(--danger)' :
                                                    tradingLevels.recommendation === 'Ø§Ø­ØªÙØ§Ø¸' ? '#1e293b' : 'var(--warning)'};
                                        color:white">
                                        ${tradingLevels.recommendation || 'Ø§Ù†ØªØ¸Ø§Ø±'}
                                    </span>
                                </h3>
                                <span style="color:var(--text-secondary);font-size:0.9rem">${stock.symbol}</span>
                            </div>
                            <div style="text-align:left">
                                <div style="font-size:1.6rem;font-weight:700">${formatNumber(stock.current_price || 0)} <small style="font-size:0.8rem">Ø±.Ø³</small></div>
                                <div style="display:flex;align-items:center;gap:12px;justify-content:flex-end">
                                    <span style="font-size:0.9rem;color:${(stock.profit_loss_percent || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                        ${(stock.profit_loss_percent || 0) >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(stock.profit_loss_percent || 0).toFixed(2)}%
                                    </span>
                                    <span style="padding:4px 8px;border-radius:6px;font-size:0.8rem;background:${currentVsAvg.percent >= 0 ? 'var(--success-light)' : 'var(--danger-light)'};color:${currentVsAvg.percent >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                        Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø·: ${currentVsAvg.percent >= 0 ? '+' : ''}${(currentVsAvg.percent || 0).toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Main Info Grid -->
                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px">
                            <div style="background:var(--bg-secondary);padding:12px;border-radius:10px;text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</div>
                                <div style="font-size:1.2rem;font-weight:700">${stock.shares}</div>
                            </div>
                            <div style="background:var(--bg-secondary);padding:12px;border-radius:10px;text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                                <div style="font-size:1.1rem;font-weight:600">${formatNumber(stock.buy_price || 0)}</div>
                            </div>
                            <div style="background:var(--bg-secondary);padding:12px;border-radius:10px;text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                                <div style="font-size:1.1rem;font-weight:600">${formatNumber(stock.total_cost || 0)}</div>
                            </div>
                            <div style="background:var(--bg-secondary);padding:12px;border-radius:10px;text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                                <div style="font-size:1.1rem;font-weight:600">${formatNumber(stock.current_value || 0)}</div>
                            </div>
                            <div style="background:${(stock.profit_loss || 0) >= 0 ? 'var(--success-light)' : 'var(--danger-light)'};padding:12px;border-radius:10px;text-align:center">
                                <div style="font-size:0.75rem;color:var(--text-secondary)">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div>
                                <div style="font-size:1.1rem;font-weight:700;color:${(stock.profit_loss || 0) >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                    ${(stock.profit_loss || 0) >= 0 ? '+' : ''}${formatNumber(stock.profit_loss || 0)}
                                </div>
                            </div>
                        </div>

                        <!-- Quantity Calculator with Strategy Distribution -->
                        <div style="background:linear-gradient(135deg, #1e293b 0%, #334155 100%);border-radius:12px;padding:20px;margin-bottom:20px;color:white">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                                <h4 style="font-size:1rem;display:flex;align-items:center;gap:8px">
                                    <span>ğŸ§®</span> Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 15%)
                                </h4>
                                <div style="background:rgba(245,158,11,0.3);padding:8px 14px;border-radius:8px;border:1px solid rgba(245,158,11,0.5)">
                                    <span style="font-size:0.8rem;opacity:0.9">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ¯Ø§ÙˆÙ„:</span>
                                    <span style="font-weight:700;margin-right:6px">${maxTradeShares} Ø³Ù‡Ù…</span>
                                    <span style="font-size:0.75rem;opacity:0.7">(${formatNumber(maxTradeValue)} Ø±.Ø³)</span>
                                </div>
                            </div>

                            <!-- Strategy Distribution -->
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
                                <div style="background:rgba(34,197,94,0.2);padding:14px;border-radius:10px;border:1px solid rgba(34,197,94,0.4)">
                                    <div style="font-size:0.75rem;opacity:0.8;margin-bottom:4px">Ø§Ø³ØªØ«Ù…Ø§Ø± Ø£Ø³Ø§Ø³ÙŠ (50%)</div>
                                    <div style="font-size:1.3rem;font-weight:700">${coreShares} Ø³Ù‡Ù…</div>
                                    <div style="font-size:0.7rem;opacity:0.6;margin-top:2px">Ø«Ø§Ø¨Øª - Ù„Ø§ ÙŠÙØ¨Ø§Ø¹</div>
                                </div>
                                <div style="background:rgba(59,130,246,0.2);padding:14px;border-radius:10px;border:1px solid rgba(59,130,246,0.4)">
                                    <div style="font-size:0.75rem;opacity:0.8;margin-bottom:4px">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ù‰ (30%)</div>
                                    <div style="font-size:1.3rem;font-weight:700">${midShares} Ø³Ù‡Ù…</div>
                                    <div style="font-size:0.7rem;opacity:0.6;margin-top:2px">Ø¨ÙŠØ¹ Ø¬Ø²Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø§Øª</div>
                                </div>
                                <div style="background:rgba(245,158,11,0.2);padding:14px;border-radius:10px;border:1px solid rgba(245,158,11,0.4)">
                                    <div style="font-size:0.75rem;opacity:0.8;margin-bottom:4px">Ù…Ø¶Ø§Ø±Ø¨Ø© (20%)</div>
                                    <div style="font-size:1.3rem;font-weight:700">${specShares} Ø³Ù‡Ù…</div>
                                    <div style="font-size:0.7rem;opacity:0.6;margin-top:2px">ØªØ¯Ø§ÙˆÙ„ Ù†Ø´Ø·</div>
                                </div>
                            </div>

                            <!-- Quick Trade Suggestions -->
                            <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:14px">
                                <div style="font-size:0.85rem;margin-bottom:10px;opacity:0.9">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹:</div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                    <div style="background:rgba(34,197,94,0.15);padding:10px;border-radius:8px">
                                        <div style="font-size:0.75rem;color:#86efac;margin-bottom:4px">Ø´Ø±Ø§Ø¡/ØªØ¹Ø²ÙŠØ² (Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø¹Ù…)</div>
                                        ${tradingLevels.buy_levels && tradingLevels.buy_levels[0] ? `
                                            <div style="font-size:0.9rem;font-weight:600">
                                                ${Math.min(maxTradeShares, specShares)} Ø³Ù‡Ù… @ ${formatNumber(tradingLevels.buy_levels[0].price)}
                                            </div>
                                            <div style="font-size:0.7rem;opacity:0.7">ØªÙƒÙ„ÙØ©: ${formatNumber(Math.min(maxTradeShares, specShares) * tradingLevels.buy_levels[0].price)} Ø±.Ø³</div>
                                        ` : '<div style="font-size:0.8rem;opacity:0.6">Ø§Ù†ØªØ¸Ø± ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¯Ø¹Ù…</div>'}
                                    </div>
                                    <div style="background:rgba(239,68,68,0.15);padding:10px;border-radius:8px">
                                        <div style="font-size:0.75rem;color:#fca5a5;margin-bottom:4px">Ø¨ÙŠØ¹ Ø¬Ø²Ø¦ÙŠ (Ø¹Ù†Ø¯ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©)</div>
                                        ${tradingLevels.sell_levels && tradingLevels.sell_levels[0] ? `
                                            <div style="font-size:0.9rem;font-weight:600">
                                                ${Math.min(maxTradeShares, specShares)} Ø³Ù‡Ù… @ ${formatNumber(tradingLevels.sell_levels[0].price)}
                                            </div>
                                            <div style="font-size:0.7rem;opacity:0.7">Ø¹Ø§Ø¦Ø¯: ${formatNumber(Math.min(maxTradeShares, specShares) * tradingLevels.sell_levels[0].price)} Ø±.Ø³</div>
                                        ` : '<div style="font-size:0.8rem;opacity:0.6">Ø§Ù†ØªØ¸Ø± ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Two Column Layout: Price Action + Trading Levels -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
                            <!-- Price Action Box -->
                            <div style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;padding:16px;border:1px solid #bae6fd">
                                <h4 style="font-size:0.9rem;margin-bottom:12px;color:#0369a1;display:flex;align-items:center;gap:6px">
                                    <span>ğŸ¯</span> Ø§Ù„Ø¨Ø±Ø§ÙŠØ³ Ø£ÙƒØ´Ù†
                                </h4>
                                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
                                    <div style="text-align:center;background:white;padding:10px;border-radius:8px">
                                        <div style="font-size:0.7rem;color:var(--text-secondary)">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</div>
                                        <div style="font-size:1rem;font-weight:700;color:${priceAction.trend === 'bullish' ? 'var(--success)' : priceAction.trend === 'bearish' ? 'var(--danger)' : 'var(--warning)'}">
                                            ${priceAction.trend === 'bullish' ? 'â–² ØµØ§Ø¹Ø¯' : priceAction.trend === 'bearish' ? 'â–¼ Ù‡Ø§Ø¨Ø·' : 'â—† Ø¹Ø±Ø¶ÙŠ'}
                                        </div>
                                    </div>
                                    <div style="text-align:center;background:white;padding:10px;border-radius:8px">
                                        <div style="font-size:0.7rem;color:var(--text-secondary)">SMA 20</div>
                                        <div style="font-size:0.95rem;font-weight:600;color:${(stock.current_price || 0) > (priceAction.sma_20 || 0) ? 'var(--success)' : 'var(--danger)'}">${priceAction.sma_20 || '-'}</div>
                                    </div>
                                    <div style="text-align:center;background:white;padding:10px;border-radius:8px">
                                        <div style="font-size:0.7rem;color:var(--text-secondary)">SMA 50</div>
                                        <div style="font-size:0.95rem;font-weight:600;color:${(stock.current_price || 0) > (priceAction.sma_50 || 0) ? 'var(--success)' : 'var(--danger)'}">${priceAction.sma_50 || '-'}</div>
                                    </div>
                                </div>
                                ${(priceAction.patterns && priceAction.patterns.length > 0) ? `
                                    <div style="margin-bottom:8px">
                                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">Ø§Ù„Ø£Ù†Ù…Ø§Ø·:</div>
                                        <div style="display:flex;flex-wrap:wrap;gap:4px">
                                            ${priceAction.patterns.slice(0,3).map(p => `
                                                <span style="padding:3px 8px;border-radius:12px;font-size:0.7rem;
                                                    background:${p.type === 'bullish' ? 'var(--success-light)' : p.type === 'bearish' ? 'var(--danger-light)' : 'var(--warning-light)'};
                                                    color:${p.type === 'bullish' ? 'var(--success)' : p.type === 'bearish' ? 'var(--danger)' : 'var(--warning)'}">
                                                    ${p.name}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${(priceAction.signals && priceAction.signals.length > 0) ? `
                                    <div>
                                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:6px">Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª:</div>
                                        ${priceAction.signals.slice(0,2).map(s => `
                                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
                                                <span style="padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;
                                                    background:${s.signal === 'Ø´Ø±Ø§Ø¡' ? 'var(--success)' : s.signal === 'Ø¨ÙŠØ¹' ? 'var(--danger)' : 'var(--warning)'};
                                                    color:white">${s.signal}</span>
                                                <span style="font-size:0.7rem;color:var(--text-secondary)">${s.reason}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="font-size:0.8rem;color:var(--text-muted);text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>'}
                            </div>

                            <!-- Trading Levels Box -->
                            <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:16px;border:1px solid #fbbf24">
                                <h4 style="font-size:0.9rem;margin-bottom:12px;color:#92400e;display:flex;align-items:center;gap:6px">
                                    <span>ğŸ“Š</span> Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
                                </h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                                    <div>
                                        <div style="font-size:0.75rem;color:var(--success);font-weight:600;margin-bottom:6px">â–¼ Ø´Ø±Ø§Ø¡</div>
                                        ${(tradingLevels.buy_levels && tradingLevels.buy_levels.length > 0) ?
                                            tradingLevels.buy_levels.slice(0,3).map(level => `
                                                <div style="background:white;padding:6px 8px;border-radius:6px;margin-bottom:4px;border-right:3px solid var(--success)">
                                                    <div style="display:flex;justify-content:space-between;font-size:0.85rem">
                                                        <span style="font-weight:600;color:var(--success)">${formatNumber(level.price)}</span>
                                                        <span style="font-size:0.7rem;color:var(--text-secondary)">${level.percent_from_current.toFixed(1)}%</span>
                                                    </div>
                                                    <div style="font-size:0.65rem;color:var(--text-muted)">${level.source}</div>
                                                </div>
                                            `).join('') : '<div style="font-size:0.75rem;color:var(--text-muted);text-align:center;padding:8px">-</div>'
                                        }
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem;color:var(--danger);font-weight:600;margin-bottom:6px">â–² Ø¨ÙŠØ¹</div>
                                        ${(tradingLevels.sell_levels && tradingLevels.sell_levels.length > 0) ?
                                            tradingLevels.sell_levels.slice(0,3).map(level => `
                                                <div style="background:white;padding:6px 8px;border-radius:6px;margin-bottom:4px;border-right:3px solid var(--danger)">
                                                    <div style="display:flex;justify-content:space-between;font-size:0.85rem">
                                                        <span style="font-weight:600;color:var(--danger)">${formatNumber(level.price)}</span>
                                                        <span style="font-size:0.7rem;color:var(--text-secondary)">+${level.percent_from_current.toFixed(1)}%</span>
                                                    </div>
                                                    <div style="font-size:0.65rem;color:var(--text-muted)">${level.source}</div>
                                                </div>
                                            `).join('') : '<div style="font-size:0.75rem;color:var(--text-muted);text-align:center;padding:8px">-</div>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Technical Details -->
                        <details style="margin-bottom:10px">
                            <summary style="cursor:pointer;padding:12px;background:var(--bg-secondary);border-radius:10px;font-weight:600;font-size:0.9rem;list-style:none;display:flex;align-items:center;gap:8px">
                                <span style="transition:transform 0.2s">â–¶</span>
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠØ© (Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§ØªØŒ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ù„Ø¨ØŒ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©)
                            </summary>
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:0 0 10px 10px;margin-top:-5px">
                                <!-- Supply & Demand Zones -->
                                <div style="margin-bottom:16px">
                                    <h5 style="font-size:0.85rem;margin-bottom:10px;color:var(--text-primary)">Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ù„Ø¨</h5>
                                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                                        ${['daily', 'weekly', 'monthly'].map(timeframe => {
                                            const tfData = supplyDemand[timeframe] || {};
                                            const demand = tfData.demand || [];
                                            const supply = tfData.supply || [];
                                            const tfLabel = timeframe === 'daily' ? 'ÙŠÙˆÙ…ÙŠ' : timeframe === 'weekly' ? 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ' : 'Ø´Ù‡Ø±ÙŠ';
                                            return `
                                                <div style="background:white;padding:10px;border-radius:8px">
                                                    <div style="font-size:0.8rem;font-weight:600;margin-bottom:8px;text-align:center">${tfLabel}</div>
                                                    <div style="margin-bottom:6px">
                                                        <div style="font-size:0.7rem;color:var(--danger);margin-bottom:3px">Ø¹Ø±Ø¶ â–²</div>
                                                        ${supply.slice(0,2).map(z => `<div style="font-size:0.75rem;padding:2px 4px;background:var(--danger-light);border-radius:3px;margin-bottom:2px">${formatNumber(z.low)} - ${formatNumber(z.high)}</div>`).join('') || '<div style="font-size:0.7rem;color:var(--text-muted)">-</div>'}
                                                    </div>
                                                    <div>
                                                        <div style="font-size:0.7rem;color:var(--success);margin-bottom:3px">Ø·Ù„Ø¨ â–¼</div>
                                                        ${demand.slice(0,2).map(z => `<div style="font-size:0.75rem;padding:2px 4px;background:var(--success-light);border-radius:3px;margin-bottom:2px">${formatNumber(z.low)} - ${formatNumber(z.high)}</div>`).join('') || '<div style="font-size:0.7rem;color:var(--text-muted)">-</div>'}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>

                                <!-- Support & Resistance -->
                                <div style="margin-bottom:16px">
                                    <h5 style="font-size:0.85rem;margin-bottom:10px;color:var(--text-primary)">Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©</h5>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                        <div>
                                            <div style="font-size:0.75rem;color:var(--danger);margin-bottom:6px;font-weight:600">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø§Øª</div>
                                            ${(levels.resistance || []).slice(0,3).map((r, i) => `
                                                <div style="display:flex;justify-content:space-between;padding:6px 10px;background:var(--danger-light);border-radius:6px;margin-bottom:4px;font-size:0.85rem">
                                                    <span>R${i+1}</span><span style="font-weight:600">${formatNumber(r)}</span>
                                                </div>
                                            `).join('') || '<div style="color:var(--text-muted);font-size:0.8rem">-</div>'}
                                        </div>
                                        <div>
                                            <div style="font-size:0.75rem;color:var(--success);margin-bottom:6px;font-weight:600">Ø§Ù„Ø¯Ø¹ÙˆÙ…</div>
                                            ${(levels.support || []).slice(0,3).map((s, i) => `
                                                <div style="display:flex;justify-content:space-between;padding:6px 10px;background:var(--success-light);border-radius:6px;margin-bottom:4px;font-size:0.85rem">
                                                    <span>S${i+1}</span><span style="font-weight:600">${formatNumber(s)}</span>
                                                </div>
                                            `).join('') || '<div style="color:var(--text-muted);font-size:0.8rem">-</div>'}
                                    </div>
                                </div>
                            </div>

                                <!-- Moving Averages Table -->
                                <div>
                                    <h5 style="font-size:0.85rem;margin-bottom:10px;color:var(--text-primary)">Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©</h5>
                                    <div style="overflow-x:auto">
                                        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;background:white;border-radius:8px">
                                            <thead>
                                                <tr>
                                                    <th style="padding:8px;text-align:right;background:var(--bg-card)">Ø§Ù„ÙØªØ±Ø©</th>
                                                    <th style="padding:8px;text-align:center;background:var(--bg-card)">ÙŠÙˆÙ…ÙŠ SMA</th>
                                                    <th style="padding:8px;text-align:center;background:var(--bg-card)">ÙŠÙˆÙ…ÙŠ EMA</th>
                                                    <th style="padding:8px;text-align:center;background:var(--bg-card)">Ø£Ø³Ø¨ÙˆØ¹ÙŠ SMA</th>
                                                    <th style="padding:8px;text-align:center;background:var(--bg-card)">Ø£Ø³Ø¨ÙˆØ¹ÙŠ EMA</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${['10', '20', '50'].map(period => {
                                                    const daily = mas.daily || {};
                                                    const weekly = mas.weekly || {};
                                                    const currentPrice = stock.current_price || 0;
                                                    const getColor = (val) => !val ? 'var(--text-muted)' : currentPrice > val ? 'var(--success)' : 'var(--danger)';
                                                    return '<tr style="border-bottom:1px solid var(--border)">' +
                                                        '<td style="padding:8px;font-weight:600">MA ' + period + '</td>' +
                                                        '<td style="padding:8px;text-align:center;color:' + getColor(daily['sma_'+period]) + '">' + (daily['sma_'+period] ? formatNumber(daily['sma_'+period]) : '-') + '</td>' +
                                                        '<td style="padding:8px;text-align:center;color:' + getColor(daily['ema_'+period]) + '">' + (daily['ema_'+period] ? formatNumber(daily['ema_'+period]) : '-') + '</td>' +
                                                        '<td style="padding:8px;text-align:center;color:' + getColor(weekly['sma_'+period]) + '">' + (weekly['sma_'+period] ? formatNumber(weekly['sma_'+period]) : '-') + '</td>' +
                                                        '<td style="padding:8px;text-align:center;color:' + getColor(weekly['ema_'+period]) + '">' + (weekly['ema_'+period] ? formatNumber(weekly['ema_'+period]) : '-') + '</td>' +
                                                        '</tr>';
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top:6px;font-size:0.7rem;color:var(--text-secondary)">
                                        <span style="color:var(--success)">â— Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±</span> |
                                        <span style="color:var(--danger)">â— Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±</span>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
        function toggleTransactionsHistory() {
            const history = document.getElementById('transactionsHistory');
            const icon = document.getElementById('transactionsToggleIcon');
            if (history.style.display === 'none') {
                history.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                history.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }

        // ==================== Operations Management Functions ====================

        let allOperations = [];

        async function loadAllOperations() {
            const container = document.getElementById('operationsTableContainer');
            container.innerHTML = '<div class="empty-state" style="padding:40px"><h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</h3></div>';

            try {
                const [ordersResponse, walletsResponse] = await Promise.all([
                    fetch(`${API_BASE}/all-orders`),
                    fetch(`${API_BASE}/wallets`)
                ]);

                const ordersData = await ordersResponse.json();
                const walletsData = await walletsResponse.json();

                allOperations = ordersData.orders || [];
                const wallets = walletsData.wallets || [];

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const buyOrders = allOperations.filter(o => o.order_type === 'buy');
                const sellOrders = allOperations.filter(o => o.order_type === 'sell');
                const totalCommission = allOperations.reduce((sum, o) => sum + (o.commission || 0), 0);

                document.getElementById('totalBuyOrders').textContent = buyOrders.length;
                document.getElementById('totalSellOrders').textContent = sellOrders.length;
                document.getElementById('totalOrdersCommission').innerHTML = `${formatNumber(totalCommission)} <small>Ø±.Ø³</small>`;
                document.getElementById('totalOrdersCount').textContent = allOperations.length;

                // Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ„ØªØ±Ø©
                populateOperationsFilters(allOperations, wallets);

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                renderOperationsTable(allOperations, wallets);

            } catch (error) {
                console.error('Error loading operations:', error);
                container.innerHTML = '<div class="empty-state"><h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3></div>';
            }
        }

        function populateOperationsFilters(operations, wallets) {
            // ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸
            const walletSelect = document.getElementById('operationsFilterWallet');
            walletSelect.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸</option>';
            wallets.forEach(w => {
                walletSelect.innerHTML += `<option value="${w.wallet_id}">${w.name} - ${w.broker}</option>`;
            });

            // ÙÙ„ØªØ± Ø§Ù„Ø£Ø³Ù‡Ù… (ÙØ±ÙŠØ¯Ø©)
            const stockSelect = document.getElementById('operationsFilterStock');
            const uniqueStocks = [...new Set(operations.map(o => o.symbol))];
            stockSelect.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù‡Ù…</option>';
            uniqueStocks.forEach(symbol => {
                const stockName = operations.find(o => o.symbol === symbol)?.stock_name || symbol;
                stockSelect.innerHTML += `<option value="${symbol}">${stockName} (${symbol})</option>`;
            });
        }

        function filterOperations() {
            const typeFilter = document.getElementById('operationsFilterType').value;
            const walletFilter = document.getElementById('operationsFilterWallet').value;
            const stockFilter = document.getElementById('operationsFilterStock').value;

            let filtered = [...allOperations];

            if (typeFilter !== 'all') {
                filtered = filtered.filter(o => o.order_type === typeFilter);
            }
            if (walletFilter !== 'all') {
                filtered = filtered.filter(o => o.wallet_id === walletFilter);
            }
            if (stockFilter !== 'all') {
                filtered = filtered.filter(o => o.symbol === stockFilter);
            }

            renderOperationsTable(filtered, allWallets);
        }

        function renderOperationsTable(operations, wallets) {
            const container = document.getElementById('operationsTableContainer');

            if (operations.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding:60px"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</h3></div>';
                return;
            }

            const getWalletName = (walletId) => {
                const wallet = wallets.find(w => w.wallet_id === walletId);
                return wallet ? wallet.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            };

            container.innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:0.85rem">
                    <thead>
                        <tr style="background:var(--bg-secondary)">
                            <th style="padding:12px;text-align:right;font-weight:600">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th style="padding:12px;text-align:right;font-weight:600">Ø§Ù„Ø³Ù‡Ù…</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø§Ù„Ø³Ø¹Ø±</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                            <th style="padding:12px;text-align:right;font-weight:600">Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                            <th style="padding:12px;text-align:center;font-weight:600">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${operations.map(order => {
                            const totalValue = order.shares * order.price;
                            const isBuy = order.order_type === 'buy';

                            return `
                                <tr style="border-bottom:1px solid var(--border)">
                                    <td style="padding:12px">
                                        <div style="font-weight:600">${order.date}</div>
                                    </td>
                                    <td style="padding:12px">
                                        <div style="font-weight:600">${order.stock_name || order.symbol}</div>
                                        <div style="font-size:0.75rem;color:var(--text-secondary)">${order.symbol}</div>
                                    </td>
                                    <td style="padding:12px;text-align:center">
                                        <span style="padding:4px 12px;border-radius:8px;font-size:0.8rem;font-weight:600;
                                            background:${isBuy ? 'var(--success-light)' : 'var(--danger-light)'};
                                            color:${isBuy ? 'var(--success)' : 'var(--danger)'}">
                                            ${isBuy ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}
                                        </span>
                                    </td>
                                    <td style="padding:12px;text-align:center;font-weight:600">${order.shares}</td>
                                    <td style="padding:12px;text-align:center">${formatNumber(order.price)}</td>
                                    <td style="padding:12px;text-align:center;font-weight:600">${formatNumber(totalValue)}</td>
                                    <td style="padding:12px;text-align:center;color:var(--text-secondary)">${formatNumber(order.commission + order.tax)}</td>
                                    <td style="padding:12px">
                                        <span style="font-size:0.85rem">${getWalletName(order.wallet_id)}</span>
                                    </td>
                                    <td style="padding:12px;text-align:center">
                                        <button onclick="openEditOrderModal('${order.order_id}', '${order.symbol}')"
                                            class="btn btn-secondary" style="padding:6px 12px;font-size:0.75rem">
                                            ØªØ¹Ø¯ÙŠÙ„
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function openEditOrderModal(orderId, symbol) {
            const order = allOperations.find(o => o.order_id === orderId);
            if (!order) return;

            document.getElementById('editOrderId').value = orderId;
            document.getElementById('editOrderSymbol').value = symbol;
            document.getElementById('editOrderStockName').textContent = order.stock_name || symbol;
            document.getElementById('editOrderType').textContent = order.order_type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹';
            document.getElementById('editOrderType').style.color = order.order_type === 'buy' ? 'var(--success)' : 'var(--danger)';
            document.getElementById('editOrderShares').value = order.shares;
            document.getElementById('editOrderPrice').value = order.price;
            document.getElementById('editOrderDate').value = order.date;
            document.getElementById('editOrderCommission').value = order.commission;
            document.getElementById('editOrderTax').value = order.tax;

            // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸
            const walletSelect = document.getElementById('editOrderWallet');
            walletSelect.innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† Ù…Ø­ÙØ¸Ø© --</option>';
            allWallets.forEach(w => {
                walletSelect.innerHTML += `<option value="${w.wallet_id}" ${w.wallet_id === order.wallet_id ? 'selected' : ''}>${w.name} - ${w.broker}</option>`;
            });

            document.getElementById('editOrderModal').classList.add('active');
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.remove('active');
        }

        async function submitEditOrder(event) {
            event.preventDefault();

            const orderId = document.getElementById('editOrderId').value;
            const data = {
                shares: parseFloat(document.getElementById('editOrderShares').value),
                price: parseFloat(document.getElementById('editOrderPrice').value),
                date: document.getElementById('editOrderDate').value,
                wallet_id: document.getElementById('editOrderWallet').value || null,
                commission: parseFloat(document.getElementById('editOrderCommission').value) || 0,
                tax: parseFloat(document.getElementById('editOrderTax').value) || 0
            };

            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    closeEditOrderModal();
                    loadAllOperations();
                    loadPortfolio(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©
                } else {
                    alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteOrderFromEdit() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;

            const orderId = document.getElementById('editOrderId').value;
            const symbol = document.getElementById('editOrderSymbol').value;

            try {
                const response = await fetch(`${API_BASE}/stocks/${symbol}/orders/${orderId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    closeEditOrderModal();
                    loadAllOperations();
                    loadPortfolio();
                } else {
                    alert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }
    </script>
</body>
</html>
